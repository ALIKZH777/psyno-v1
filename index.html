<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <!-- ZOOM & SELECT FIX: Added user-scalable=no to prevent zooming -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ساینو - دستیار سلامت روان شما</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- کتابخانه‌های تقویم فارسی -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
            /* ZOOM & SELECT FIX: Disable text selection and copying */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        .page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f2f5;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 6rem; /* 4rem for nav + 2rem space */
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .page.active.flex-layout {
            display: flex;
            flex-direction: column;
            height: 100%; 
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 4rem; /* h-16 */
            transition: transform 0.3s ease-in-out;
        }
        
        .bottom-nav.hidden {
            transform: translateY(100%);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.visible {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .pdp-group {
            direction: ltr;
        }

        #loading-spinner {
            display: flex;
        }
        #loading-spinner .loader, #action-spinner .loader {
            width: 50px;
            height: 50px;
            display: grid;
            animation: s4 4s infinite;
        }
        #loading-spinner .loader::before,
        #loading-spinner .loader::after,
        #action-spinner .loader::before,
        #action-spinner .loader::after {
            content: "";
            grid-area: 1/1;
            border: 8px solid;
            border-radius: 50%;
            border-color: #14B8A6 #14B8A6 #0000 #0000;
            mix-blend-mode: darken;
            animation: s4 1s infinite linear;
        }
        #loading-spinner .loader::after,
        #action-spinner .loader::after {
            border-color: #0000 #0000 #3b82f6 #3b82f6;
            animation-direction: reverse;
        }
        @keyframes s4 {
            100% {
                transform: rotate(1turn);
            }
        }
        
        /* Star rating styles */
        .star-rating .star {
            cursor: pointer;
            color: #d1d5db; /* gray-300 */
            transition: color 0.2s;
        }
        .star-rating .star:hover,
        .star-rating .star.selected {
            color: #f59e0b; /* amber-500 */
        }

        /* Chat tick styles */
        .chat-ticks {
            display: inline-block;
            margin-left: 4px;
        }
    </style>
</head>
<body class="bg-white">

    <div id="loading-spinner" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="loader"></div>
    </div>

    <div id="modal-container" class="modal-backdrop"></div>

    <div id="auth-page" class="page hidden bg-gradient-to-br from-teal-400 to-blue-500">
        <div class="w-full h-full flex items-center justify-center">
            <div class="w-full max-w-md m-auto p-8">
                <div class="text-center mb-10">
                    <h1 class="text-5xl font-bold text-white">ساینو</h1>
                    <p class="text-white/80 mt-2">دستیار هوشمند سلامت روان شما</p>
                </div>
                
                <div id="login-form-container">
                    <form id="login-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-6">
                        <h2 class="text-2xl font-bold text-white text-center">ورود به حساب کاربری</h2>
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-white">ایمیل</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-white">رمز عبور</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">ورود</button>
                        
                        <!-- QUICK LOGIN FIX: Quick login button container -->
                        <div id="quick-login-container" class="hidden space-y-2 pt-2">
                             <div class="relative flex py-2 items-center">
                                <div class="flex-grow border-t border-white/50"></div>
                                <span class="flex-shrink mx-4 text-white/80 text-sm">یا</span>
                                <div class="flex-grow border-t border-white/50"></div>
                            </div>
                            <button type="button" id="quick-login-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition duration-300 shadow-md">ورود سریع</button>
                        </div>

                        <p class="text-center text-sm text-white">
                            حساب کاربری ندارید؟ <a href="#" id="show-signup" class="font-bold hover:underline">ثبت‌نام کنید</a>
                        </p>
                    </form>
                </div>

                <div id="signup-form-container" class="hidden">
                    <form id="signup-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-bold text-white text-center">ایجاد حساب جدید</h2>
                        <div>
                            <label for="signup-fullname" class="block text-sm font-medium text-white">نام و نام خانوادگی</label>
                            <input type="text" id="signup-fullname" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-white">ایمیل</label>
                            <input type="email" id="signup-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-white">رمز عبور</label>
                            <input type="password" id="signup-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-role" class="block text-sm font-medium text-white">نقش شما</label>
                            <select id="signup-role" class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 focus:ring-2 focus:ring-white">
                                <option value="client">مراجع</option>
                                <option value="therapist">روانشناس</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">ثبت‌نام</button>
                        <p class="text-center text-sm text-white">
                            قبلا ثبت‌نام کرده‌اید؟ <a href="#" id="show-login" class="font-bold hover:underline">وارد شوید</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <!-- Client Pages -->
        <div id="client-dashboard-page" class="page"></div>
        <div id="client-tests-page" class="page"></div>
        <div id="client-appointments-page" class="page"></div>
        <div id="client-profile-page" class="page"></div>
        
        <!-- New Training Page -->
        <div id="training-page" class="page flex-layout"></div>

        <!-- Therapist Pages -->
        <div id="therapist-dashboard-page" class="page"></div>
        <div id="therapist-clients-page" class="page"></div>
        <div id="therapist-schedule-page" class="page"></div>
        <div id="therapist-profile-page" class="page"></div>
        
        <!-- Shared Pages -->
        <div id="chat-page" class="page"></div>

        <!-- Admin Page -->
        <div id="admin-dashboard-page" class="page"></div>
        
        <div id="bottom-nav-bar" class="bottom-nav bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        </div>
    </div>

<script type="module">
    // =================================================================
    // CONFIGURATION
    // =================================================================
    const SUPABASE_URL = 'https://atrhsfozgnfhhbfxgsnu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cmhzZm96Z25maGhiZnhnc251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjQ3MTYsImV4cCI6MjA2NjQ0MDcxNn0.eGODASElOsWJZ_cXmumZZwdQlcBGahm89n2UCuUxWk8';
    const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // Replace with your actual key
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
    
    // =================================================================
    // INITIALIZATION
    // =================================================================
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
            // LOGIN FIX: Session persistence is now handled manually with quick login
            // to ensure user is logged out on app close as requested.
            persistSession: false, 
            autoRefreshToken: true,
            detectSessionInUrl: true,
        },
    });
    
    let currentUser = null;
    let userProfile = null;
    let aiFeaturesEnabled = true;
    let chatSubscription = null;
    let moodChartInstance = null;
    let clientMoodChartInstance = null;
    let lastPageId = 'client-dashboard-page';

    // =================================================================
    // UTILITY & HELPER FUNCTIONS
    // =================================================================
    
    const defaultAvatarSvg = (bgColor = 'bg-gray-200', iconColor = 'text-gray-500') => `
        <div class="w-full h-full flex items-center justify-center rounded-full ${bgColor}">
            <svg xmlns="http://www.w3.org/2000/svg" width="60%" height="60%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="${iconColor}"><circle cx="12" cy="8" r="4"/><path d="M12 12c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        </div>
    `;

    const renderAvatar = (containerEl, avatarUrl, options = {}) => {
        const { bgColor = 'bg-teal-100', iconColor = 'text-teal-600' } = options;
        if (avatarUrl) {
            containerEl.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full">`;
        } else {
            containerEl.innerHTML = defaultAvatarSvg(bgColor, iconColor);
        }
    };

    const showActionSpinner = () => {
        const spinner = document.createElement('div');
        spinner.id = 'action-spinner';
        spinner.className = 'fixed inset-0 bg-white/50 z-[4000] flex items-center justify-center backdrop-blur-sm';
        spinner.innerHTML = `<div class="loader"></div>`;
        document.body.appendChild(spinner);
    }
    const hideActionSpinner = () => {
        document.getElementById('action-spinner')?.remove();
    }

    const showModal = (title, content, actions = []) => {
        const modalContainer = document.getElementById('modal-container');
        const modalHTML = `
            <div class="modal-content">
                <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                <div class="text-gray-600">${content}</div>
                <div class="flex justify-end gap-2 mt-6">
                    ${actions.map(action => `<button class="${action.className}" onclick="${action.handler}">${action.text}</button>`).join('')}
                    <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" onclick="closeModal()">بستن</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = modalHTML;
        modalContainer.classList.add('visible');
    };

    const closeModal = () => {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.classList.remove('visible');
        modalContainer.innerHTML = '';
    };

    const showToast = (message, type = 'success') => {
        const toastColors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        const toast = document.createElement('div');
        toast.className = `fixed top-5 right-5 ${toastColors[type]} text-white py-2 px-4 rounded-lg shadow-lg z-[5000]`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    const navigateTo = (pageId) => {
        const activePage = document.querySelector('.page.active');
        const navBar = document.getElementById('bottom-nav-bar');

        if (activePage && activePage.id !== 'chat-page' && activePage.id !== 'training-page' && pageId !== activePage.id) {
            lastPageId = activePage.id;
        }

        document.querySelectorAll('.page').forEach(page => page.classList.remove('active', 'flex-layout'));
        const targetPage = document.getElementById(pageId);

        if (targetPage) {
            targetPage.classList.add('active');
            if (pageId === 'chat-page' || pageId === 'training-page') {
                targetPage.classList.add('flex-layout');
                navBar.classList.add('hidden');
            } else {
                navBar.classList.remove('hidden');
            }
            targetPage.scrollTop = 0;
        }
        
        const navId = `nav-${pageId.split('-')[1]}`;
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('text-teal-600');
            item.classList.add('text-gray-500');
        });
        const activeNavItem = document.getElementById(navId);
        if (activeNavItem) {
            activeNavItem.classList.remove('text-gray-500');
            activeNavItem.classList.add('text-teal-600');
        }
    };

    const renderStars = (rating, totalRatings = 0) => {
        const r = Math.round(rating * 2) / 2; // Round to nearest 0.5
        let starsHTML = '<div class="flex items-center gap-1">';
        for (let i = 1; i <= 5; i++) {
            if (r >= i) {
                starsHTML += '<i data-lucide="star" class="w-4 h-4 text-amber-400 fill-current"></i>';
            } else if (r === i - 0.5) {
                starsHTML += '<i data-lucide="star-half" class="w-4 h-4 text-amber-400 fill-current"></i>';
            } else {
                starsHTML += '<i data-lucide="star" class="w-4 h-4 text-gray-300"></i>';
            }
        }
        if (totalRatings > 0) {
            starsHTML += `<span class="text-xs text-gray-500 mr-1">(${totalRatings} نظر)</span>`;
        }
        starsHTML += '</div>';
        return starsHTML;
    };


    // =================================================================
    // AUTHENTICATION (REWORKED FOR QUICK LOGIN)
    // =================================================================

    const authPage = document.getElementById('auth-page');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const quickLoginContainer = document.getElementById('quick-login-container');
    const quickLoginBtn = document.getElementById('quick-login-btn');


    document.getElementById('show-signup').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('signup-form-container').classList.remove('hidden');
    });

    document.getElementById('show-login').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('signup-form-container').classList.add('hidden');
        document.getElementById('login-form-container').classList.remove('hidden');
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showActionSpinner();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { data, error } = await db.auth.signInWithPassword({ email, password });
        if (error) {
            hideActionSpinner();
            showToast(`خطا در ورود: ${error.message}`, 'error');
        } else {
            // QUICK LOGIN FIX: Save credentials on successful login
            try {
                localStorage.setItem('psyno_quick_email', email);
                localStorage.setItem('psyno_quick_password', password);
            } catch (e) {
                console.warn("Could not save quick login credentials.", e);
            }
        }
        // On success, onAuthStateChange will handle UI changes.
    });

    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showActionSpinner();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const fullName = document.getElementById('signup-fullname').value;
        const role = document.getElementById('signup-role').value;

        const { data, error } = await db.auth.signUp({
            email,
            password,
            options: {
                data: {
                    full_name: fullName,
                    role: role 
                }
            }
        });
        
        hideActionSpinner();
        if (error) {
            showToast(`خطا در ثبت‌نام: ${error.message}`, 'error');
        } else {
            if (data.user && data.user.identities && data.user.identities.length === 0) {
                 showToast('این کاربر از قبل وجود دارد. لطفاً وارد شوید.', 'error');
            } else {
                 showToast('ثبت‌نام موفقیت‌آمیز بود. لطفاً ایمیل خود را برای تایید بررسی کنید.', 'info');
            }
        }
    });

    const handleLogout = async () => {
        document.getElementById('loading-spinner').style.display = 'flex';
        appContainer.classList.add('hidden');
        const { error } = await db.auth.signOut();
        if (error) {
            showToast(`خطا در خروج: ${error.message}`, 'error');
        }
        // onAuthStateChange will handle showing the login page.
    };
    
    // QUICK LOGIN FIX: Function to handle quick login
    const handleQuickLogin = async () => {
        const email = localStorage.getItem('psyno_quick_email');
        const password = localStorage.getItem('psyno_quick_password');

        if (!email || !password) {
            showToast('اطلاعات ورود سریع یافت نشد. لطفاً یکبار به صورت عادی وارد شوید.', 'error');
            return;
        }

        showActionSpinner();
        const { error } = await db.auth.signInWithPassword({ email, password });
        if (error) {
            hideActionSpinner();
            showToast(`خطا در ورود سریع: ${error.message}`, 'error');
        }
    };
    
    quickLoginBtn.addEventListener('click', handleQuickLogin);
    
    // QUICK LOGIN FIX: Check for saved credentials on page load
    const checkForQuickLogin = () => {
        try {
            const savedEmail = localStorage.getItem('psyno_quick_email');
            if (savedEmail) {
                quickLoginContainer.classList.remove('hidden');
            } else {
                quickLoginContainer.classList.add('hidden');
            }
        } catch (e) {
            console.warn("Could not check for quick login credentials.", e);
            quickLoginContainer.classList.add('hidden');
        }
    };


    // =================================================================
    // APP INITIALIZATION & ROUTING
    // =================================================================

    db.auth.onAuthStateChange(async (event, session) => {
        const loadingSpinner = document.getElementById('loading-spinner');
        try {
            if (session && session.user) {
                currentUser = session.user;
                const { data, error } = await db.from('profiles').select('*').eq('id', currentUser.id).single();

                if (error || !data) {
                    console.error("Critical: Profile fetch failed.", error);
                    await db.auth.signOut();
                    return;
                }

                userProfile = data;
                await setupUIForRole(userProfile.role);
                appContainer.classList.remove('hidden');
                authPage.classList.add('hidden');

            } else {
                currentUser = null;
                userProfile = null;
                if (chatSubscription) {
                    chatSubscription.unsubscribe();
                    chatSubscription = null;
                }
                appContainer.classList.add('hidden');
                authPage.classList.remove('hidden');
                authPage.classList.add('active');
                // QUICK LOGIN FIX: Check for credentials when user is logged out
                checkForQuickLogin();
            }
        } catch (err) {
            console.error("Fatal error in onAuthStateChange:", err);
            showToast('یک خطای پیش‌بینی نشده رخ داد.', 'error');
            appContainer.classList.add('hidden');
            authPage.classList.remove('hidden');
            authPage.classList.add('active');
        } finally {
            loadingSpinner.style.display = 'none';
            hideActionSpinner();
        }
    });


    const setupUIForRole = async (role) => {
        const navBar = document.getElementById('bottom-nav-bar');
        navBar.innerHTML = '';

        if (!['client', 'therapist', 'admin'].includes(role)) {
            showToast(`نقش کاربری "${role || 'نامشخص'}" تعریف نشده است.`, 'error');
            console.error(`Invalid role detected: ${role}`);
            handleLogout();
            return;
        }

        if (role === 'client') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-dashboard-page')">
                        <i data-lucide="home"></i><span class="text-xs">خانه</span>
                    </a>
                    <a href="#" id="nav-tests" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-tests-page')">
                        <i data-lucide="file-text"></i><span class="text-xs">تست‌ها</span>
                    </a>
                    <a href="#" id="nav-training" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateToTraining()">
                        <i data-lucide="video"></i><span class="text-xs">آموزش</span>
                    </a>
                    <a href="#" id="nav-appointments" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-appointments-page')">
                        <i data-lucide="calendar-days"></i><span class="text-xs">نوبت‌ها</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-profile-page')">
                        <i data-lucide="user"></i><span class="text-xs">پروفایل</span>
                    </a>
                </div>
            `;
            await renderClientDashboard();
            await renderClientTests();
            await renderClientAppointments();
            await renderClientProfile();
            navigateTo('client-dashboard-page');
        } else if (role === 'therapist') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-dashboard-page')">
                        <i data-lucide="layout-dashboard"></i><span class="text-xs">داشبورد</span>
                    </a>
                    <a href="#" id="nav-clients" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-clients-page')">
                        <i data-lucide="users"></i><span class="text-xs">مراجعین</span>
                    </a>
                    <a href="#" id="nav-schedule" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-schedule-page')">
                        <i data-lucide="calendar-clock"></i><span class="text-xs">برنامه</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-profile-page')">
                        <i data-lucide="user-cog"></i><span class="text-xs">پروفایل</span>
                    </a>
                </div>
            `;
            await renderTherapistDashboard();
            await renderTherapistClients();
            await renderTherapistSchedule();
            await renderTherapistProfile();
            navigateTo('therapist-dashboard-page');
        } else if (role === 'admin') {
            navBar.innerHTML = `<div class="text-center p-4 bg-gray-800 text-white">پنل مدیریت</div>`;
            await renderAdminDashboard();
            navigateTo('admin-dashboard-page');
        }
        lucide.createIcons();
    };

    // =================================================================
    // TRAINING SECTION (IMPROVED LOADING)
    // =================================================================
    const navigateToTraining = () => {
        const page = document.getElementById('training-page');
        const navBar = document.getElementById('bottom-nav-bar');
        const activePage = document.querySelector('.page.active');
        
        if (activePage && activePage.id !== 'training-page') {
            lastPageId = activePage.id;
        }

        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

        page.innerHTML = `
            <header class="bg-white shadow-sm p-4 flex items-center gap-4 flex-shrink-0">
                <button onclick="goBackFromTraining()" class="text-gray-600"><i data-lucide="arrow-right"></i></button>
                <h1 class="font-bold text-lg">بخش آموزش</h1>
            </header>
            <div id="training-content-area" class="flex-grow relative bg-gray-100 flex items-center justify-center p-4">
                <div id="training-loader" class="flex flex-col items-center justify-center text-center">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-600">در حال بارگذاری بخش آموزش...</p>
                </div>
                <iframe id="training-iframe" class="w-full h-full border-0" style="display: none;"></iframe>
            </div>
        `;
        lucide.createIcons();
        page.classList.add('active', 'flex-layout');
        page.style.padding = '0';
        navBar.classList.add('hidden');
        
        const iframe = document.getElementById('training-iframe');
        const loader = document.getElementById('training-loader');
        const contentArea = document.getElementById('training-content-area');

        const showErrorState = () => {
            contentArea.innerHTML = `
                <div class="text-center text-gray-700 animate-fadeIn">
                    <i data-lucide="cloud-off" class="w-16 h-16 mx-auto text-red-400"></i>
                    <h2 class="mt-4 text-xl font-bold">خطا در بارگذاری</h2>
                    <p class="mt-2 text-gray-500">متاسفانه نتوانستیم به بخش آموزش متصل شویم. لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.</p>
                    <button onclick="navigateToTraining()" class="mt-6 bg-teal-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-teal-600 transition-all duration-300 flex items-center gap-2 mx-auto">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        <span>تلاش مجدد</span>
                    </button>
                </div>
            `;
            lucide.createIcons();
        };

        const loadingTimeout = setTimeout(showErrorState, 15000); // 15-second timeout

        iframe.onload = () => {
            clearTimeout(loadingTimeout);
            loader.style.display = 'none';
            iframe.style.display = 'block';
        };

        iframe.onerror = () => {
            clearTimeout(loadingTimeout);
            showErrorState();
        };
        
        iframe.src = "https://vids.psynoland.ir/";
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('text-teal-600');
            item.classList.add('text-gray-500');
        });
    };

    const goBackFromTraining = () => {
        const page = document.getElementById('training-page');
        page.classList.remove('active', 'flex-layout');
        page.innerHTML = ''; // Clear content to stop iframe
        page.style.padding = '';

        document.getElementById('bottom-nav-bar').classList.remove('hidden');
        navigateTo(lastPageId);
    };


    // =================================================================
    // AI HELPER
    // =================================================================
    const getAiSuggestion = async (prompt) => {
        if (!aiFeaturesEnabled) {
            return "قابلیت هوش مصنوعی در حال حاضر غیرفعال است.";
        }
        if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
            return "کلید API برای سرویس هوش مصنوعی تنظیم نشده است. لطفاً با مدیر سیستم تماس بگیرید.";
        }
        try {
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => null);
                const errorMessage = errorBody?.error?.message || `API request failed with status ${response.status}`;
                throw new Error(errorMessage);
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error("Gemini API Error:", error);
            if (error instanceof TypeError && error.message === 'Failed to fetch') {
                return "خطا در برقراری ارتباط با سرور هوش مصنوعی. لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.";
            }
            return `متاسفانه در ارتباط با دستیار هوشمند مشکلی پیش آمده: ${error.message}`;
        }
    };
    
    // =================================================================
    // CLIENT-SIDE RENDERING & LOGIC
    // =================================================================

    // --- CLIENT: DASHBOARD ---
    const renderClientDashboard = async () => {
        const page = document.getElementById('client-dashboard-page');
        
        const { data: lastAppointment, error: lastAptError } = await db
            .from('appointments')
            .select('status, therapist:therapist_id ( id, full_name, avatar_url )')
            .eq('client_id', currentUser.id)
            .eq('status', 'confirmed')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        let therapistCardHTML = '';
        if (lastAppointment && lastAppointment.therapist) {
            therapistCardHTML = `
            <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden" id="dashboard-therapist-avatar"></div>
                    <div>
                        <p class="text-sm text-gray-500">روانشناس شما</p>
                        <p class="font-bold text-lg">${lastAppointment.therapist.full_name}</p>
                    </div>
                </div>
                <button onclick="startChatWith('${lastAppointment.therapist.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                    <i data-lucide="message-circle"></i>
                    <span>چت</span>
                </button>
            </div>
            `;
        } else {
             therapistCardHTML = `
            <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                 <p class="font-semibold mb-2">در حال حاضر جلسه فعالی ندارید.</p>
                 <p class="text-sm text-gray-600 mb-4">برای شروع گفتگو، ابتدا یک نوبت رزرو کنید.</p>
                 <button onclick="navigateTo('client-appointments-page')" class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold">رزرو نوبت</button>
            </div>
            `;
        }

        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">سلام، ${userProfile.full_name.split(' ')[0]}!</h1>
                        <p class="text-gray-500">حالت امروز چطوره؟</p>
                    </div>
                    <button onclick="navigateTo('client-profile-page')" id="dashboard-profile-avatar" class="w-14 h-14 rounded-full overflow-hidden"></button>
                </div>

                ${therapistCardHTML}

                <div id="health-score-card" class="bg-white p-4 rounded-2xl shadow-md text-center">
                    <p class="text-gray-500">در حال محاسبه نمره سلامت روان شما...</p>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">ثبت حال امروز</h2>
                    <div class="flex justify-around items-center">
                        ${[
                            { emoji: '😔', score: 1, label: 'خیلی بد' },
                            { emoji: '😟', score: 2, label: 'بد' },
                            { emoji: '😐', score: 3, label: 'معمولی' },
                            { emoji: '😊', score: 4, label: 'خوب' },
                            { emoji: '😄', score: 5, label: 'عالی' }
                        ].map(mood => `
                            <button onclick="submitMood(${mood.score})" class="flex flex-col items-center space-y-1 text-gray-600 hover:text-teal-600 transition">
                                <span class="text-4xl">${mood.emoji}</span>
                                <span class="text-xs">${mood.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">نمودار وضعیت روحی هفته</h2>
                    <div class="relative h-64">
                        <canvas id="moodChart"></canvas>
                    </div>
                </div>
                
                <div id="ai-helper-card" class="bg-gradient-to-r from-blue-500 to-cyan-400 p-4 rounded-2xl shadow-lg text-white">
                    <h2 class="font-bold text-lg mb-2">دستیار هوشمند ساینو</h2>
                    <p class="text-sm mb-4">نیاز به صحبت داری؟ دستیار هوشمند ما همیشه آماده کمک به توست.</p>
                    <button onclick="openAiChat()" class="bg-white/30 w-full py-2 rounded-lg font-semibold hover:bg-white/50 transition">شروع گفتگو</button>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-2">یادداشت‌های روزانه</h2>
                    <p class="text-sm text-gray-500 mb-3">افکارت رو اینجا بنویس. این یک فضای کاملا شخصیه.</p>
                    <textarea id="journal-input" class="w-full h-24 p-2 border rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="امروز چه گذشت..."></textarea>
                    <button onclick="submitJournal()" class="mt-2 w-full bg-teal-500 text-white py-2 rounded-lg font-semibold hover:bg-teal-600 transition">ذخیره یادداشت</button>
                    
                    <div id="journal-history-title" class="font-bold text-lg mb-2 mt-6">یادداشت‌های اخیر</div>
                    <div id="journal-history" class="space-y-3"></div>
                </div>
            </div>
        `;
        
        renderAvatar(document.getElementById('dashboard-profile-avatar'), userProfile.avatar_url);
        if (lastAppointment && lastAppointment.therapist) {
            renderAvatar(document.getElementById('dashboard-therapist-avatar'), lastAppointment.therapist.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
        }

        await calculateAndDisplayHealthScore();
        await loadMoodChart();
        await loadJournalEntries();
        lucide.createIcons();
        
        await checkForPendingReviews();
    };
    
    const calculateAndDisplayHealthScore = async () => {
        const scoreCard = document.getElementById('health-score-card');
        if (!scoreCard) return;

        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', thirtyDaysAgo);

        if (error || !data || data.length === 0) {
            scoreCard.innerHTML = `
                <h2 class="font-bold text-lg mb-1">نمره سلامت روان</h2>
                <p class="text-gray-500 text-sm">برای محاسبه، لطفاً وضعیت روحی خود را ثبت کنید.</p>
            `;
            return;
        }

        const totalScore = data.reduce((acc, entry) => acc + entry.mood_score, 0);
        const averageScore = totalScore / data.length;
        const healthScore = Math.round((averageScore / 5) * 100);

        let scoreDescription = '';
        let scoreColor = '';
        if (healthScore >= 80) {
            scoreDescription = 'عالی! به نظر می‌رسد روزهای خوبی را سپری می‌کنید.';
            scoreColor = 'text-green-500';
        } else if (healthScore >= 60) {
            scoreDescription = 'خوب. وضعیت پایداری دارید.';
            scoreColor = 'text-teal-500';
        } else if (healthScore >= 40) {
            scoreDescription = 'متوسط. مراقب خود باشید و به احساستان توجه کنید.';
            scoreColor = 'text-yellow-500';
        } else {
            scoreDescription = 'نیاز به توجه. صحبت با یک متخصص می‌تواند مفید باشد.';
            scoreColor = 'text-red-500';
        }

        scoreCard.innerHTML = `
            <h2 class="font-bold text-lg mb-2">نمره سلامت روان (۳۰ روز اخیر)</h2>
            <p class="text-5xl font-bold ${scoreColor}">${healthScore}<span class="text-2xl text-gray-400">/۱۰۰</span></p>
            <p class="text-gray-600 mt-2 text-sm">${scoreDescription}</p>
        `;
    };

    const submitMood = async (score) => {
        showActionSpinner();
        const { error } = await db.from('mood_entries').insert({ user_id: currentUser.id, mood_score: score });
        hideActionSpinner();
        if (error) {
            showToast('امروز قبلا حال خود را ثبت کرده‌اید.', 'error');
        } else {
            showToast('حال شما با موفقیت ثبت شد!', 'success');
            await loadMoodChart();
            await calculateAndDisplayHealthScore();
        }
    };

    const loadMoodChart = async () => {
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('created_at, mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', sevenDaysAgo)
            .order('created_at', { ascending: true });

        if (error) {
            console.error("Eror loading mood data:", error);
            return;
        }

        const labels = data.map(d => new persianDate(new Date(d.created_at)).format('dddd'));
        const scores = data.map(d => d.mood_score);

        const canvasEl = document.getElementById('moodChart');
        if (!canvasEl) return;
        const ctx = canvasEl.getContext('2d');
        
        if (moodChartInstance) {
            moodChartInstance.destroy();
        }

        moodChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'وضعیت روحی',
                    data: scores,
                    fill: true,
                    backgroundColor: 'rgba(20, 184, 166, 0.2)',
                    borderColor: 'rgb(20, 184, 166)',
                    pointBackgroundColor: 'rgb(20, 184, 166)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(20, 184, 166)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: { line: { borderWidth: 3 } },
                scales: {
                    r: {
                        angleLines: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        pointLabels: { font: { family: "'Vazirmatn', sans-serif", size: 12 } },
                        ticks: { stepSize: 1, display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    // --- Journal Functions ---
    const submitJournal = async () => {
        const content = document.getElementById('journal-input').value;
        if (!content.trim()) {
            showToast('لطفاً متنی را وارد کنید.', 'error');
            return;
        }
        showActionSpinner();
        const { error } = await db.from('journal_entries').insert({ user_id: currentUser.id, content: content });
        hideActionSpinner();
        if (error) {
            showToast('خطا در ذخیره یادداشت.', 'error');
        } else {
            showToast('یادداشت شما با موفقیت ذخیره شد.', 'success');
            document.getElementById('journal-input').value = '';
            await loadJournalEntries(); // Refresh the list
        }
    };

    const loadJournalEntries = async () => {
        const historyContainer = document.getElementById('journal-history');
        if (!historyContainer) return;

        historyContainer.innerHTML = '<p class="text-center text-gray-500">در حال بارگذاری یادداشت‌ها...</p>';

        const { data, error } = await db
            .from('journal_entries')
            .select('id, content, created_at')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(10);

        if (error) {
            console.error('Error loading journal entries:', error);
            historyContainer.innerHTML = '<p class="text-red-500 text-center">خطا در بارگذاری یادداشت‌ها.</p>';
            return;
        }

        if (data.length === 0) {
            historyContainer.innerHTML = '<p class="text-center text-gray-500">هنوز یادداشتی ثبت نکرده‌اید.</p>';
            return;
        }

        historyContainer.innerHTML = data.map(entry => `
            <div class="bg-gray-50 p-3 rounded-lg border" id="journal-entry-${entry.id}">
                <p class="text-xs text-gray-500 mb-2">${new persianDate(new Date(entry.created_at)).format('dddd D MMMM HH:mm')}</p>
                <p class="text-gray-700 whitespace-pre-wrap">${entry.content}</p>
                <div class="flex justify-end gap-2 mt-2">
                    <button onclick="editJournalEntry(${entry.id})" class="p-1 text-blue-600 hover:text-blue-800"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="confirmDeleteJournalEntry(${entry.id})" class="p-1 text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
        `).join('');
        lucide.createIcons();
    };

    const editJournalEntry = async (entryId) => {
        const { data: entry, error } = await db.from('journal_entries').select('content').eq('id', entryId).single();
        if (error || !entry) {
            showToast('خطا در یافتن یادداشت.', 'error');
            return;
        }

        const contentHTML = `<textarea id="edit-journal-textarea" class="w-full h-48 p-2 border rounded-lg">${entry.content}</textarea>`;
        const actions = [{
            text: 'ذخیره تغییرات',
            className: 'px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600',
            handler: `updateJournalEntry(${entryId})`
        }];

        showModal('ویرایش یادداشت', contentHTML, actions);
    };

    const updateJournalEntry = async (entryId) => {
        const newContent = document.getElementById('edit-journal-textarea').value;
        if (!newContent.trim()) {
            showToast('یادداشت نمی‌تواند خالی باشد.', 'error');
            return;
        }
        closeModal();
        showActionSpinner();
        const { error } = await db.from('journal_entries').update({ content: newContent }).eq('id', entryId);
        hideActionSpinner();
        if (error) {
            showToast('خطا در به‌روزرسانی یادداشت.', 'error');
        } else {
            showToast('یادداشت با موفقیت به‌روزرسانی شد.', 'success');
            await loadJournalEntries();
        }
    };

    const confirmDeleteJournalEntry = (entryId) => {
        const content = 'آیا از حذف این یادداشت مطمئن هستید؟ این عمل غیرقابل بازگشت است.';
        const actions = [{
            text: 'حذف کن',
            className: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700',
            handler: `deleteJournalEntry(${entryId})`
        }];
        showModal('تایید حذف', content, actions);
    };

    const deleteJournalEntry = async (entryId) => {
        closeModal();
        showActionSpinner();
        const { error } = await db.from('journal_entries').delete().eq('id', entryId);
        hideActionSpinner();
        if (error) {
            showToast('خطا در حذف یادداشت.', 'error');
        } else {
            showToast('یادداشت حذف شد.', 'success');
            const entryElement = document.getElementById(`journal-entry-${entryId}`);
            if(entryElement) {
                entryElement.style.transition = 'opacity 0.5s, transform 0.5s';
                entryElement.style.opacity = '0';
                entryElement.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    entryElement.remove();
                    // Check if the list is empty now
                    const historyContainer = document.getElementById('journal-history');
                    if (!historyContainer.hasChildNodes()) {
                         historyContainer.innerHTML = '<p class="text-center text-gray-500">هنوز یادداشتی ثبت نکرده‌اید.</p>';
                    }
                }, 500);
            }
        }
    };
    
    const openAiChat = () => {
        const content = `
            <div id="ai-chat-history" class="h-64 overflow-y-auto p-2 bg-gray-100 rounded-lg mb-3 border">
                <div class="text-gray-500 text-center p-4">سلام! من دستیار هوشمند ساینو هستم. چطور میتونم کمکت کنم؟</div>
            </div>
            <div class="flex gap-2">
                <input id="ai-chat-input" type="text" class="flex-grow p-2 border rounded-lg" placeholder="پیامت رو بنویس...">
                <button onclick="sendAiChatMessage()" class="p-2 bg-teal-500 text-white rounded-lg"><i data-lucide="send"></i></button>
            </div>
        `;
        showModal('گفتگو با دستیار هوشمند', content);
        lucide.createIcons();
    };

    const sendAiChatMessage = async () => {
        const input = document.getElementById('ai-chat-input');
        const history = document.getElementById('ai-chat-history');
        const userMessage = input.value.trim();
        if (!userMessage) return;

        history.innerHTML += `<div class="text-left my-1"><span class="bg-blue-500 text-white p-2 rounded-lg inline-block">${userMessage}</span></div>`;
        input.value = '';
        history.scrollTop = history.scrollHeight;
        
        const thinking = document.createElement('div');
        thinking.className = "text-right my-1";
        thinking.innerHTML = `<span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">...در حال فکر کردن</span>`;
        history.appendChild(thinking);
        history.scrollTop = history.scrollHeight;

        const aiResponse = await getAiSuggestion(userMessage);
        
        thinking.remove();
        history.innerHTML += `<div class="text-right my-1"><span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">${aiResponse}</span></div>`;
        history.scrollTop = history.scrollHeight;
    };

    // --- CLIENT: TESTS ---
    const psychologicalTests = [
        { id: 'phq9', name: 'تست افسردگی (PHQ-9)', questions: [
            "عدم علاقه یا لذت در انجام کارها", "احساس ناراحتی، افسردگی یا ناامیدی", "مشکل در به خواب رفتن، در خواب ماندن یا خواب زیاد", "احساس خستگی یا کمبود انرژی", "کم اشتهایی یا پرخوری", "احساس بدی نسبت به خود، یا اینکه یک شکست خورده هستید", "مشکل در تمرکز کردن روی کارها", "کند شدن در حرکت یا صحبت کردن، یا برعکس بی‌قراری", "افکار مربوط به اینکه بهتر است بمیرید یا به خود آسیب بزنید"
        ], options: ["اصلا", "چندین روز", "بیش از نیمی از روزها", "تقریبا هر روز"], interpretation: (score) => {
            if (score <= 4) return "علائم افسردگی حداقلی یا عدم وجود آن. وضعیت شما خوب است.";
            if (score <= 9) return "افسردگی خفیف. ممکن است نیاز به پیگیری داشته باشید.";
            if (score <= 14) return "افسردگی متوسط. مشورت با یک متخصص توصیه می‌شود.";
            if (score <= 19) return "افسردگی نسبتا شدید. حتما با یک متخصص صحبت کنید.";
            return "افسردگی شدید. لطفاً فوراً برای دریافت کمک حرفه‌ای اقدام کنید.";
        }},
        { id: 'gad7', name: 'تست اضطراب (GAD-7)', questions: [
            "احساس عصبانیت، اضطراب یا دلشوره", "عدم توانایی در متوقف کردن یا کنترل نگرانی", "نگرانی بیش از حد در مورد چیزهای مختلف", "مشکل در آرام شدن", "آنقدر بی‌قرار بودن که نشستن سخت است", "زودرنج یا تحریک‌پذیر شدن", "احساس ترس، انگار که اتفاق وحشتناکی قرار است بیفتد"
        ], options: ["اصلا", "چندین روز", "بیش از نیمی از روزها", "تقریبا هر روز"], interpretation: (score) => {
            if (score <= 4) return "اضطراب حداقلی. وضعیت شما طبیعی است.";
            if (score <= 9) return "اضطراب خفیف. مراقبت از خود را فراموش نکنید.";
            if (score <= 14) return "اضطراب متوسط. مشورت با یک متخصص می‌تواند مفید باشد.";
            return "اضطراب شدید. توصیه می‌شود برای ارزیابی و درمان به متخصص مراجعه کنید.";
        }}
    ];

    const renderClientTests = async () => {
        const page = document.getElementById('client-tests-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">تست‌های روانشناسی</h1>
                <div id="test-list" class="space-y-4">
                    ${psychologicalTests.map(test => `
                        <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-lg">${test.name}</h2>
                                <p class="text-sm text-gray-500">${test.questions.length} سوال</p>
                            </div>
                            <button onclick="startTest('${test.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold">شروع</button>
                        </div>
                    `).join('')}
                </div>
                <div id="test-container" class="hidden mt-6 bg-white p-4 rounded-2xl shadow-md"></div>
            </div>
        `;
        lucide.createIcons();
    };

    const startTest = (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        const testContainer = document.getElementById('test-container');
        document.getElementById('test-list').classList.add('hidden');
        testContainer.classList.remove('hidden');
        
        let questionsHTML = `<h2 class="text-xl font-bold mb-4">${test.name}</h2>`;
        test.questions.forEach((q, index) => {
            questionsHTML += `
                <div class="mb-6">
                    <p class="font-semibold mb-2">${index + 1}. ${q}</p>
                    <div class="flex flex-wrap gap-2">
                        ${test.options.map((opt, optIndex) => `
                            <label class="flex items-center space-x-2 space-x-reverse border p-2 rounded-lg cursor-pointer">
                                <input type="radio" name="q${index}" value="${optIndex}" class="form-radio text-teal-500">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        questionsHTML += `<button onclick="submitTest('${testId}')" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">مشاهده نتیجه</button>`;
        testContainer.innerHTML = questionsHTML;
    };

    const resetTestsPage = () => {
        document.getElementById('test-list').classList.remove('hidden');
        const testContainer = document.getElementById('test-container');
        testContainer.classList.add('hidden');
        testContainer.innerHTML = '';
    };

    const submitTest = async (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        let score = 0;
        let answeredAll = true;
        for (let i = 0; i < test.questions.length; i++) {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if (selected) {
                score += parseInt(selected.value);
            } else {
                answeredAll = false;
                break;
            }
        }

        if (!answeredAll) {
            showToast('لطفاً به تمام سوالات پاسخ دهید.', 'error');
            return;
        }

        const resultText = test.interpretation(score);
        showActionSpinner();
        const { error } = await db.from('test_results').insert({
            user_id: currentUser.id,
            test_name: test.name,
            score: score,
            result_text: resultText
        });
        hideActionSpinner();
        if(error){
            showToast('خطا در ذخیره نتیجه تست.', 'error');
        } else {
            showToast('نتیجه تست ذخیره شد.', 'success');
        }

        const testContainer = document.getElementById('test-container');
        testContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-4">نتیجه تست ${test.name}</h2>
            <p class="text-gray-700 mb-2">امتیاز شما: <span class="font-bold">${score}</span></p>
            <p class="text-gray-800 bg-gray-100 p-3 rounded-lg">${resultText}</p>
            <button onclick="resetTestsPage()" class="mt-4 w-full bg-gray-500 text-white py-2 rounded-lg">بازگشت به لیست تست‌ها</button>
        `;
    };

    // --- CLIENT: APPOINTMENTS ---
    const renderClientAppointments = async () => {
        const page = document.getElementById('client-appointments-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">نوبت‌های من</h1>
                <div id="appointments-list" class="space-y-4">
                    <p class="text-center text-gray-500">در حال بارگذاری نوبت‌ها...</p>
                </div>
                <div class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">رزرو نوبت جدید</h2>
                    <div id="therapist-list-container" class="space-y-4">
                        <p class="text-center text-gray-500">در حال بارگذاری لیست روانشناسان...</p>
                    </div>
                </div>
            </div>
        `;
        showActionSpinner();
        await loadClientAppointments();
        await renderTherapistListForBooking();
        hideActionSpinner();
        lucide.createIcons();
    };
    
    const loadClientAppointments = async () => {
        const listEl = document.getElementById('appointments-list');
        const { data, error } = await db
            .from('appointments')
            .select(`
                id,
                status,
                type,
                therapist:therapist_id ( id, full_name, avatar_url ),
                slot:slot_id ( id, start_time )
            `)
            .eq('client_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Error loading appointments:", error);
            listEl.innerHTML = `<p class="text-red-500">خطا در بارگذاری نوبت‌ها. لطفاً دوباره امتحان کنید.</p>`;
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">شما هیچ نوبت رزرو شده‌ای ندارید.</p>`;
            return;
        }
        
        const statusMap = {
            pending: { text: 'در انتظار تایید', color: 'bg-yellow-100 text-yellow-800' },
            confirmed: { text: 'تایید شده', color: 'bg-blue-100 text-blue-800' },
            completed: { text: 'پایان یافته', color: 'bg-green-100 text-green-800' },
            cancelled: { text: 'لغو شده', color: 'bg-gray-100 text-gray-800' },
            declined: { text: 'رد شده', color: 'bg-red-100 text-red-800' }
        };

        listEl.innerHTML = data.map(apt => {
            const container = document.createElement('div');
            container.className = 'bg-white p-4 rounded-2xl shadow-md';
            if (!apt.therapist || !apt.slot) return '';
            
            const statusInfo = statusMap[apt.status] || statusMap.cancelled;
            const appointmentTime = apt.slot.start_time; // Already a formatted string
            const typeText = apt.type === 'in_person' ? 'جلسه حضوری' : 'مکالمه چت';
            const typeColor = apt.type === 'in_person' ? 'text-teal-700' : 'text-sky-700';

            let actionButtons = '';
            if (apt.status === 'confirmed') {
                actionButtons = `<button onclick="startChatWith('${apt.therapist.id}')" class="flex-1 bg-teal-500 text-white py-2 rounded-lg text-sm">ارتباط با روانشناس</button>`;
            }
            if (apt.status === 'pending' || apt.status === 'confirmed') {
                actionButtons += `<button onclick="cancelAppointment(${apt.id}, ${apt.slot.id})" class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm">لغو نوبت</button>`;
            }
            if (apt.status === 'completed') {
                actionButtons = `<button onclick="showRatingModal(${apt.id}, '${apt.therapist.id}', '${apt.therapist.full_name}')" class="flex-1 bg-amber-500 text-white py-2 rounded-lg text-sm">ثبت امتیاز و نظر</button>`;
            }

            container.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3">
                         <div class="w-12 h-12 rounded-full overflow-hidden" id="apt-therapist-avatar-${apt.id}"></div>
                        <div>
                            <p class="font-bold text-lg">${apt.therapist.full_name}</p>
                            <p class="text-sm text-gray-600">${appointmentTime}</p>
                            <p class="text-xs font-semibold ${typeColor} mt-1">${typeText}</p>
                        </div>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusInfo.color}">${statusInfo.text}</span>
                </div>
                ${actionButtons ? `<div class="mt-4 flex gap-2">${actionButtons}</div>` : ''}
            `;
            
            setTimeout(() => {
                const avatarEl = document.getElementById(`apt-therapist-avatar-${apt.id}`);
                if (avatarEl) {
                    renderAvatar(avatarEl, apt.therapist.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
                }
            }, 0);

            return container.outerHTML;
        }).join('');
        lucide.createIcons();
    };
    
    const renderTherapistListForBooking = async () => {
        const container = document.getElementById('therapist-list-container');
        const { data, error } = await db.from('profiles').select('*').eq('role', 'therapist');

        if (error) {
            container.innerHTML = `<p class="text-red-500">خطا در بارگذاری لیست روانشناسان.</p>`;
            return;
        }
        
        if (data.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500">در حال حاضر هیچ روانشناسی فعال نیست.</p>`;
            return;
        }

        container.innerHTML = data.map(t => `
            <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full overflow-hidden" id="therapist-list-avatar-${t.id}"></div>
                    <div>
                        <h3 class="font-bold text-lg">${t.full_name}</h3>
                        <p class="text-sm text-gray-500">${t.specialization || 'تخصص نامشخص'}</p>
                        ${renderStars(t.average_rating || 0, t.total_ratings || 0)}
                    </div>
                </div>
                <button onclick="showAvailableSlots('${t.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold">انتخاب</button>
            </div>
        `).join('');

        data.forEach(t => {
            const avatarEl = document.getElementById(`therapist-list-avatar-${t.id}`);
            if (avatarEl) {
                renderAvatar(avatarEl, t.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
            }
        });

        lucide.createIcons();
    };

    const showAvailableSlots = async (therapistId) => {
        showActionSpinner();
        const { data: slots, error } = await db
            .from('available_slots')
            .select('*')
            .eq('therapist_id', therapistId)
            .eq('is_booked', false)
            .order('start_time', { ascending: true });
        
        const { data: therapist, error: tError } = await db.from('profiles').select('full_name').eq('id', therapistId).single();
        hideActionSpinner();

        if (error || tError) {
            showToast('خطا در دریافت زمان‌های خالی.', 'error');
            console.error(error || tError);
            return;
        }

        let content = '<p class="text-center text-gray-500">متاسفانه این روانشناس زمان خالی ندارد.</p>';
        if (slots.length > 0) {
            content = `
                <div class="space-y-2">
                    ${slots.map(slot => {
                        const time = slot.start_time; // Already a formatted string
                        const typeText = slot.type === 'in_person' ? 'حضوری' : 'چت';
                        return `
                        <label class="flex justify-between items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-teal-50 has-[:checked]:border-teal-500">
                            <div>
                                <p class="font-semibold">${time}</p>
                                <p class="text-sm text-gray-600">نوع جلسه: ${typeText}</p>
                            </div>
                            <input type="radio" name="slot" value="${slot.id}" data-type="${slot.type}" class="form-radio text-teal-600">
                        </label>
                        `;
                    }).join('')}
                </div>
            `;
        }

        const actions = [{
            text: 'رزرو نهایی',
            className: 'px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600',
            handler: `bookAppointment()`
        }];

        showModal(`انتخاب زمان برای ${therapist.full_name}`, content, actions);
    };

    const bookAppointment = async () => {
        const selectedSlot = document.querySelector('input[name="slot"]:checked');
        if (!selectedSlot) {
            showToast('لطفاً یک زمان را انتخاب کنید.', 'error');
            return;
        }

        const slotId = selectedSlot.value;
        
        closeModal();
        showActionSpinner();

        const { data, error } = await db.rpc('book_appointment_slot', {
            slot_id_arg: slotId
        });

        hideActionSpinner();

        if (error) {
            if (error.message.includes('SLOT_ALREADY_BOOKED')) {
                showToast('متاسفانه این زمان به تازگی رزرو شده است. لطفاً صفحه را رفرش کنید.', 'error');
            } else if (error.message.includes('SLOT_NOT_FOUND')) {
                showToast('زمان انتخاب شده یافت نشد.', 'error');
            } else {
                showToast('خطا در ایجاد نوبت. لطفاً دوباره تلاش کنید.', 'error');
                console.error('RPC Error:', error);
            }
        } else if (data && data.success) {
            showToast('درخواست نوبت شما ثبت شد و منتظر تایید روانشناس است.', 'success');
            await renderClientAppointments();
            await renderClientDashboard();
        } else {
             showToast(data?.message || 'خطای نامشخصی رخ داد.', 'error');
        }
    };
    
    const cancelAppointment = async (id, slotId) => {
        showActionSpinner();
        const { error: apptError } = await db.from('appointments').update({ status: 'cancelled' }).eq('id', id);
        if (apptError) {
            hideActionSpinner();
            showToast('خطا در لغو نوبت.', 'error');
            return;
        }
        
        const { error: slotError } = await db.from('available_slots').update({ is_booked: false }).eq('id', slotId);
        hideActionSpinner();
        
        if(slotError) {
            showToast('نوبت لغو شد، اما در آزاد کردن زمان خطایی رخ داد.', 'info');
        } else {
            showToast('نوبت با موفقیت لغو شد.', 'success');
        }
        await loadClientAppointments();
    };
    
    const checkForPendingReviews = async () => {
        const { data: completedAppointments, error: aptError } = await db
            .from('appointments')
            .select('id, therapist:therapist_id(id, full_name)')
            .eq('client_id', currentUser.id)
            .eq('status', 'completed');

        if (aptError || !completedAppointments || completedAppointments.length === 0) return;

        const { data: reviews, error: revError } = await db
            .from('reviews')
            .select('appointment_id')
            .eq('client_id', currentUser.id);

        if (revError) return;

        const reviewedAppointmentIds = reviews.map(r => r.appointment_id);
        const unreviewedAppointment = completedAppointments.find(
            apt => !reviewedAppointmentIds.includes(apt.id)
        );

        if (unreviewedAppointment) {
            setTimeout(() => {
                showRatingModal(unreviewedAppointment.id, unreviewedAppointment.therapist.id, unreviewedAppointment.therapist.full_name);
            }, 1000);
        }
    };

    const showRatingModal = (appointmentId, therapistId, therapistName = '') => {
        let currentRating = 0;
        const title = therapistName ? `امتیازدهی به جلسه با ${therapistName}` : 'امتیازدهی به جلسه';
        const content = `
            <p class="mb-4">جلسه شما به پایان رسید. لطفا به این جلسه امتیاز دهید. ثبت نظر متنی اختیاری است.</p>
            <div id="modal-star-rating" class="star-rating flex justify-center text-4xl mb-4">
                ${[1,2,3,4,5].map(i => `<i data-lucide="star" data-value="${i}" class="star"></i>`).join('')}
            </div>
            <textarea id="rating-comment" class="w-full h-24 p-2 border rounded-lg" placeholder="نظر خود را اینجا بنویسید (اختیاری)..."></textarea>
        `;
        const actions = [{
            text: 'ثبت نظر',
            className: 'px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600',
            handler: `submitReview(${appointmentId}, '${therapistId}')`
        }];
        showModal(title, content, actions);
        lucide.createIcons();

        const stars = document.querySelectorAll('#modal-star-rating .star');
        stars.forEach(star => {
            star.addEventListener('click', () => {
                currentRating = star.dataset.value;
                window.currentRating = currentRating;
                stars.forEach(s => {
                    s.classList.toggle('selected', s.dataset.value <= currentRating);
                });
            });
        });
    };

    const submitReview = async (appointmentId, therapistId) => {
        const rating = window.currentRating;
        const comment = document.getElementById('rating-comment').value;

        if (!rating || rating === 0) {
            showToast('لطفا ابتدا یک امتیاز (ستاره) را انتخاب کنید.', 'error');
            return;
        }
        
        closeModal();
        showActionSpinner();

        const { error } = await db.from('reviews').insert({
            appointment_id: appointmentId,
            client_id: currentUser.id,
            therapist_id: therapistId,
            rating: rating,
            comment: comment
        });

        if (error) {
            hideActionSpinner();
            showToast('خطا در ثبت نظر. شاید قبلا نظر خود را ثبت کرده باشید.', 'error');
            console.error(error);
        } else {
            const { error: rpcError } = await db.rpc('update_therapist_rating', { therapist_id_arg: therapistId });
            hideActionSpinner();
            if (rpcError) {
                 showToast('نظر شما ثبت شد اما در به‌روزرسانی امتیاز مشکلی پیش آمد.', 'info');
                 console.error("RPC Error:", rpcError);
            } else {
                 showToast('نظر و امتیاز شما با موفقیت ثبت شد.', 'success');
            }
            // RATING FIX: Refresh the entire appointments page to update the therapist list with new stars.
            await renderClientAppointments();
        }
    };


    // --- CLIENT: PROFILE ---
    const renderClientProfile = async () => {
        const page = document.getElementById('client-profile-page');
        page.innerHTML = `
            <div class="p-4 space-y-6">
                 <div class="flex flex-col items-center space-y-4">
                     <div class="relative w-24 h-24">
                         <div id="profile-page-avatar" class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-lg"></div>
                         <label for="avatar-upload" class="absolute bottom-0 right-0 bg-white p-1.5 rounded-full shadow-md cursor-pointer">
                             <i data-lucide="camera" class="w-5 h-5 text-gray-600"></i>
                             <input id="avatar-upload" type="file" class="hidden" accept="image/*" onchange="uploadProfilePicture(event)">
                         </label>
                     </div>
                     <div class="text-center">
                         <h1 class="text-2xl font-bold text-gray-800">${userProfile.full_name}</h1>
                         <p class="text-gray-500">${currentUser.email}</p>
                     </div>
                 </div>

                 <div class="bg-white p-2 rounded-2xl shadow-md">
                     <a href="#" onclick="openProfileEditor()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                         <div class="flex items-center gap-4">
                             <i data-lucide="edit" class="text-gray-600"></i>
                             <span class="font-semibold text-gray-700">ویرایش اطلاعات کاربری</span>
                         </div>
                         <i data-lucide="chevron-left" class="text-gray-400"></i>
                     </a>
                     <a href="#" onclick="viewTestHistory()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                         <div class="flex items-center gap-4">
                             <i data-lucide="clipboard-list" class="text-gray-600"></i>
                             <span class="font-semibold text-gray-700">سوابق تست‌ها</span>
                         </div>
                         <i data-lucide="chevron-left" class="text-gray-400"></i>
                     </a>
                     <a href="#" onclick="showSupportRequest()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                         <div class="flex items-center gap-4">
                             <i data-lucide="headphones" class="text-gray-600"></i>
                             <span class="font-semibold text-gray-700">درخواست پشتیبانی</span>
                         </div>
                         <i data-lucide="chevron-left" class="text-gray-400"></i>
                     </a>
                      <div class="border-t my-1 mx-2"></div>
                     <a href="#" onclick="handleLogout()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg text-red-500">
                         <div class="flex items-center gap-4">
                             <i data-lucide="log-out"></i>
                             <span class="font-semibold">خروج</span>
                         </div>
                     </a>
                 </div>
                 <p class="text-center text-gray-400 text-sm">نسخه ۲.۰.۳</p>
             </div>
        `;
        renderAvatar(document.getElementById('profile-page-avatar'), userProfile.avatar_url);
        lucide.createIcons();
    };
    
    const openProfileEditor = () => {
        const content = `
            <div class="space-y-4">
                <div class="space-y-2">
                    <label for="modal-fullname-input" class="block text-sm font-medium text-gray-700">نام کامل</label>
                    <input id="modal-fullname-input" type="text" class="w-full p-2 border rounded-lg" value="${userProfile.full_name || ''}">
                </div>
                <div class="space-y-2">
                    <label for="modal-bio-input" class="block text-sm font-medium text-gray-700">بیوگرافی (اختیاری)</label>
                    <textarea id="modal-bio-input" class="w-full h-24 p-2 border rounded-lg" placeholder="کمی درباره خودتان بنویسید...">${userProfile.bio || ''}</textarea>
                </div>
                <button id="save-profile-btn" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">ذخیره تغییرات</button>
            </div>
        `;
        showModal('ویرایش اطلاعات کاربری', content);
        
        document.getElementById('save-profile-btn').onclick = async () => {
            const newName = document.getElementById('modal-fullname-input').value;
            const newBio = document.getElementById('modal-bio-input').value;
            
            closeModal(); 
            showActionSpinner();
            const { data, error } = await db.from('profiles').update({ 
                full_name: newName,
                bio: newBio
            }).eq('id', currentUser.id).select().single();
            hideActionSpinner();
            
            if (error) {
                showToast('خطا در به‌روزرسانی پروفایل.', 'error');
            } else {
                userProfile = data;
                showToast('پروفایل با موفقیت به‌روزرسانی شد.', 'success');
                await renderClientProfile();
            }
        };
    };

    const uploadProfilePicture = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showActionSpinner();
        const fileName = `${currentUser.id}/${Date.now()}-${file.name}`;
        
        if (userProfile.avatar_url) {
            const oldAvatarPath = userProfile.avatar_url.split('/avatars/')[1];
            if (oldAvatarPath) {
                await db.storage.from('avatars').remove([oldAvatarPath]);
            }
        }

        const { error: uploadError } = await db.storage.from('avatars').upload(fileName, file);
        if (uploadError) {
            hideActionSpinner();
            showToast('خطا در آپلود تصویر.', 'error');
            console.error(uploadError);
            return;
        }

        const { data: urlData } = db.storage.from('avatars').getPublicUrl(fileName);
        const { error: updateError } = await db.from('profiles').update({ avatar_url: urlData.publicUrl }).eq('id', currentUser.id);
        
        hideActionSpinner();
        if (updateError) {
            showToast('خطا در ذخیره آدرس تصویر.', 'error');
        } else {
            userProfile.avatar_url = urlData.publicUrl;
            showToast('عکس پروفایل با موفقیت به‌روزرسانی شد.', 'success');
            if (userProfile.role === 'client') await renderClientProfile();
            if (userProfile.role === 'therapist') await renderTherapistProfile();
        }
    };

    const showSupportRequest = () => {
        const content = `
            <p class="mb-4">برای دریافت پشتیبانی، لطفاً با ایمیل info@psynoland.ir در تماس باشید یا فرم زیر را پر کنید.</p>
            <form id="support-form">
                <textarea class="w-full h-32 p-2 border rounded-lg" placeholder="مشکل خود را اینجا شرح دهید..."></textarea>
                <button type="submit" class="mt-2 w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">ارسال درخواست</button>
            </form>
        `;
        showModal('درخواست پشتیبانی', content);
        document.getElementById('support-form').addEventListener('submit', (e) => {
            e.preventDefault();
            closeModal();
            showToast('درخواست شما با موفقیت ثبت شد. به زودی با شما تماس می‌گیریم.', 'success');
        });
    };

    const viewTestHistory = async () => {
        showActionSpinner();
        const { data, error } = await db.from('test_results')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        hideActionSpinner();

        if (error) {
            showToast('خطا در دریافت تاریخچه تست‌ها', 'error');
            return;
        }

        let content = '<p class="text-center text-gray-500">هیچ نتیجه‌ای یافت نشد.</p>';

        if (data && data.length > 0) {
            content = `
                <div class="space-y-4">
                ${data.map(test => `
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <p class="font-bold">${test.test_name}</p>
                        <p class="text-sm text-gray-500 mb-2">${new persianDate(new Date(test.created_at)).format('L')}</p>
                        <p class="text-sm"><strong>امتیاز: ${test.score}</strong> - ${test.result_text}</p>
                    </div>
                `).join('')}
                </div>
            `;
        }
        
        showModal('تاریخچه نتایج تست‌ها', content);
    };

    // =================================================================
    // THERAPIST-SIDE RENDERING & LOGIC
    // =================================================================

    // --- THERAPIST: DASHBOARD ---
    const renderTherapistDashboard = async () => {
        const page = document.getElementById('therapist-dashboard-page');
        showActionSpinner();
        
        const { data: pendingAppointments, error: pendingError } = await db
            .from('appointments')
            .select('id, type, client:client_id(id, full_name, avatar_url), slot:slot_id(id, start_time)', { count: 'exact' })
            .eq('therapist_id', currentUser.id)
            .eq('status', 'pending');

        const { data: upcomingAppointments, error: upcomingError } = await db
            .from('appointments')
            .select('id, client:client_id(id, full_name), slot:slot_id(start_time)')
            .eq('therapist_id', currentUser.id)
            .eq('status', 'confirmed');

        const { data: clients, error: clientError } = await db.rpc('get_unique_clients_for_therapist', { therapist_id_arg: currentUser.id });
        
        hideActionSpinner();

        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">داشبورد دکتر ${userProfile.full_name.split(' ').slice(1).join(' ') || userProfile.full_name}</h1>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-yellow-600">${pendingAppointments?.length || 0}</p>
                        <p class="text-gray-500 text-sm">درخواست جدید</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-teal-600">${upcomingAppointments?.length || 0}</p>
                        <p class="text-gray-500 text-sm">نوبت آینده</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-blue-600">${clients?.length || 0}</p>
                        <p class="text-gray-500 text-sm">کل مراجعین</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">درخواست‌های نوبت جدید</h2>
                    <div id="pending-appointments-list" class="space-y-3">
                        <!-- Content will be rendered here -->
                    </div>
                </div>
            </div>
        `;
        
        const pendingListEl = document.getElementById('pending-appointments-list');
        if (pendingError) {
            pendingListEl.innerHTML = '<p class="text-red-500">خطا در بارگذاری</p>';
        } else if (pendingAppointments && pendingAppointments.length > 0) {
            pendingListEl.innerHTML = pendingAppointments.map(apt => `
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full overflow-hidden" id="pending-apt-avatar-${apt.id}"></div>
                            <div>
                                <p class="font-semibold">${apt.client.full_name}</p>
                                <p class="text-sm text-gray-500">${apt.slot.start_time} (${apt.type === 'in_person' ? 'حضوری' : 'چت'})</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="handleAppointmentConfirmation(${apt.id}, true, ${apt.slot.id})" class="p-2 bg-green-100 rounded-lg text-green-600"><i data-lucide="check"></i></button>
                            <button onclick="handleAppointmentConfirmation(${apt.id}, false, ${apt.slot.id})" class="p-2 bg-red-100 rounded-lg text-red-600"><i data-lucide="x"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');

            pendingAppointments.forEach(apt => {
                 const avatarEl = document.getElementById(`pending-apt-avatar-${apt.id}`);
                 if(avatarEl) renderAvatar(avatarEl, apt.client.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
            });

        } else {
            pendingListEl.innerHTML = '<p class="text-center text-gray-500">درخواست جدیدی ندارید.</p>';
        }

        lucide.createIcons();
    };

    const handleAppointmentConfirmation = async (appointmentId, isConfirmed, slotId) => {
        showActionSpinner();
        const newStatus = isConfirmed ? 'confirmed' : 'declined';
        const { error: updateError } = await db.from('appointments').update({ status: newStatus }).eq('id', appointmentId);

        if (updateError) {
            hideActionSpinner();
            showToast('خطا در پردازش درخواست.', 'error');
            return;
        }

        if (!isConfirmed) {
            await db.from('available_slots').update({ is_booked: false }).eq('id', slotId);
        }
        
        hideActionSpinner();
        showToast(`نوبت با موفقیت ${isConfirmed ? 'تایید' : 'رد'} شد.`, 'success');
        await renderTherapistDashboard();
    };


    // --- THERAPIST: CLIENTS ---
    const renderTherapistClients = async () => {
        const page = document.getElementById('therapist-clients-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">لیست مراجعین</h1>
                <div id="client-list-container" class="space-y-3">
                    <p class="text-center text-gray-500">در حال بارگذاری لیست مراجعین...</p>
                </div>
            </div>`;
        showActionSpinner();
        try {
            const { data: clients, error: rpcError } = await db.rpc('get_unique_clients_for_therapist', { therapist_id_arg: currentUser.id });

            if (rpcError) throw rpcError;

            let clientsHTML = '';
            if (clients && clients.length > 0) {
                clientsHTML = clients.map(client => `
                    <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full overflow-hidden" id="client-list-avatar-${client.id}"></div>
                            <div>
                                <p class="font-bold">${client.full_name}</p>
                                <p class="text-sm text-gray-500">${client.email}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewClientDetails('${client.id}')" class="p-2 bg-gray-100 rounded-lg text-gray-600"><i data-lucide="eye"></i></button>
                            <button onclick="startChatWith('${client.id}')" class="p-2 bg-teal-100 rounded-lg text-teal-600"><i data-lucide="message-square"></i></button>
                        </div>
                    </div>
                `).join('');
                 document.getElementById('client-list-container').innerHTML = clientsHTML;
                 clients.forEach(client => {
                     const avatarEl = document.getElementById(`client-list-avatar-${client.id}`);
                     if (avatarEl) renderAvatar(avatarEl, client.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
                 });
            } else {
                document.getElementById('client-list-container').innerHTML = '<p class="text-center text-gray-500">شما هیچ مراجعه‌کننده‌ای ندارید.</p>';
            }
        } catch (error) {
            console.error("Error loading clients:", error);
            document.getElementById('client-list-container').innerHTML = `<p class="text-red-500 text-center">خطا در بارگذاری لیست مراجعین.</p>`;
        } finally {
            hideActionSpinner();
            lucide.createIcons();
        }
    };


    const viewClientDetails = async (clientId) => {
        showActionSpinner();
        try {
            const { data: profile, error: pError } = await db.from('profiles').select('full_name, bio').eq('id', clientId).single();
            if (pError) throw pError;

            const { data: moods, error: mError } = await db.from('mood_entries').select('mood_score, created_at').eq('user_id', clientId).order('created_at', {ascending: false}).limit(7);
            if (mError) throw mError;
            
            const { data: tests, error: tError } = await db.from('test_results').select('*').eq('user_id', clientId).order('created_at', {ascending: false}).limit(5);
            if (tError) throw tError;

            hideActionSpinner();

            let content = `<div class="space-y-4">
                ${profile.bio ? `<div><h4 class="font-bold text-md mb-2">بیوگرافی مراجع</h4><p class="text-sm bg-gray-100 p-2 rounded-lg">${profile.bio}</p></div>` : ''}
                <div>
                    <h4 class="font-bold text-md mb-2">نمودار وضعیت روحی اخیر</h4>
                    ${moods.length > 0 ? `<div class="h-48"><canvas id="clientMoodChart"></canvas></div>` : '<p class="text-sm text-gray-500">داده‌ای برای نمایش وجود ندارد.</p>'}
                </div>
                <div>
                    <h4 class="font-bold text-md mb-2">آخرین نتایج تست‌ها</h4>
                    ${tests.length > 0 ? `
                        <ul class="list-disc pr-5 space-y-2 text-sm">
                            ${tests.map(t => `<li><strong>${t.test_name}:</strong> ${t.result_text} (امتیاز: ${t.score})</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">نتیجه تستی ثبت نشده است.</p>'}
                </div>
            </div>`;

            showModal(`جزئیات مراجع: ${profile?.full_name || ''}`, content);
            
            if(moods && moods.length > 0) {
                const labels = moods.map(d => new persianDate(new Date(d.created_at)).format('D MMM')).reverse();
                const scores = moods.map(d => d.mood_score).reverse();
                const canvasEl = document.getElementById('clientMoodChart');
                if (!canvasEl) return;
                const ctx = canvasEl.getContext('2d');
                
                if (clientMoodChartInstance) clientMoodChartInstance.destroy();

                clientMoodChartInstance = new Chart(ctx, { 
                    type: 'bar', 
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: 'نمره حال', 
                            data: scores, 
                            backgroundColor: 'rgba(20, 184, 166, 0.5)',
                            borderColor: 'rgb(20, 184, 166)',
                            borderWidth: 1,
                            borderRadius: 8,
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 5 } },
                        plugins: { legend: { display: false } }
                    } 
                });
            }
        } catch (error) {
            hideActionSpinner();
            console.error("Error in viewClientDetails:", error);
            showToast(`خطا در بارگذاری جزئیات: ${error.message}`, 'error');
        }
    };

    // --- THERAPIST: SCHEDULE ---
    const renderTherapistSchedule = async () => {
        const page = document.getElementById('therapist-schedule-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">برنامه کاری شما</h1>
                
                <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
                    <h2 class="text-lg font-bold mb-4">افزودن زمان خالی جدید</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="slot-date" class="block text-sm font-medium text-gray-700">تاریخ</label>
                            <input type="text" id="slot-date" readonly class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white cursor-pointer" placeholder="برای انتخاب تاریخ کلیک کنید">
                        </div>
                        <div>
                            <label for="slot-time" class="block text-sm font-medium text-gray-700">ساعت شروع</label>
                            <input type="time" id="slot-time" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="slot-type" class="block text-sm font-medium text-gray-700">نوع جلسه</label>
                            <select id="slot-type" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm">
                                <option value="in_person">حضوری</option>
                                <option value="chat">چت</option>
                            </select>
                        </div>
                        <button onclick="addAvailableSlot()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition">افزودن زمان</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-4">زمان‌های خالی شما</h2>
                    <div id="available-slots-list" class="space-y-2">
                        <p class="text-center text-gray-500">در حال بارگذاری...</p>
                    </div>
                </div>
            </div>
        `;

        $('#slot-date').persianDatepicker({
            format: 'YYYY/MM/DD',
            minDate: new persianDate(),
            observer: true,
            autoClose: true,
        });

        await loadAvailableSlots();
        lucide.createIcons();
    };
    
    const addAvailableSlot = async () => {
        const dateStr = $('#slot-date').val();
        const timeStr = $('#slot-time').val();
        const type = $('#slot-type').val();

        if (!dateStr || !timeStr) {
            showToast('لطفا تاریخ و ساعت را کامل وارد کنید.', 'error');
            return;
        }

        const startTimeString = `${dateStr} - ${timeStr}`;

        showActionSpinner();
        const { error } = await db.from('available_slots').insert({
            therapist_id: currentUser.id,
            start_time: startTimeString,
            type: type
        });
        hideActionSpinner();

        if (error) {
            showToast('خطا در افزودن زمان.', 'error');
            console.error(error);
        } else {
            showToast('زمان با موفقیت افزوده شد.', 'success');
            $('#slot-date').val('');
            $('#slot-time').val('');
            await loadAvailableSlots();
        }
    };
    
    const loadAvailableSlots = async () => {
        const listEl = document.getElementById('available-slots-list');
        if (!listEl) return;

        const { data, error } = await db
            .from('available_slots')
            .select('*')
            .eq('therapist_id', currentUser.id)
            .eq('is_booked', false)
            .order('start_time', { ascending: true });

        if (error) {
            listEl.innerHTML = '<p class="text-red-500">خطا در بارگذاری.</p>';
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = '<p class="text-center text-gray-500">زمان خالی ثبت نشده است.</p>';
            return;
        }

        listEl.innerHTML = data.map(slot => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div>
                    <p class="font-semibold">${slot.start_time}</p>
                    <p class="text-sm text-gray-600">نوع: ${slot.type === 'in_person' ? 'حضوری' : 'چت'}</p>
                </div>
                <button onclick="deleteAvailableSlot(${slot.id})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>
        `).join('');
        lucide.createIcons();
    };

    const deleteAvailableSlot = async (slotId) => {
        showActionSpinner();
        const { error } = await db.from('available_slots').delete().eq('id', slotId);
        hideActionSpinner();
        if (error) {
            showToast('خطا در حذف زمان.', 'error');
        } else {
            showToast('زمان با موفقیت حذف شد.', 'success');
            await loadAvailableSlots();
        }
    };

    // --- THERAPIST: PROFILE ---
    const renderTherapistProfile = async () => {
        // RATING FIX: Re-fetch the latest profile data every time the page is rendered
        // to ensure the star rating is always up-to-date.
        showActionSpinner();
        const { data: latestProfile, error: profileError } = await db
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();
        hideActionSpinner();

        if (profileError || !latestProfile) {
            showToast('خطا در بارگذاری اطلاعات پروفایل.', 'error');
            console.error(profileError);
            return;
        }
        // Update the global userProfile object
        userProfile = latestProfile;

        const page = document.getElementById('therapist-profile-page');
        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col items-center space-y-4">
                    <div class="relative w-24 h-24">
                        <div id="therapist-profile-avatar" class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-lg"></div>
                        <label for="therapist-avatar-upload" class="absolute bottom-0 right-0 bg-white p-1.5 rounded-full shadow-md cursor-pointer">
                            <i data-lucide="camera" class="w-5 h-5 text-gray-600"></i>
                            <input id="therapist-avatar-upload" type="file" class="hidden" accept="image/*" onchange="uploadProfilePicture(event)">
                        </label>
                    </div>
                    <div class="text-center">
                        <h1 class="text-2xl font-bold">${userProfile.full_name}</h1>
                        <p class="text-gray-500">${currentUser.email}</p>
                        <div class="mt-2 flex justify-center">${renderStars(userProfile.average_rating || 0, userProfile.total_ratings || 0)}</div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                    <h2 class="text-lg font-bold">ویرایش پروفایل تخصصی</h2>
                    <div class="space-y-2">
                        <label for="therapist-fullname-input" class="block text-sm font-medium text-gray-700">نام کامل</label>
                        <input id="therapist-fullname-input" type="text" class="w-full p-2 border rounded-lg" value="${userProfile.full_name || ''}">
                    </div>
                     <div class="space-y-2">
                        <label for="therapist-specialization-input" class="block text-sm font-medium text-gray-700">تخصص‌ها (با کاما جدا کنید)</label>
                        <input id="therapist-specialization-input" type="text" class="w-full p-2 border rounded-lg" placeholder="مثال: CBT, روانکاوی" value="${userProfile.specialization || ''}">
                    </div>
                    <div class="space-y-2">
                        <label for="therapist-bio-input" class="block text-sm font-medium text-gray-700">بیوگرافی تخصصی</label>
                        <textarea id="therapist-bio-input" class="w-full h-24 p-2 border rounded-lg" placeholder="درباره سوابق و رویکرد درمانی خود بنویسید...">${userProfile.bio || ''}</textarea>
                    </div>
                    <button onclick="updateTherapistProfile()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">ذخیره تغییرات</button>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-3">نظرات مراجعین</h2>
                    <div id="therapist-reviews-list" class="space-y-3 max-h-64 overflow-y-auto"></div>
                </div>

                <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">خروج از حساب</button>
            </div>
        `;
        renderAvatar(document.getElementById('therapist-profile-avatar'), userProfile.avatar_url, { bgColor: 'bg-blue-100', iconColor: 'text-blue-600'});
        await loadTherapistReviews();
        lucide.createIcons();
    };

    const updateTherapistProfile = async () => {
        const newName = document.getElementById('therapist-fullname-input').value;
        const newBio = document.getElementById('therapist-bio-input').value;
        const newSpec = document.getElementById('therapist-specialization-input').value;

        showActionSpinner();
        const { data, error } = await db.from('profiles').update({ 
            full_name: newName,
            bio: newBio,
            specialization: newSpec,
        }).eq('id', currentUser.id).select().single();
        hideActionSpinner();
        
        if (error) {
            showToast('خطا در به‌روزرسانی پروفایل.', 'error');
            console.error(error);
        } else {
            userProfile = data;
            showToast('پروفایل با موفقیت به‌روزرسانی شد.', 'success');
            await renderTherapistProfile();
        }
    };

    const loadTherapistReviews = async () => {
        const listEl = document.getElementById('therapist-reviews-list');
        if (!listEl) return;
        listEl.innerHTML = '<p class="text-center text-gray-500">در حال بارگذاری نظرات...</p>';

        const { data, error } = await db
            .from('reviews')
            .select('*')
            .eq('therapist_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            listEl.innerHTML = '<p class="text-red-500">خطا در بارگذاری نظرات.</p>';
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = '<p class="text-center text-gray-500">هنوز نظری برای شما ثبت نشده است.</p>';
            return;
        }

        listEl.innerHTML = data.map(review => `
            <div class="bg-gray-50 p-3 rounded-lg border">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-sm">کاربر ساینو</span>
                    <div class="flex items-center">
                        <span class="text-amber-500 font-bold ml-1">${review.rating}</span>
                        <i data-lucide="star" class="w-4 h-4 text-amber-400 fill-current"></i>
                    </div>
                </div>
                <p class="text-gray-700 text-sm italic">"${review.comment || 'بدون نظر متنی'}"</p>
                <p class="text-xs text-gray-400 text-left mt-2">${new persianDate(new Date(review.created_at)).format('L')}</p>
            </div>
        `).join('');
        lucide.createIcons();
    };


    // =================================================================
    // SHARED: CHAT PAGE (UPGRADED WITH OPTIMISTIC UI & TICKS)
    // =================================================================
    const startChatWith = async (otherUserId) => {
        const page = document.getElementById('chat-page');
        const { data: otherUser, error } = await db.from('profiles').select('id, full_name, avatar_url').eq('id', otherUserId).single();
        if (error) {
            showToast('کاربر مورد نظر یافت نشد.', 'error');
            return;
        }
        
        let therapistControls = '';
        if (userProfile.role === 'therapist') {
            therapistControls = `<button onclick="confirmEndChat('${otherUserId}')" class="ml-auto text-xs bg-red-500 text-white font-semibold py-1 px-3 rounded-full">پایان گفتگو</button>`;
        }

        page.innerHTML = `
            <header class="bg-white shadow-sm p-3 flex items-center gap-3 flex-shrink-0">
                <button onclick="goBackFromChat()" class="text-gray-600"><i data-lucide="arrow-right"></i></button>
                <div class="w-10 h-10 rounded-full overflow-hidden" id="chat-header-avatar"></div>
                <h1 class="font-bold text-lg">${otherUser.full_name}</h1>
                ${therapistControls}
            </header>
            <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
            </div>
            <footer class="bg-white p-2 flex items-center gap-2 border-t flex-shrink-0">
                <label for="chat-image-upload" class="cursor-pointer p-2 text-gray-500 hover:text-teal-600 transition-colors">
                    <i data-lucide="paperclip"></i>
                </label>
                <input id="chat-image-upload" type="file" class="hidden" accept="image/*">
                <input id="chat-input" type="text" class="flex-grow bg-gray-100 rounded-full py-2 px-4 focus:outline-none" placeholder="پیام خود را بنویسید...">
                <button id="send-chat-btn" class="bg-teal-500 text-white w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">
                    <i data-lucide="send"></i>
                </button>
            </footer>
        `;
        renderAvatar(document.getElementById('chat-header-avatar'), otherUser.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
        lucide.createIcons();
        page.style.padding = '0'; 
        navigateTo('chat-page');

        const messageContainer = document.getElementById('chat-messages');
        const sendBtn = document.getElementById('send-chat-btn');
        const chatInput = document.getElementById('chat-input');
        const chatImageUpload = document.getElementById('chat-image-upload');

        const boundSendMessage = () => handleSendMessage(otherUserId, chatInput);
        const boundImageUpload = (event) => handleChatImageUpload(event, otherUserId);

        sendBtn.onclick = boundSendMessage;
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') boundSendMessage();
        });
        chatImageUpload.onchange = boundImageUpload;
        
        await loadMessages(otherUserId, messageContainer);
        await markMessagesAsRead(otherUserId);

        if (chatSubscription) chatSubscription.unsubscribe();

        chatSubscription = db.channel('public:chat_messages')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, 
            (payload) => {
                const newMessage = payload.new;
                const isRelevant = (newMessage.sender_id === otherUserId && newMessage.receiver_id === currentUser.id) || 
                                     (newMessage.sender_id === currentUser.id && newMessage.receiver_id === otherUserId);

                if (!isRelevant) return;

                if (payload.eventType === 'INSERT' && newMessage.sender_id === otherUserId) {
                    messageContainer.innerHTML += renderMessage(newMessage);
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                    lucide.createIcons();
                    markMessagesAsRead(otherUserId);
                } else if (payload.eventType === 'UPDATE') {
                    const messageEl = document.querySelector(`[data-message-id='${newMessage.id}']`);
                    if (messageEl) {
                        const ticksEl = messageEl.querySelector('.chat-ticks');
                        if (ticksEl && newMessage.is_read) {
                            ticksEl.innerHTML = getTickHTML('read');
                            lucide.createIcons({ nodes: [ticksEl] });
                        }
                    }
                }
            })
            .subscribe();
    };

    const goBackFromChat = () => {
        if (chatSubscription) {
            chatSubscription.unsubscribe();
            chatSubscription = null;
        }
        document.getElementById('chat-page').style.padding = ''; 
        navigateTo(lastPageId);
    };

    const getTickHTML = (status) => {
        if (status === 'read') return '<i data-lucide="check-check" class="w-4 h-4 text-blue-400"></i>';
        if (status === 'sent') return '<i data-lucide="check" class="w-4 h-4"></i>';
        return '<i data-lucide="clock" class="w-4 h-4"></i>'; // sending
    };

    const renderMessage = (msg) => {
        const isMe = msg.sender_id === currentUser.id;
        const time = new Date(msg.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        let messageContentHTML = '';
        let bubbleClasses = 'px-4 py-2';

        if (msg.image_url) {
            bubbleClasses = 'p-1';
            messageContentHTML = `<img src="${msg.image_url}" class="rounded-lg max-w-full h-auto" style="max-height: 250px;" alt="تصویر ارسال شده" onload="this.closest('#chat-messages').scrollTop = this.closest('#chat-messages').scrollHeight">`;
        } else {
            messageContentHTML = `<p class="whitespace-pre-wrap">${msg.message_text}</p>`;
        }
        
        let tickStatus = msg.is_read ? 'read' : 'sent';
        if (msg.optimisticStatus) tickStatus = msg.optimisticStatus;

        return `
            <div class="flex items-end gap-2 ${isMe ? 'justify-end' : 'justify-start'}" data-message-id="${msg.id}">
                <div class="max-w-xs lg:max-w-md ${bubbleClasses} rounded-2xl ${isMe ? 'bg-teal-500 text-white rounded-br-lg' : 'bg-gray-200 text-gray-800 rounded-bl-lg'}">
                    ${messageContentHTML}
                    <div class="text-xs mt-1 ${isMe ? 'text-white/70' : 'text-gray-500'} text-left flex items-center justify-end">
                        <span>${time}</span>
                        ${isMe ? `<span class="chat-ticks">${getTickHTML(tickStatus)}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
    };

    const loadMessages = async (otherUserId, messageContainer) => {
        const { data: messages, error } = await db.from('chat_messages')
            .select('*')
            .in('sender_id', [currentUser.id, otherUserId])
            .in('receiver_id', [currentUser.id, otherUserId])
            .order('created_at', { ascending: true });
        
        if(messages) {
            messageContainer.innerHTML = messages.map(renderMessage).join('');
            lucide.createIcons();
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    };

    const handleSendMessage = async (otherUserId, chatInput) => {
        const messageText = chatInput.value.trim();
        if (!messageText) return;
        
        const tempId = `temp_${Date.now()}`;
        const optimisticMessage = {
            id: tempId,
            sender_id: currentUser.id,
            receiver_id: otherUserId,
            message_text: messageText,
            image_url: null,
            created_at: new Date().toISOString(),
            is_read: false,
            optimisticStatus: 'sending'
        };
        
        const messageContainer = document.getElementById('chat-messages');
        messageContainer.innerHTML += renderMessage(optimisticMessage);
        lucide.createIcons();
        messageContainer.scrollTop = messageContainer.scrollHeight;
        chatInput.value = '';

        const { data, error } = await db.from('chat_messages').insert({
            sender_id: optimisticMessage.sender_id,
            receiver_id: otherUserId,
            message_text: optimisticMessage.message_text,
            is_read: false
        }).select().single();

        const tempNode = document.querySelector(`[data-message-id='${tempId}']`);
        if (tempNode) {
            if (error) {
                console.error('Error sending message:', error);
                showToast('پیام ارسال نشد.', 'error');
                const ticksEl = tempNode.querySelector('.chat-ticks');
                if (ticksEl) {
                    ticksEl.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i>';
                    lucide.createIcons({ nodes: [ticksEl] });
                }
            } else {
                const finalMessageNode = new DOMParser().parseFromString(renderMessage(data), 'text/html').body.firstChild;
                tempNode.replaceWith(finalMessageNode);
                lucide.createIcons({ nodes: [finalMessageNode] });
            }
        }
    };

    const markMessagesAsRead = async (otherUserId) => {
        try {
            await db.from('chat_messages')
                .update({ is_read: true })
                .eq('sender_id', otherUserId)
                .eq('receiver_id', currentUser.id)
                .eq('is_read', false);
        } catch (error) {
            console.error("Error marking messages as read:", error);
        }
    };

    const handleChatImageUpload = async (event, otherUserId) => {
        const file = event.target.files[0];
        if (!file) return;
        event.target.value = '';

        showActionSpinner();
        const bucketName = 'chat-images';
        const fileName = `public/${currentUser.id}_${otherUserId}/${Date.now()}-${file.name}`;

        const { error: uploadError } = await db.storage.from(bucketName).upload(fileName, file);

        if (uploadError) {
            hideActionSpinner();
            showToast('خطا در آپلود تصویر.', 'error');
            console.error(uploadError);
            return;
        }

        const { data: urlData } = db.storage.from(bucketName).getPublicUrl(fileName);

        const { error: insertError } = await db.from('chat_messages').insert({
            sender_id: currentUser.id,
            receiver_id: otherUserId,
            image_url: urlData.publicUrl,
            is_read: false
        });
        
        hideActionSpinner();

        if (insertError) {
            showToast('خطا در ارسال تصویر.', 'error');
            console.error(insertError);
            await db.storage.from(bucketName).remove([fileName]);
        }
    };
    
    const confirmEndChat = (clientId) => {
        const content = 'آیا از پایان دادن به این گفتگو مطمئن هستید؟ با این کار، وضعیت نوبت به "پایان‌یافته" تغییر می‌کند و کاربر می‌تواند برای شما نظر ثبت کند.';
        const actions = [{
            text: 'بله، پایان بده',
            className: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700',
            handler: `endChat('${clientId}')`
        }];
        showModal('تایید پایان گفتگو', content, actions);
    };

    const endChat = async (clientId) => {
        closeModal();
        showActionSpinner();
        
        const { data: appointment, error: aptError } = await db
            .from('appointments')
            .select('id')
            .eq('therapist_id', currentUser.id)
            .eq('client_id', clientId)
            .eq('status', 'confirmed')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        if (aptError || !appointment) {
            hideActionSpinner();
            showToast('نوبت تایید شده‌ای برای این کاربر یافت نشد.', 'error');
            return;
        }

        const { error: updateError } = await db
            .from('appointments')
            .update({ status: 'completed' })
            .eq('id', appointment.id);

        hideActionSpinner();
        if (updateError) {
            showToast('خطا در پایان دادن به گفتگو.', 'error');
        } else {
            showToast('گفتگو با موفقیت پایان یافت.', 'success');
            goBackFromChat();
            renderTherapistDashboard();
        }
    };


    // =================================================================
    // ADMIN-SIDE RENDERING & LOGIC
    // =================================================================
    const renderAdminDashboard = async () => {
        const page = document.getElementById('admin-dashboard-page');
        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">پنل مدیریت ساینو</h1>
                
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">تنظیمات سیستم</h2>
                    <div class="flex justify-between items-center">
                        <span>فعال‌سازی قابلیت‌های هوش مصنوعی (Gemini)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="ai-toggle" class="sr-only peer" ${aiFeaturesEnabled ? 'checked' : ''}>
                          <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-teal-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">لیست کاربران</h2>
                    <div id="admin-user-list" class="space-y-2">
                        <p>در حال بارگذاری...</p>
                    </div>
                </div>
                 <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">خروج</button>
            </div>
        `;
        
        document.getElementById('ai-toggle').addEventListener('change', (e) => {
            aiFeaturesEnabled = e.target.checked;
            showToast(`ویژگی‌های هوش مصنوعی ${aiFeaturesEnabled ? 'فعال' : 'غیرفعال'} شد.`, 'info');
        });

        await loadAllUsersForAdmin();
        lucide.createIcons();
    };
    
    const loadAllUsersForAdmin = async () => {
        const listEl = document.getElementById('admin-user-list');
        const { data, error } = await db.from('profiles').select('*');
        if(error) {
            listEl.innerHTML = '<p class="text-red-500">خطا در بارگذاری کاربران.</p>';
            return;
        }
        listEl.innerHTML = data.map(user => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div>
                    <p class="font-semibold">${user.full_name}</p>
                    <p class="text-sm text-gray-500">${user.email}</p>
                </div>
                <span class="text-sm font-semibold px-3 py-1 rounded-full ${user.role === 'client' ? 'bg-green-100 text-green-800' : (user.role === 'therapist' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800')}">${user.role}</span>
            </div>
        `).join('');
    };

    // =================================================================
    // GLOBALLY ACCESSIBLE FUNCTIONS
    // =================================================================
    window.navigateTo = navigateTo;
    window.closeModal = closeModal;
    window.handleLogout = handleLogout;
    window.handleQuickLogin = handleQuickLogin; // Make quick login globally accessible
    window.submitMood = submitMood;
    window.submitJournal = submitJournal;
    window.openAiChat = openAiChat;
    window.sendAiChatMessage = sendAiChatMessage;
    window.startTest = startTest;
    window.submitTest = submitTest;
    window.resetTestsPage = resetTestsPage;
    window.bookAppointment = bookAppointment;
    window.cancelAppointment = cancelAppointment;
    window.openProfileEditor = openProfileEditor;
    window.showSupportRequest = showSupportRequest;
    window.viewTestHistory = viewTestHistory;
    window.updateTherapistProfile = updateTherapistProfile;
    window.viewClientDetails = viewClientDetails;
    window.startChatWith = startChatWith;
    window.goBackFromChat = goBackFromChat;
    window.navigateToTraining = navigateToTraining;
    window.goBackFromTraining = goBackFromTraining;
    window.editJournalEntry = editJournalEntry;
    window.updateJournalEntry = updateJournalEntry;
    window.confirmDeleteJournalEntry = confirmDeleteJournalEntry;
    window.deleteJournalEntry = deleteJournalEntry;
    window.uploadProfilePicture = uploadProfilePicture;
    window.showAvailableSlots = showAvailableSlots;
    window.addAvailableSlot = addAvailableSlot;
    window.deleteAvailableSlot = deleteAvailableSlot;
    window.handleAppointmentConfirmation = handleAppointmentConfirmation;
    window.showRatingModal = showRatingModal;
    window.submitReview = submitReview;
    window.confirmEndChat = confirmEndChat;
    window.endChat = endChat;

</script>
</body>
</html>
