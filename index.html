<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§ÛŒÙ†Ùˆ - Ø¯Ø³ØªÛŒØ§Ø± Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        .page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f2f5;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 6rem; /* 4rem for nav + 2rem space */
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .page.active.flex-layout {
            display: flex;
            flex-direction: column;
            height: 100%; 
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 4rem; /* h-16 */
            transition: transform 0.3s ease-in-out;
        }
        
        .bottom-nav.hidden {
            transform: translateY(100%);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.visible {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .pdp-group {
            direction: ltr;
        }

        #loading-spinner {
            display: none; /* Hidden by default */
        }
        #loading-spinner.visible {
            display: flex;
        }
        #loading-spinner .loader {
            width: 50px;
            height: 50px;
            display: grid;
            animation: s4 4s infinite;
        }
        #loading-spinner .loader::before,
        #loading-spinner .loader::after {
            content: "";
            grid-area: 1/1;
            border: 8px solid;
            border-radius: 50%;
            border-color: #14B8A6 #14B8A6 #0000 #0000;
            mix-blend-mode: darken;
            animation: s4 1s infinite linear;
        }
        #loading-spinner .loader::after {
            border-color: #0000 #0000 #3b82f6 #3b82f6;
            animation-direction: reverse;
        }
        @keyframes s4 {
            100% {
                transform: rotate(1turn);
            }
        }
        
        /* Star rating styles */
        .star-rating .star {
            cursor: pointer;
            color: #d1d5db; /* gray-300 */
            transition: color 0.2s;
        }
        .star-rating .star:hover,
        .star-rating .star.selected {
            color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- LOGIN PERSISTENCE FIX: Spinner is visible by default -->
    <div id="loading-spinner" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="loader"></div>
    </div>

    <div id="modal-container" class="modal-backdrop"></div>

    <!-- LOGIN PERSISTENCE FIX: Auth page is hidden by default -->
    <div id="auth-page" class="page hidden bg-gradient-to-br from-teal-400 to-blue-500">
        <div class="w-full h-full flex items-center justify-center">
            <div class="w-full max-w-md m-auto p-8">
                <div class="text-center mb-10">
                    <h1 class="text-5xl font-bold text-white">Ø³Ø§ÛŒÙ†Ùˆ</h1>
                    <p class="text-white/80 mt-2">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§</p>
                </div>
                
                <div id="login-form-container">
                    <form id="login-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-6">
                        <h2 class="text-2xl font-bold text-white text-center">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-white">Ø§ÛŒÙ…ÛŒÙ„</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-white">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">ÙˆØ±ÙˆØ¯</button>
                        <p class="text-center text-sm text-white">
                            Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="#" id="show-signup" class="font-bold hover:underline">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯</a>
                        </p>
                    </form>
                </div>

                <div id="signup-form-container" class="hidden">
                    <form id="signup-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-bold text-white text-center">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</h2>
                        <div>
                            <label for="signup-fullname" class="block text-sm font-medium text-white">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                            <input type="text" id="signup-fullname" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-white">Ø§ÛŒÙ…ÛŒÙ„</label>
                            <input type="email" id="signup-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-white">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                            <input type="password" id="signup-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-role" class="block text-sm font-medium text-white">Ù†Ù‚Ø´ Ø´Ù…Ø§</label>
                            <select id="signup-role" class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 focus:ring-2 focus:ring-white">
                                <option value="client">Ù…Ø±Ø§Ø¬Ø¹</option>
                                <option value="therapist">Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                        <p class="text-center text-sm text-white">
                            Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ <a href="#" id="show-login" class="font-bold hover:underline">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <!-- Client Pages -->
        <div id="client-dashboard-page" class="page"></div>
        <div id="client-tests-page" class="page"></div>
        <div id="client-appointments-page" class="page"></div>
        <div id="client-profile-page" class="page"></div>
        
        <!-- New Training Page -->
        <div id="training-page" class="page flex-layout"></div>

        <!-- Therapist Pages -->
        <div id="therapist-dashboard-page" class="page"></div>
        <div id="therapist-clients-page" class="page"></div>
        <div id="therapist-schedule-page" class="page"></div>
        <div id="therapist-profile-page" class="page"></div>
        
        <!-- Shared Pages -->
        <div id="chat-page" class="page"></div>

        <!-- Admin Page -->
        <div id="admin-dashboard-page" class="page"></div>
        
        <div id="bottom-nav-bar" class="bottom-nav bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        </div>
    </div>

<script type="module">
    // =================================================================
    // CONFIGURATION
    // =================================================================
    const SUPABASE_URL = 'https://atrhsfozgnfhhbfxgsnu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cmhzZm96Z25maGhiZnhnc251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjQ3MTYsImV4cCI6MjA2NjQ0MDcxNn0.eGODASElOsWJZ_cXmumZZwdQlcBGahm89n2UCuUxWk8';
    const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // Replace with your actual key
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
    
    // =================================================================
    // INITIALIZATION
    // =================================================================
    const { createClient } = supabase;
    // LOGIN PERSISTENCE FIX: Explicitly configure session persistence.
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
            persistSession: true,
            autoRefreshToken: true,
            detectSessionInUrl: true,
            storage: window.localStorage,
        },
    });
    
    let currentUser = null;
    let userProfile = null;
    let aiFeaturesEnabled = true;
    let chatSubscription = null;
    let moodChartInstance = null;
    let clientMoodChartInstance = null;
    let lastPageId = 'client-dashboard-page';

    // =================================================================
    // UTILITY & HELPER FUNCTIONS
    // =================================================================
    
    const defaultAvatarSvg = (bgColor = 'bg-gray-200', iconColor = 'text-gray-500') => `
        <div class="w-full h-full flex items-center justify-center rounded-full ${bgColor}">
            <svg xmlns="http://www.w3.org/2000/svg" width="60%" height="60%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="${iconColor}"><circle cx="12" cy="8" r="4"/><path d="M12 12c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        </div>
    `;

    const renderAvatar = (containerEl, avatarUrl, options = {}) => {
        const { bgColor = 'bg-teal-100', iconColor = 'text-teal-600' } = options;
        if (avatarUrl) {
            containerEl.innerHTML = `<img src="${avatarUrl}" class="w-full h-full object-cover rounded-full">`;
        } else {
            containerEl.innerHTML = defaultAvatarSvg(bgColor, iconColor);
        }
    };


    const showLoading = () => document.getElementById('loading-spinner').classList.add('visible');
    const hideLoading = () => document.getElementById('loading-spinner').classList.remove('visible');

    const showModal = (title, content, actions = []) => {
        const modalContainer = document.getElementById('modal-container');
        const modalHTML = `
            <div class="modal-content">
                <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                <div class="text-gray-600">${content}</div>
                <div class="flex justify-end gap-2 mt-6">
                    ${actions.map(action => `<button class="${action.className}" onclick="${action.handler}">${action.text}</button>`).join('')}
                    <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" onclick="closeModal()">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = modalHTML;
        modalContainer.classList.add('visible');
    };

    const closeModal = () => {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.classList.remove('visible');
        modalContainer.innerHTML = '';
    };

    const showToast = (message, type = 'success') => {
        const toastColors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        const toast = document.createElement('div');
        toast.className = `fixed top-5 right-5 ${toastColors[type]} text-white py-2 px-4 rounded-lg shadow-lg z-[3000]`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    const navigateTo = (pageId) => {
        const activePage = document.querySelector('.page.active');
        const navBar = document.getElementById('bottom-nav-bar');

        if (activePage && activePage.id !== 'chat-page' && activePage.id !== 'training-page' && pageId !== activePage.id) {
            lastPageId = activePage.id;
        }

        document.querySelectorAll('.page').forEach(page => page.classList.remove('active', 'flex-layout'));
        const targetPage = document.getElementById(pageId);

        if (targetPage) {
            targetPage.classList.add('active');
            if (pageId === 'chat-page' || pageId === 'training-page') {
                targetPage.classList.add('flex-layout');
                navBar.classList.add('hidden');
            } else {
                navBar.classList.remove('hidden');
            }
            targetPage.scrollTop = 0;
        }
        
        const navId = `nav-${pageId.split('-')[1]}`;
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('text-teal-600');
            item.classList.add('text-gray-500');
        });
        const activeNavItem = document.getElementById(navId);
        if (activeNavItem) {
            activeNavItem.classList.remove('text-gray-500');
            activeNavItem.classList.add('text-teal-600');
        }
    };

    const renderStars = (rating, totalRatings = 0) => {
        const r = Math.round(rating * 2) / 2; // Round to nearest 0.5
        let starsHTML = '<div class="flex items-center gap-1">';
        for (let i = 1; i <= 5; i++) {
            if (r >= i) {
                starsHTML += '<i data-lucide="star" class="w-4 h-4 text-amber-400 fill-current"></i>';
            } else if (r === i - 0.5) {
                starsHTML += '<i data-lucide="star-half" class="w-4 h-4 text-amber-400 fill-current"></i>';
            } else {
                starsHTML += '<i data-lucide="star" class="w-4 h-4 text-gray-300"></i>';
            }
        }
        if (totalRatings > 0) {
            starsHTML += `<span class="text-xs text-gray-500 mr-1">(${totalRatings} Ù†Ø¸Ø±)</span>`;
        }
        starsHTML += '</div>';
        return starsHTML;
    };


    // =================================================================
    // AUTHENTICATION
    // =================================================================

    const authPage = document.getElementById('auth-page');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');

    document.getElementById('show-signup').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('signup-form-container').classList.remove('hidden');
    });

    document.getElementById('show-login').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('signup-form-container').classList.add('hidden');
        document.getElementById('login-form-container').classList.remove('hidden');
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await db.auth.signInWithPassword({ email, password });
        if (error) {
            showToast(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`, 'error');
        } else {
            showToast('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯!', 'success');
            // onAuthStateChange will hide the loading spinner and navigate
        }
        // Don't hide loading here, onAuthStateChange will handle it.
    });

    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const fullName = document.getElementById('signup-fullname').value;
        const role = document.getElementById('signup-role').value;

        const { data, error } = await db.auth.signUp({
            email,
            password,
            options: {
                data: {
                    full_name: fullName,
                    role: role 
                }
            }
        });
        
        hideLoading();
        if (error) {
            showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ${error.message}`, 'error');
        } else {
            if (data.user && data.user.identities && data.user.identities.length === 0) {
                 showToast('Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
            } else {
                 showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'info');
            }
        }
    });

    const handleLogout = async () => {
        showLoading();
        const { error } = await db.auth.signOut();
        if (error) {
            showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬: ${error.message}`, 'error');
            hideLoading();
        }
        // onAuthStateChange will handle UI changes and hiding the spinner
    };

    // =================================================================
    // APP INITIALIZATION & ROUTING
    // =================================================================

    // LOGIN PERSISTENCE FIX: Reworked logic for a smoother startup.
    db.auth.onAuthStateChange(async (event, session) => {
        try {
            if (session && session.user) {
                // User is logged in, fetch profile and show the app.
                currentUser = session.user;
                const { data, error } = await db.from('profiles').select('*').eq('id', currentUser.id).single();

                if (error || !data) {
                    console.error("Critical: Profile fetch failed.", error);
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
                    await handleLogout(); 
                    return;
                }

                userProfile = data;
                authPage.classList.remove('active');
                authPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                await setupUIForRole(userProfile.role);

            } else {
                // User is not logged in, show the login page.
                currentUser = null;
                userProfile = null;
                if (chatSubscription) {
                    chatSubscription.unsubscribe();
                    chatSubscription = null;
                }
                appContainer.classList.add('hidden');
                authPage.classList.remove('hidden');
                authPage.classList.add('active');
                document.getElementById('login-form-container').classList.remove('hidden');
                document.getElementById('signup-form-container').classList.add('hidden');
            }
        } catch (err) {
            console.error("Fatal error in onAuthStateChange:", err);
            showToast('ÛŒÚ© Ø®Ø·Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù†Ø´Ø¯Ù‡ Ø±Ø® Ø¯Ø§Ø¯.', 'error');
            authPage.classList.remove('hidden');
            authPage.classList.add('active');
            appContainer.classList.add('hidden');
        } finally {
            // Hide the main loading spinner after everything is decided and rendered.
            hideLoading();
        }
    });


    const setupUIForRole = async (role) => {
        const navBar = document.getElementById('bottom-nav-bar');
        navBar.innerHTML = '';

        if (!['client', 'therapist', 'admin'].includes(role)) {
            showToast(`Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±ÛŒ "${role || 'Ù†Ø§Ù…Ø´Ø®Øµ'}" ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.`, 'error');
            console.error(`Invalid role detected: ${role}`);
            handleLogout();
            return;
        }

        if (role === 'client') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-dashboard-page')">
                        <i data-lucide="home"></i><span class="text-xs">Ø®Ø§Ù†Ù‡</span>
                    </a>
                    <a href="#" id="nav-tests" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-tests-page')">
                        <i data-lucide="file-text"></i><span class="text-xs">ØªØ³Øªâ€ŒÙ‡Ø§</span>
                    </a>
                    <a href="#" id="nav-training" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateToTraining()">
                        <i data-lucide="video"></i><span class="text-xs">Ø¢Ù…ÙˆØ²Ø´</span>
                    </a>
                    <a href="#" id="nav-appointments" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-appointments-page')">
                        <i data-lucide="calendar-days"></i><span class="text-xs">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-profile-page')">
                        <i data-lucide="user"></i><span class="text-xs">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
                    </a>
                </div>
            `;
            await renderClientDashboard();
            await renderClientTests();
            await renderClientAppointments();
            await renderClientProfile();
            navigateTo('client-dashboard-page');
        } else if (role === 'therapist') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-dashboard-page')">
                        <i data-lucide="layout-dashboard"></i><span class="text-xs">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                    </a>
                    <a href="#" id="nav-clients" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-clients-page')">
                        <i data-lucide="users"></i><span class="text-xs">Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</span>
                    </a>
                    <a href="#" id="nav-schedule" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-schedule-page')">
                        <i data-lucide="calendar-clock"></i><span class="text-xs">Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-profile-page')">
                        <i data-lucide="user-cog"></i><span class="text-xs">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
                    </a>
                </div>
            `;
            await renderTherapistDashboard();
            await renderTherapistClients();
            await renderTherapistSchedule();
            await renderTherapistProfile();
            navigateTo('therapist-dashboard-page');
        } else if (role === 'admin') {
            navBar.innerHTML = `<div class="text-center p-4 bg-gray-800 text-white">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</div>`;
            await renderAdminDashboard();
            navigateTo('admin-dashboard-page');
        }
        lucide.createIcons();
    };

    // =================================================================
    // OPTIMIZED: TRAINING SECTION
    // =================================================================
    const navigateToTraining = () => {
        const page = document.getElementById('training-page');
        const navBar = document.getElementById('bottom-nav-bar');
        const activePage = document.querySelector('.page.active');
        
        if (activePage && activePage.id !== 'training-page') {
            lastPageId = activePage.id;
        }

        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

        // OPTIMIZATION: Show a loader while the iframe content is loading.
        page.innerHTML = `
            <header class="bg-white shadow-sm p-4 flex items-center gap-4 flex-shrink-0">
                <button onclick="goBackFromTraining()" class="text-gray-600"><i data-lucide="arrow-right"></i></button>
                <h1 class="font-bold text-lg">Ø¨Ø®Ø´ Ø¢Ù…ÙˆØ²Ø´</h1>
            </header>
            <div id="training-content-area" class="flex-grow relative bg-gray-100">
                <div id="training-loader" class="absolute inset-0 flex items-center justify-center">
                    <div class="loader"></div>
                </div>
                <iframe id="training-iframe" class="w-full h-full border-0" style="visibility: hidden;"></iframe>
            </div>
        `;
        lucide.createIcons();
        page.classList.add('active', 'flex-layout');
        page.style.padding = '0';
        navBar.classList.add('hidden');
        
        const iframe = document.getElementById('training-iframe');
        const loader = document.getElementById('training-loader');

        // Hide the loader and show the iframe only after it has fully loaded.
        iframe.onload = () => {
            loader.style.display = 'none';
            iframe.style.visibility = 'visible';
        };
        
        // Set the src to start loading the content.
        iframe.src = "https://vids.psynoland.ir/";
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('text-teal-600');
            item.classList.add('text-gray-500');
        });
    };

    const goBackFromTraining = () => {
        const page = document.getElementById('training-page');
        page.classList.remove('active', 'flex-layout');
        page.innerHTML = ''; // Clear content to stop iframe
        page.style.padding = '';

        document.getElementById('bottom-nav-bar').classList.remove('hidden');
        navigateTo(lastPageId);
    };


    // =================================================================
    // AI HELPER
    // =================================================================
    const getAiSuggestion = async (prompt) => {
        if (!aiFeaturesEnabled) {
            return "Ù‚Ø§Ø¨Ù„ÛŒØª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.";
        }
        if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
            return "Ú©Ù„ÛŒØ¯ API Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ… ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.";
        }
        try {
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => null);
                const errorMessage = errorBody?.error?.message || `API request failed with status ${response.status}`;
                throw new Error(errorMessage);
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error("Gemini API Error:", error);
            if (error instanceof TypeError && error.message === 'Failed to fetch') {
                return "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
            }
            return `Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡: ${error.message}`;
        }
    };
    
    // =================================================================
    // CLIENT-SIDE RENDERING & LOGIC
    // =================================================================

    // --- CLIENT: DASHBOARD ---
    const renderClientDashboard = async () => {
        const page = document.getElementById('client-dashboard-page');
        
        const { data: lastAppointment, error: lastAptError } = await db
            .from('appointments')
            .select('status, therapist:therapist_id ( id, full_name, avatar_url )')
            .eq('client_id', currentUser.id)
            .in('status', ['confirmed', 'completed'])
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        let therapistCardHTML = '';
        if (lastAppointment && lastAppointment.therapist) {
            const chatButton = lastAppointment.status === 'confirmed' ? `
                <button onclick="startChatWith('${lastAppointment.therapist.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                    <i data-lucide="message-circle"></i>
                    <span>Ú†Øª</span>
                </button>
            ` : `
                <button class="bg-gray-300 text-gray-600 px-4 py-2 rounded-lg font-semibold cursor-not-allowed flex items-center gap-2">
                    <i data-lucide="message-circle-off"></i>
                    <span>Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØªÙ‡</span>
                </button>
            `;

            therapistCardHTML = `
            <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-full overflow-hidden" id="dashboard-therapist-avatar"></div>
                    <div>
                        <p class="text-sm text-gray-500">Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ Ø´Ù…Ø§</p>
                        <p class="font-bold text-lg">${lastAppointment.therapist.full_name}</p>
                    </div>
                </div>
                ${chatButton}
            </div>
            `;
        } else {
             therapistCardHTML = `
            <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                 <p class="font-semibold mb-2">Ù‡Ù†ÙˆØ² Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                 <p class="text-sm text-gray-600 mb-4">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯ÙˆØŒ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù†ÙˆØ¨Øª Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒØ¯.</p>
                 <button onclick="navigateTo('client-appointments-page')" class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold">Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª</button>
            </div>
            `;
        }

        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Ø³Ù„Ø§Ù…ØŒ ${userProfile.full_name.split(' ')[0]}!</h1>
                        <p class="text-gray-500">Ø­Ø§Ù„Øª Ø§Ù…Ø±ÙˆØ² Ú†Ø·ÙˆØ±Ù‡ØŸ</p>
                    </div>
                    <button onclick="navigateTo('client-profile-page')" id="dashboard-profile-avatar" class="w-14 h-14 rounded-full overflow-hidden"></button>
                </div>

                ${therapistCardHTML}

                <div id="health-score-card" class="bg-white p-4 rounded-2xl shadow-md text-center">
                    <p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§...</p>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ø«Ø¨Øª Ø­Ø§Ù„ Ø§Ù…Ø±ÙˆØ²</h2>
                    <div class="flex justify-around items-center">
                        ${[
                            { emoji: 'ğŸ˜”', score: 1, label: 'Ø®ÛŒÙ„ÛŒ Ø¨Ø¯' },
                            { emoji: 'ğŸ˜Ÿ', score: 2, label: 'Ø¨Ø¯' },
                            { emoji: 'ğŸ˜', score: 3, label: 'Ù…Ø¹Ù…ÙˆÙ„ÛŒ' },
                            { emoji: 'ğŸ™‚', score: 4, label: 'Ø®ÙˆØ¨' },
                            { emoji: 'ğŸ˜„', score: 5, label: 'Ø¹Ø§Ù„ÛŒ' }
                        ].map(mood => `
                            <button onclick="submitMood(${mood.score})" class="flex flex-col items-center space-y-1 text-gray-600 hover:text-teal-600 transition">
                                <span class="text-4xl">${mood.emoji}</span>
                                <span class="text-xs">${mood.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ù‡ÙØªÙ‡</h2>
                    <div class="relative h-64">
                        <canvas id="moodChart"></canvas>
                    </div>
                </div>
                
                <div id="ai-helper-card" class="bg-gradient-to-r from-blue-500 to-cyan-400 p-4 rounded-2xl shadow-lg text-white">
                    <h2 class="font-bold text-lg mb-2">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§ÛŒÙ†Ùˆ</h2>
                    <p class="text-sm mb-4">Ù†ÛŒØ§Ø² Ø¨Ù‡ ØµØ­Ø¨Øª Ø¯Ø§Ø±ÛŒØŸ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø§ Ù‡Ù…ÛŒØ´Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù…Ú© Ø¨Ù‡ ØªÙˆØ³Øª.</p>
                    <button onclick="openAiChat()" class="bg-white/30 w-full py-2 rounded-lg font-semibold hover:bg-white/50 transition">Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ</button>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-2">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
                    <p class="text-sm text-gray-500 mb-3">Ø§ÙÚ©Ø§Ø±Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³. Ø§ÛŒÙ† ÛŒÚ© ÙØ¶Ø§ÛŒ Ú©Ø§Ù…Ù„Ø§ Ø´Ø®ØµÛŒÙ‡.</p>
                    <textarea id="journal-input" class="w-full h-24 p-2 border rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="Ø§Ù…Ø±ÙˆØ² Ú†Ù‡ Ú¯Ø°Ø´Øª..."></textarea>
                    <button onclick="submitJournal()" class="mt-2 w-full bg-teal-500 text-white py-2 rounded-lg font-semibold hover:bg-teal-600 transition">Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</button>
                    
                    <div id="journal-history-title" class="font-bold text-lg mb-2 mt-6">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±</div>
                    <div id="journal-history" class="space-y-3"></div>
                </div>
            </div>
        `;
        
        renderAvatar(document.getElementById('dashboard-profile-avatar'), userProfile.avatar_url);
        if (lastAppointment && lastAppointment.therapist) {
            renderAvatar(document.getElementById('dashboard-therapist-avatar'), lastAppointment.therapist.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
        }

        await calculateAndDisplayHealthScore();
        await loadMoodChart();
        await loadJournalEntries();
        lucide.createIcons();
    };
    
    const calculateAndDisplayHealthScore = async () => {
        const scoreCard = document.getElementById('health-score-card');
        if (!scoreCard) return;

        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', thirtyDaysAgo);

        if (error || !data || data.length === 0) {
            scoreCard.innerHTML = `
                <h2 class="font-bold text-lg mb-1">Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù†</h2>
                <p class="text-gray-500 text-sm">Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</p>
            `;
            return;
        }

        const totalScore = data.reduce((acc, entry) => acc + entry.mood_score, 0);
        const averageScore = totalScore / data.length;
        const healthScore = Math.round((averageScore / 5) * 100);

        let scoreDescription = '';
        let scoreColor = '';
        if (healthScore >= 80) {
            scoreDescription = 'Ø¹Ø§Ù„ÛŒ! Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒâ€ŒØ±Ø³Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®ÙˆØ¨ÛŒ Ø±Ø§ Ø³Ù¾Ø±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.';
            scoreColor = 'text-green-500';
        } else if (healthScore >= 60) {
            scoreDescription = 'Ø®ÙˆØ¨. ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯.';
            scoreColor = 'text-teal-500';
        } else if (healthScore >= 40) {
            scoreDescription = 'Ù…ØªÙˆØ³Ø·. Ù…Ø±Ø§Ù‚Ø¨ Ø®ÙˆØ¯ Ø¨Ø§Ø´ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø§Ø­Ø³Ø§Ø³ØªØ§Ù† ØªÙˆØ¬Ù‡ Ú©Ù†ÛŒØ¯.';
            scoreColor = 'text-yellow-500';
        } else {
            scoreDescription = 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡. ØµØ­Ø¨Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙÛŒØ¯ Ø¨Ø§Ø´Ø¯.';
            scoreColor = 'text-red-500';
        }

        scoreCard.innerHTML = `
            <h2 class="font-bold text-lg mb-2">Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† (Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±)</h2>
            <p class="text-5xl font-bold ${scoreColor}">${healthScore}<span class="text-2xl text-gray-400">/Û±Û°Û°</span></p>
            <p class="text-gray-600 mt-2 text-sm">${scoreDescription}</p>
        `;
    };

    const submitMood = async (score) => {
        showLoading();
        const { error } = await db.from('mood_entries').insert({ user_id: currentUser.id, mood_score: score });
        hideLoading();
        if (error) {
            showToast('Ø§Ù…Ø±ÙˆØ² Ù‚Ø¨Ù„Ø§ Ø­Ø§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.', 'error');
        } else {
            showToast('Ø­Ø§Ù„ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
            await loadMoodChart();
            await calculateAndDisplayHealthScore();
        }
    };

    const loadMoodChart = async () => {
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('created_at, mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', sevenDaysAgo)
            .order('created_at', { ascending: true });

        if (error) {
            console.error("Eror loading mood data:", error);
            return;
        }

        const labels = data.map(d => new persianDate(new Date(d.created_at)).format('dddd'));
        const scores = data.map(d => d.mood_score);

        const canvasEl = document.getElementById('moodChart');
        if (!canvasEl) return;
        const ctx = canvasEl.getContext('2d');
        
        if (moodChartInstance) {
            moodChartInstance.destroy();
        }

        moodChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ',
                    data: scores,
                    fill: true,
                    backgroundColor: 'rgba(20, 184, 166, 0.2)',
                    borderColor: 'rgb(20, 184, 166)',
                    pointBackgroundColor: 'rgb(20, 184, 166)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(20, 184, 166)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: { line: { borderWidth: 3 } },
                scales: {
                    r: {
                        angleLines: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        pointLabels: { font: { family: "'Vazirmatn', sans-serif", size: 12 } },
                        ticks: { stepSize: 1, display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    // --- Journal Functions ---
    const submitJournal = async () => {
        const content = document.getElementById('journal-input').value;
        if (!content.trim()) {
            showToast('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ†ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }
        showLoading();
        const { error } = await db.from('journal_entries').insert({ user_id: currentUser.id, content: content });
        hideLoading();
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª.', 'error');
        } else {
            showToast('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
            document.getElementById('journal-input').value = '';
            await loadJournalEntries(); // Refresh the list
        }
    };

    const loadJournalEntries = async () => {
        const historyContainer = document.getElementById('journal-history');
        if (!historyContainer) return;

        historyContainer.innerHTML = '<p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§...</p>';

        const { data, error } = await db
            .from('journal_entries')
            .select('id, content, created_at')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(10);

        if (error) {
            console.error('Error loading journal entries:', error);
            historyContainer.innerHTML = '<p class="text-red-500 text-center">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§.</p>';
            return;
        }

        if (data.length === 0) {
            historyContainer.innerHTML = '<p class="text-center text-gray-500">Ù‡Ù†ÙˆØ² ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>';
            return;
        }

        historyContainer.innerHTML = data.map(entry => `
            <div class="bg-gray-50 p-3 rounded-lg border" id="journal-entry-${entry.id}">
                <p class="text-xs text-gray-500 mb-2">${new persianDate(new Date(entry.created_at)).format('dddd D MMMM HH:mm')}</p>
                <p class="text-gray-700 whitespace-pre-wrap">${entry.content}</p>
                <div class="flex justify-end gap-2 mt-2">
                    <button onclick="editJournalEntry(${entry.id})" class="p-1 text-blue-600 hover:text-blue-800"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="confirmDeleteJournalEntry(${entry.id})" class="p-1 text-red-600 hover:text-red-800"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
        `).join('');
        lucide.createIcons();
    };

    const editJournalEntry = async (entryId) => {
        const { data: entry, error } = await db.from('journal_entries').select('content').eq('id', entryId).single();
        if (error || !entry) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª.', 'error');
            return;
        }

        const contentHTML = `<textarea id="edit-journal-textarea" class="w-full h-48 p-2 border rounded-lg">${entry.content}</textarea>`;
        const actions = [{
            text: 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª',
            className: 'px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600',
            handler: `updateJournalEntry(${entryId})`
        }];

        showModal('ÙˆÛŒØ±Ø§ÛŒØ´ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª', contentHTML, actions);
    };

    const updateJournalEntry = async (entryId) => {
        const newContent = document.getElementById('edit-journal-textarea').value;
        if (!newContent.trim()) {
            showToast('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯.', 'error');
            return;
        }
        closeModal();
        showLoading();
        const { error } = await db.from('journal_entries').update({ content: newContent }).eq('id', entryId);
        hideLoading();
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª.', 'error');
        } else {
            showToast('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
            await loadJournalEntries();
        }
    };

    const confirmDeleteJournalEntry = (entryId) => {
        const content = 'Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.';
        const actions = [{
            text: 'Ø­Ø°Ù Ú©Ù†',
            className: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700',
            handler: `deleteJournalEntry(${entryId})`
        }];
        showModal('ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù', content, actions);
    };

    const deleteJournalEntry = async (entryId) => {
        closeModal();
        showLoading();
        const { error } = await db.from('journal_entries').delete().eq('id', entryId);
        hideLoading();
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÛŒØ§Ø¯Ø¯Ø§Ø´Øª.', 'error');
        } else {
            showToast('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø­Ø°Ù Ø´Ø¯.', 'success');
            const entryElement = document.getElementById(`journal-entry-${entryId}`);
            if(entryElement) {
                entryElement.style.transition = 'opacity 0.5s, transform 0.5s';
                entryElement.style.opacity = '0';
                entryElement.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    entryElement.remove();
                    // Check if the list is empty now
                    const historyContainer = document.getElementById('journal-history');
                    if (!historyContainer.hasChildNodes()) {
                         historyContainer.innerHTML = '<p class="text-center text-gray-500">Ù‡Ù†ÙˆØ² ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>';
                    }
                }, 500);
            }
        }
    };
    
    const openAiChat = () => {
        const content = `
            <div id="ai-chat-history" class="h-64 overflow-y-auto p-2 bg-gray-100 rounded-lg mb-3 border">
                <div class="text-gray-500 text-center p-4">Ø³Ù„Ø§Ù…! Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§ÛŒÙ†Ùˆ Ù‡Ø³ØªÙ…. Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ</div>
            </div>
            <div class="flex gap-2">
                <input id="ai-chat-input" type="text" class="flex-grow p-2 border rounded-lg" placeholder="Ù¾ÛŒØ§Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³...">
                <button onclick="sendAiChatMessage()" class="p-2 bg-teal-500 text-white rounded-lg"><i data-lucide="send"></i></button>
            </div>
        `;
        showModal('Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯', content);
        lucide.createIcons();
    };

    const sendAiChatMessage = async () => {
        const input = document.getElementById('ai-chat-input');
        const history = document.getElementById('ai-chat-history');
        const userMessage = input.value.trim();
        if (!userMessage) return;

        history.innerHTML += `<div class="text-left my-1"><span class="bg-blue-500 text-white p-2 rounded-lg inline-block">${userMessage}</span></div>`;
        input.value = '';
        history.scrollTop = history.scrollHeight;
        
        const thinking = document.createElement('div');
        thinking.className = "text-right my-1";
        thinking.innerHTML = `<span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">...Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†</span>`;
        history.appendChild(thinking);
        history.scrollTop = history.scrollHeight;

        const aiResponse = await getAiSuggestion(userMessage);
        
        thinking.remove();
        history.innerHTML += `<div class="text-right my-1"><span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">${aiResponse}</span></div>`;
        history.scrollTop = history.scrollHeight;
    };

    // --- CLIENT: TESTS ---
    const psychologicalTests = [
        { id: 'phq9', name: 'ØªØ³Øª Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ (PHQ-9)', questions: [
            "Ø¹Ø¯Ù… Ø¹Ù„Ø§Ù‚Ù‡ ÛŒØ§ Ù„Ø°Øª Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø±Ù‡Ø§", "Ø§Ø­Ø³Ø§Ø³ Ù†Ø§Ø±Ø§Ø­ØªÛŒØŒ Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ ÛŒØ§ Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ", "Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¨Ù‡ Ø®ÙˆØ§Ø¨ Ø±ÙØªÙ†ØŒ Ø¯Ø± Ø®ÙˆØ§Ø¨ Ù…Ø§Ù†Ø¯Ù† ÛŒØ§ Ø®ÙˆØ§Ø¨ Ø²ÛŒØ§Ø¯", "Ø§Ø­Ø³Ø§Ø³ Ø®Ø³ØªÚ¯ÛŒ ÛŒØ§ Ú©Ù…Ø¨ÙˆØ¯ Ø§Ù†Ø±Ú˜ÛŒ", "Ú©Ù… Ø§Ø´ØªÙ‡Ø§ÛŒÛŒ ÛŒØ§ Ù¾Ø±Ø®ÙˆØ±ÛŒ", "Ø§Ø­Ø³Ø§Ø³ Ø¨Ø¯ÛŒ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø®ÙˆØ¯ØŒ ÛŒØ§ Ø§ÛŒÙ†Ú©Ù‡ ÛŒÚ© Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯Ù‡ Ù‡Ø³ØªÛŒØ¯", "Ù…Ø´Ú©Ù„ Ø¯Ø± ØªÙ…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† Ø±ÙˆÛŒ Ú©Ø§Ø±Ù‡Ø§", "Ú©Ù†Ø¯ Ø´Ø¯Ù† Ø¯Ø± Ø­Ø±Ú©Øª ÛŒØ§ ØµØ­Ø¨Øª Ú©Ø±Ø¯Ù†ØŒ ÛŒØ§ Ø¨Ø±Ø¹Ú©Ø³ Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø±ÛŒ", "Ø§ÙÚ©Ø§Ø± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø¨Ù…ÛŒØ±ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ Ø®ÙˆØ¯ Ø¢Ø³ÛŒØ¨ Ø¨Ø²Ù†ÛŒØ¯"
        ], options: ["Ø§ØµÙ„Ø§", "Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ²", "Ø¨ÛŒØ´ Ø§Ø² Ù†ÛŒÙ…ÛŒ Ø§Ø² Ø±ÙˆØ²Ù‡Ø§", "ØªÙ‚Ø±ÛŒØ¨Ø§ Ù‡Ø± Ø±ÙˆØ²"], interpretation: (score) => {
            if (score <= 4) return "Ø¹Ù„Ø§Ø¦Ù… Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø­Ø¯Ø§Ù‚Ù„ÛŒ ÛŒØ§ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¢Ù†. ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§ Ø®ÙˆØ¨ Ø§Ø³Øª.";
            if (score <= 9) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø®ÙÛŒÙ. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.";
            if (score <= 14) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ù…ØªÙˆØ³Ø·. Ù…Ø´ÙˆØ±Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.";
            if (score <= 19) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ù†Ø³Ø¨ØªØ§ Ø´Ø¯ÛŒØ¯. Ø­ØªÙ…Ø§ Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯.";
            return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø´Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÙÙˆØ±Ø§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù…Ú© Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯.";
        }},
        { id: 'gad7', name: 'ØªØ³Øª Ø§Ø¶Ø·Ø±Ø§Ø¨ (GAD-7)', questions: [
            "Ø§Ø­Ø³Ø§Ø³ Ø¹ØµØ¨Ø§Ù†ÛŒØªØŒ Ø§Ø¶Ø·Ø±Ø§Ø¨ ÛŒØ§ Ø¯Ù„Ø´ÙˆØ±Ù‡", "Ø¹Ø¯Ù… ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø¯Ø± Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† ÛŒØ§ Ú©Ù†ØªØ±Ù„ Ù†Ú¯Ø±Ø§Ù†ÛŒ", "Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ú†ÛŒØ²Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù", "Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¢Ø±Ø§Ù… Ø´Ø¯Ù†", "Ø¢Ù†Ù‚Ø¯Ø± Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø± Ø¨ÙˆØ¯Ù† Ú©Ù‡ Ù†Ø´Ø³ØªÙ† Ø³Ø®Øª Ø§Ø³Øª", "Ø²ÙˆØ¯Ø±Ù†Ø¬ ÛŒØ§ ØªØ­Ø±ÛŒÚ©â€ŒÙ¾Ø°ÛŒØ± Ø´Ø¯Ù†", "Ø§Ø­Ø³Ø§Ø³ ØªØ±Ø³ØŒ Ø§Ù†Ú¯Ø§Ø± Ú©Ù‡ Ø§ØªÙØ§Ù‚ ÙˆØ­Ø´ØªÙ†Ø§Ú©ÛŒ Ù‚Ø±Ø§Ø± Ø§Ø³Øª Ø¨ÛŒÙØªØ¯"
        ], options: ["Ø§ØµÙ„Ø§", "Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ²", "Ø¨ÛŒØ´ Ø§Ø² Ù†ÛŒÙ…ÛŒ Ø§Ø² Ø±ÙˆØ²Ù‡Ø§", "ØªÙ‚Ø±ÛŒØ¨Ø§ Ù‡Ø± Ø±ÙˆØ²"], interpretation: (score) => {
            if (score <= 4) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø­Ø¯Ø§Ù‚Ù„ÛŒ. ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§ Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³Øª.";
            if (score <= 9) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø®ÙÛŒÙ. Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ø®ÙˆØ¯ Ø±Ø§ ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯.";
            if (score <= 14) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…ØªÙˆØ³Ø·. Ù…Ø´ÙˆØ±Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙÛŒØ¯ Ø¨Ø§Ø´Ø¯.";
            return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø´Ø¯ÛŒØ¯. ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¯Ø±Ù…Ø§Ù† Ø¨Ù‡ Ù…ØªØ®ØµØµ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.";
        }}
    ];

    const renderClientTests = async () => {
        const page = document.getElementById('client-tests-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ</h1>
                <div id="test-list" class="space-y-4">
                    ${psychologicalTests.map(test => `
                        <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-lg">${test.name}</h2>
                                <p class="text-sm text-gray-500">${test.questions.length} Ø³ÙˆØ§Ù„</p>
                            </div>
                            <button onclick="startTest('${test.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold">Ø´Ø±ÙˆØ¹</button>
                        </div>
                    `).join('')}
                </div>
                <div id="test-container" class="hidden mt-6 bg-white p-4 rounded-2xl shadow-md"></div>
            </div>
        `;
        lucide.createIcons();
    };

    const startTest = (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        const testContainer = document.getElementById('test-container');
        document.getElementById('test-list').classList.add('hidden');
        testContainer.classList.remove('hidden');
        
        let questionsHTML = `<h2 class="text-xl font-bold mb-4">${test.name}</h2>`;
        test.questions.forEach((q, index) => {
            questionsHTML += `
                <div class="mb-6">
                    <p class="font-semibold mb-2">${index + 1}. ${q}</p>
                    <div class="flex flex-wrap gap-2">
                        ${test.options.map((opt, optIndex) => `
                            <label class="flex items-center space-x-2 space-x-reverse border p-2 rounded-lg cursor-pointer">
                                <input type="radio" name="q${index}" value="${optIndex}" class="form-radio text-teal-500">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        questionsHTML += `<button onclick="submitTest('${testId}')" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ØªÛŒØ¬Ù‡</button>`;
        testContainer.innerHTML = questionsHTML;
    };

    const resetTestsPage = () => {
        document.getElementById('test-list').classList.remove('hidden');
        const testContainer = document.getElementById('test-container');
        testContainer.classList.add('hidden');
        testContainer.innerHTML = '';
    };

    const submitTest = async (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        let score = 0;
        let answeredAll = true;
        for (let i = 0; i < test.questions.length; i++) {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if (selected) {
                score += parseInt(selected.value);
            } else {
                answeredAll = false;
                break;
            }
        }

        if (!answeredAll) {
            showToast('Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø³ÙˆØ§Ù„Ø§Øª Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯.', 'error');
            return;
        }

        const resultText = test.interpretation(score);
        showLoading();
        const { error } = await db.from('test_results').insert({
            user_id: currentUser.id,
            test_name: test.name,
            score: score,
            result_text: resultText
        });
        hideLoading();
        if(error){
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª.', 'error');
        } else {
            showToast('Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
        }

        const testContainer = document.getElementById('test-container');
        testContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª ${test.name}</h2>
            <p class="text-gray-700 mb-2">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: <span class="font-bold">${score}</span></p>
            <p class="text-gray-800 bg-gray-100 p-3 rounded-lg">${resultText}</p>
            <button onclick="resetTestsPage()" class="mt-4 w-full bg-gray-500 text-white py-2 rounded-lg">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ØªØ³Øªâ€ŒÙ‡Ø§</button>
        `;
    };

    // --- CLIENT: APPOINTMENTS (REWORKED) ---
    const renderClientAppointments = async () => {
        const page = document.getElementById('client-appointments-page');
        showLoading();
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</h1>
                <div id="appointments-list" class="space-y-4">
                    <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§...</p>
                </div>
                <div class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯</h2>
                    <div id="therapist-list-container" class="space-y-4">
                        <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³Ø§Ù†...</p>
                    </div>
                </div>
            </div>
        `;
        await loadClientAppointments();
        await renderTherapistListForBooking();
        hideLoading();
        lucide.createIcons();
    };
    
    const loadClientAppointments = async () => {
        const listEl = document.getElementById('appointments-list');
        const { data, error } = await db
            .from('appointments')
            .select(`
                id,
                status,
                type,
                therapist:therapist_id ( id, full_name, avatar_url ),
                slot:slot_id ( id, start_time )
            `)
            .eq('client_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error("Error loading appointments:", error);
            listEl.innerHTML = `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.</p>`;
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù†ÙˆØ¨Øª Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>`;
            return;
        }
        
        const statusMap = {
            pending: { text: 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ§ÛŒÛŒØ¯', color: 'bg-yellow-100 text-yellow-800' },
            confirmed: { text: 'ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡', color: 'bg-blue-100 text-blue-800' },
            completed: { text: 'Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØªÙ‡', color: 'bg-green-100 text-green-800' },
            cancelled: { text: 'Ù„ØºÙˆ Ø´Ø¯Ù‡', color: 'bg-gray-100 text-gray-800' },
            declined: { text: 'Ø±Ø¯ Ø´Ø¯Ù‡', color: 'bg-red-100 text-red-800' }
        };

        listEl.innerHTML = data.map(apt => {
            const container = document.createElement('div');
            container.className = 'bg-white p-4 rounded-2xl shadow-md';
            if (!apt.therapist || !apt.slot) return '';
            
            const statusInfo = statusMap[apt.status] || statusMap.cancelled;
            const appointmentTime = apt.slot.start_time; // Already a formatted string
            const typeText = apt.type === 'in_person' ? 'Ø¬Ù„Ø³Ù‡ Ø­Ø¶ÙˆØ±ÛŒ' : 'Ù…Ú©Ø§Ù„Ù…Ù‡ Ú†Øª';
            const typeColor = apt.type === 'in_person' ? 'text-teal-700' : 'text-sky-700';

            let actionButtons = '';
            if (apt.status === 'confirmed') {
                actionButtons = `<button onclick="startChatWith('${apt.therapist.id}')" class="flex-1 bg-teal-500 text-white py-2 rounded-lg text-sm">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³</button>`;
            }
            if (apt.status === 'pending' || apt.status === 'confirmed') {
                actionButtons += `<button onclick="cancelAppointment(${apt.id}, ${apt.slot.id})" class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm">Ù„ØºÙˆ Ù†ÙˆØ¨Øª</button>`;
            }
            if (apt.status === 'completed') {
                actionButtons = `<button onclick="showRatingModal(${apt.id}, '${apt.therapist.id}')" class="flex-1 bg-amber-500 text-white py-2 rounded-lg text-sm">Ø«Ø¨Øª Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ø¸Ø±</button>`;
            }

            container.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3">
                         <div class="w-12 h-12 rounded-full overflow-hidden" id="apt-therapist-avatar-${apt.id}"></div>
                        <div>
                            <p class="font-bold text-lg">${apt.therapist.full_name}</p>
                            <p class="text-sm text-gray-600">${appointmentTime}</p>
                            <p class="text-xs font-semibold ${typeColor} mt-1">${typeText}</p>
                        </div>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusInfo.color}">${statusInfo.text}</span>
                </div>
                ${actionButtons ? `<div class="mt-4 flex gap-2">${actionButtons}</div>` : ''}
            `;
            
            setTimeout(() => {
                const avatarEl = document.getElementById(`apt-therapist-avatar-${apt.id}`);
                if (avatarEl) {
                    renderAvatar(avatarEl, apt.therapist.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
                }
            }, 0);

            return container.outerHTML;
        }).join('');
        lucide.createIcons();
    };
    
    const renderTherapistListForBooking = async () => {
        const container = document.getElementById('therapist-list-container');
        const { data, error } = await db.from('profiles').select('*').eq('role', 'therapist');

        if (error) {
            container.innerHTML = `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³Ø§Ù†.</p>`;
            return;
        }
        
        if (data.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù‡ÛŒÚ† Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª.</p>`;
            return;
        }

        container.innerHTML = data.map(t => `
            <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full overflow-hidden" id="therapist-list-avatar-${t.id}"></div>
                    <div>
                        <h3 class="font-bold text-lg">${t.full_name}</h3>
                        <p class="text-sm text-gray-500">${t.specialization || 'ØªØ®ØµØµ Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                        ${renderStars(t.average_rating || 0, t.total_ratings || 0)}
                    </div>
                </div>
                <button onclick="showAvailableSlots('${t.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold">Ø§Ù†ØªØ®Ø§Ø¨</button>
            </div>
        `).join('');

        data.forEach(t => {
            const avatarEl = document.getElementById(`therapist-list-avatar-${t.id}`);
            if (avatarEl) {
                renderAvatar(avatarEl, t.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
            }
        });

        lucide.createIcons();
    };

    const showAvailableSlots = async (therapistId) => {
        showLoading();
        const { data: slots, error } = await db
            .from('available_slots')
            .select('*')
            .eq('therapist_id', therapistId)
            .eq('is_booked', false)
            .order('start_time', { ascending: true });
        
        const { data: therapist, error: tError } = await db.from('profiles').select('full_name').eq('id', therapistId).single();
        hideLoading();

        if (error || tError) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ.', 'error');
            console.error(error || tError);
            return;
        }

        let content = '<p class="text-center text-gray-500">Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø§ÛŒÙ† Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ Ø²Ù…Ø§Ù† Ø®Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±Ø¯.</p>';
        if (slots.length > 0) {
            content = `
                <div class="space-y-2">
                    ${slots.map(slot => {
                        const time = slot.start_time; // Already a formatted string
                        const typeText = slot.type === 'in_person' ? 'Ø­Ø¶ÙˆØ±ÛŒ' : 'Ú†Øª';
                        return `
                        <label class="flex justify-between items-center p-3 border rounded-lg cursor-pointer has-[:checked]:bg-teal-50 has-[:checked]:border-teal-500">
                            <div>
                                <p class="font-semibold">${time}</p>
                                <p class="text-sm text-gray-600">Ù†ÙˆØ¹ Ø¬Ù„Ø³Ù‡: ${typeText}</p>
                            </div>
                            <input type="radio" name="slot" value="${slot.id}" data-type="${slot.type}" class="form-radio text-teal-600">
                        </label>
                        `;
                    }).join('')}
                </div>
            `;
        }

        const actions = [{
            text: 'Ø±Ø²Ø±Ùˆ Ù†Ù‡Ø§ÛŒÛŒ',
            className: 'px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600',
            handler: `bookAppointment()`
        }];

        showModal(`Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ ${therapist.full_name}`, content, actions);
    };

    const bookAppointment = async () => {
        const selectedSlot = document.querySelector('input[name="slot"]:checked');
        if (!selectedSlot) {
            showToast('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø²Ù…Ø§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }

        const slotId = selectedSlot.value;
        
        closeModal();
        showLoading();

        const { data, error } = await db.rpc('book_appointment_slot', {
            slot_id_arg: slotId
        });

        hideLoading();

        if (error) {
            if (error.message.includes('SLOT_ALREADY_BOOKED')) {
                showToast('Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ø¨Ù‡ ØªØ§Ø²Ú¯ÛŒ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.', 'error');
            } else if (error.message.includes('SLOT_NOT_FOUND')) {
                showToast('Ø²Ù…Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
            } else {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù†ÙˆØ¨Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
                console.error('RPC Error:', error);
            }
        } else if (data && data.success) {
            showToast('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ§ÛŒÛŒØ¯ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ Ø§Ø³Øª.', 'success');
            await renderClientAppointments();
            await renderClientDashboard();
        } else {
             showToast(data?.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®ØµÛŒ Ø±Ø® Ø¯Ø§Ø¯.', 'error');
        }
    };
    
    const cancelAppointment = async (id, slotId) => {
        showLoading();
        const { error: apptError } = await db.from('appointments').update({ status: 'cancelled' }).eq('id', id);
        if (apptError) {
            hideLoading();
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª.', 'error');
            return;
        }
        
        const { error: slotError } = await db.from('available_slots').update({ is_booked: false }).eq('id', slotId);
        hideLoading();
        
        if(slotError) {
            showToast('Ù†ÙˆØ¨Øª Ù„ØºÙˆ Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø± Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ø²Ù…Ø§Ù† Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.', 'info');
        } else {
            showToast('Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯.', 'success');
        }
        await loadClientAppointments();
    };
    
    const showRatingModal = (appointmentId, therapistId) => {
        let currentRating = 0;
        const content = `
            <p class="mb-4">Ù„Ø·ÙØ§ Ø¨Ù‡ Ø¬Ù„Ø³Ù‡ Ø®ÙˆØ¯ Ø¨Ø§ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ù‡ÛŒØ¯ Ùˆ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.</p>
            <div id="modal-star-rating" class="star-rating flex justify-center text-4xl mb-4">
                ${[1,2,3,4,5].map(i => `<i data-lucide="star" data-value="${i}" class="star"></i>`).join('')}
            </div>
            <textarea id="rating-comment" class="w-full h-24 p-2 border rounded-lg" placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
        `;
        const actions = [{
            text: 'Ø«Ø¨Øª Ù†Ø¸Ø±',
            className: 'px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600',
            handler: `submitReview(${appointmentId}, '${therapistId}')`
        }];
        showModal('Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø¨Ù‡ Ø¬Ù„Ø³Ù‡', content, actions);
        lucide.createIcons();

        const stars = document.querySelectorAll('#modal-star-rating .star');
        stars.forEach(star => {
            star.addEventListener('click', () => {
                currentRating = star.dataset.value;
                window.currentRating = currentRating; // Make it accessible to submitReview
                stars.forEach(s => {
                    s.classList.toggle('selected', s.dataset.value <= currentRating);
                });
            });
        });
    };

    const submitReview = async (appointmentId, therapistId) => {
        const rating = window.currentRating;
        const comment = document.getElementById('rating-comment').value;

        if (!rating || rating === 0) {
            showToast('Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø² (Ø³ØªØ§Ø±Ù‡) Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }
        
        closeModal();
        showLoading();

        const { error } = await db.from('reviews').insert({
            appointment_id: appointmentId,
            client_id: currentUser.id,
            therapist_id: therapistId,
            rating: rating,
            comment: comment
        });

        if (error) {
            hideLoading();
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø¸Ø±. Ø´Ø§ÛŒØ¯ Ù‚Ø¨Ù„Ø§ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´ÛŒØ¯.', 'error');
            console.error(error);
        } else {
            const { error: rpcError } = await db.rpc('update_therapist_rating', { therapist_id_arg: therapistId });
            hideLoading();
            if (rpcError) {
                 showToast('Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ Ø§Ù…Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯.', 'info');
                 console.error("RPC Error:", rpcError);
            } else {
                 showToast('Ù†Ø¸Ø± Ùˆ Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.', 'success');
            }
            await loadClientAppointments();
        }
    };


    // --- CLIENT: PROFILE ---
    const renderClientProfile = async () => {
        const page = document.getElementById('client-profile-page');
        page.innerHTML = `
            <div class="p-4 space-y-6">
                 <div class="flex flex-col items-center space-y-4">
                    <div class="relative w-24 h-24">
                        <div id="profile-page-avatar" class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-lg"></div>
                        <label for="avatar-upload" class="absolute bottom-0 right-0 bg-white p-1.5 rounded-full shadow-md cursor-pointer">
                            <i data-lucide="camera" class="w-5 h-5 text-gray-600"></i>
                            <input id="avatar-upload" type="file" class="hidden" accept="image/*" onchange="uploadProfilePicture(event)">
                        </label>
                    </div>
                    <div class="text-center">
                        <h1 class="text-2xl font-bold text-gray-800">${userProfile.full_name}</h1>
                        <p class="text-gray-500">${currentUser.email}</p>
                    </div>
                </div>

                <div class="bg-white p-2 rounded-2xl shadow-md">
                    <a href="#" onclick="openProfileEditor()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="edit" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <a href="#" onclick="viewTestHistory()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="clipboard-list" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ø³ÙˆØ§Ø¨Ù‚ ØªØ³Øªâ€ŒÙ‡Ø§</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <a href="#" onclick="showSupportRequest()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="headphones" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                     <div class="border-t my-1 mx-2"></div>
                    <a href="#" onclick="handleLogout()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg text-red-500">
                        <div class="flex items-center gap-4">
                            <i data-lucide="log-out"></i>
                            <span class="font-semibold">Ø®Ø±ÙˆØ¬</span>
                        </div>
                    </a>
                </div>
                <p class="text-center text-gray-400 text-sm">Ù†Ø³Ø®Ù‡ Û±.Û·.Û°</p>
            </div>
        `;
        renderAvatar(document.getElementById('profile-page-avatar'), userProfile.avatar_url);
        lucide.createIcons();
    };
    
    const openProfileEditor = () => {
        const content = `
            <div class="space-y-4">
                <div class="space-y-2">
                    <label for="modal-fullname-input" class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                    <input id="modal-fullname-input" type="text" class="w-full p-2 border rounded-lg" value="${userProfile.full_name || ''}">
                </div>
                <div class="space-y-2">
                    <label for="modal-bio-input" class="block text-sm font-medium text-gray-700">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="modal-bio-input" class="w-full h-24 p-2 border rounded-lg" placeholder="Ú©Ù…ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">${userProfile.bio || ''}</textarea>
                </div>
                <button id="save-profile-btn" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </div>
        `;
        showModal('ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ', content);
        
        document.getElementById('save-profile-btn').onclick = async () => {
            const newName = document.getElementById('modal-fullname-input').value;
            const newBio = document.getElementById('modal-bio-input').value;
            
            closeModal(); 
            showLoading();
            const { data, error } = await db.from('profiles').update({ 
                full_name: newName,
                bio: newBio
            }).eq('id', currentUser.id).select().single();
            hideLoading();
            
            if (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.', 'error');
            } else {
                userProfile = data;
                showToast('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
                await renderClientProfile();
            }
        };
    };

    const uploadProfilePicture = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        showLoading();
        const fileName = `${currentUser.id}/${Date.now()}-${file.name}`;
        
        if (userProfile.avatar_url) {
            const oldAvatarPath = userProfile.avatar_url.split('/avatars/')[1];
            if (oldAvatarPath) {
                await db.storage.from('avatars').remove([oldAvatarPath]);
            }
        }

        const { error: uploadError } = await db.storage.from('avatars').upload(fileName, file);
        if (uploadError) {
            hideLoading();
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±.', 'error');
            console.error(uploadError);
            return;
        }

        const { data: urlData } = db.storage.from('avatars').getPublicUrl(fileName);
        const { error: updateError } = await db.from('profiles').update({ avatar_url: urlData.publicUrl }).eq('id', currentUser.id);
        
        hideLoading();
        if (updateError) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ±.', 'error');
        } else {
            userProfile.avatar_url = urlData.publicUrl;
            showToast('Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
            if (userProfile.role === 'client') await renderClientProfile();
            if (userProfile.role === 'therapist') await renderTherapistProfile();
        }
    };

    const showSupportRequest = () => {
        const content = `
            <p class="mb-4">Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ info@psynoland.ir Ø¯Ø± ØªÙ…Ø§Ø³ Ø¨Ø§Ø´ÛŒØ¯ ÛŒØ§ ÙØ±Ù… Ø²ÛŒØ± Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.</p>
            <form id="support-form">
                <textarea class="w-full h-32 p-2 border rounded-lg" placeholder="Ù…Ø´Ú©Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø´Ø±Ø­ Ø¯Ù‡ÛŒØ¯..."></textarea>
                <button type="submit" class="mt-2 w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
            </form>
        `;
        showModal('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', content);
        document.getElementById('support-form').addEventListener('submit', (e) => {
            e.preventDefault();
            closeModal();
            showToast('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯. Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ….', 'success');
        });
    };

    const viewTestHistory = async () => {
        showLoading();
        const { data, error } = await db.from('test_results')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        hideLoading();

        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§', 'error');
            return;
        }

        let content = '<p class="text-center text-gray-500">Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';

        if (data && data.length > 0) {
            content = `
                <div class="space-y-4">
                ${data.map(test => `
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <p class="font-bold">${test.test_name}</p>
                        <p class="text-sm text-gray-500 mb-2">${new persianDate(new Date(test.created_at)).format('L')}</p>
                        <p class="text-sm"><strong>Ø§Ù…ØªÛŒØ§Ø²: ${test.score}</strong> - ${test.result_text}</p>
                    </div>
                `).join('')}
                </div>
            `;
        }
        
        showModal('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§', content);
    };

    // =================================================================
    // THERAPIST-SIDE RENDERING & LOGIC
    // =================================================================

    // --- THERAPIST: DASHBOARD ---
    const renderTherapistDashboard = async () => {
        const page = document.getElementById('therapist-dashboard-page');
        showLoading();
        
        const { data: pendingAppointments, error: pendingError } = await db
            .from('appointments')
            .select('id, type, client:client_id(id, full_name, avatar_url), slot:slot_id(id, start_time)', { count: 'exact' })
            .eq('therapist_id', currentUser.id)
            .eq('status', 'pending');

        const { data: upcomingAppointments, error: upcomingError } = await db
            .from('appointments')
            .select('id, client:client_id(id, full_name), slot:slot_id(start_time)')
            .eq('therapist_id', currentUser.id)
            .eq('status', 'confirmed');

        const { data: clients, error: clientError } = await db.rpc('get_unique_clients_for_therapist', { therapist_id_arg: currentUser.id });
        
        hideLoading();

        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ú©ØªØ± ${userProfile.full_name.split(' ').slice(1).join(' ') || userProfile.full_name}</h1>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-yellow-600">${pendingAppointments?.length || 0}</p>
                        <p class="text-gray-500 text-sm">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-teal-600">${upcomingAppointments?.length || 0}</p>
                        <p class="text-gray-500 text-sm">Ù†ÙˆØ¨Øª Ø¢ÛŒÙ†Ø¯Ù‡</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-blue-600">${clients?.length || 0}</p>
                        <p class="text-gray-500 text-sm">Ú©Ù„ Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯</h2>
                    <div id="pending-appointments-list" class="space-y-3">
                        <!-- Content will be rendered here -->
                    </div>
                </div>
            </div>
        `;
        
        const pendingListEl = document.getElementById('pending-appointments-list');
        if (pendingError) {
            pendingListEl.innerHTML = '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>';
        } else if (pendingAppointments && pendingAppointments.length > 0) {
            pendingListEl.innerHTML = pendingAppointments.map(apt => `
                <div class="bg-gray-50 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full overflow-hidden" id="pending-apt-avatar-${apt.id}"></div>
                            <div>
                                <p class="font-semibold">${apt.client.full_name}</p>
                                <p class="text-sm text-gray-500">${apt.slot.start_time} (${apt.type === 'in_person' ? 'Ø­Ø¶ÙˆØ±ÛŒ' : 'Ú†Øª'})</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="handleAppointmentConfirmation(${apt.id}, true, ${apt.slot.id})" class="p-2 bg-green-100 rounded-lg text-green-600"><i data-lucide="check"></i></button>
                            <button onclick="handleAppointmentConfirmation(${apt.id}, false, ${apt.slot.id})" class="p-2 bg-red-100 rounded-lg text-red-600"><i data-lucide="x"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');

            pendingAppointments.forEach(apt => {
                 const avatarEl = document.getElementById(`pending-apt-avatar-${apt.id}`);
                 if(avatarEl) renderAvatar(avatarEl, apt.client.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
            });

        } else {
            pendingListEl.innerHTML = '<p class="text-center text-gray-500">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>';
        }

        lucide.createIcons();
    };

    const handleAppointmentConfirmation = async (appointmentId, isConfirmed, slotId) => {
        showLoading();
        const newStatus = isConfirmed ? 'confirmed' : 'declined';
        const { error: updateError } = await db.from('appointments').update({ status: newStatus }).eq('id', appointmentId);

        if (updateError) {
            hideLoading();
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª.', 'error');
            return;
        }

        if (!isConfirmed) {
            await db.from('available_slots').update({ is_booked: false }).eq('id', slotId);
        }
        
        hideLoading();
        showToast(`Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ${isConfirmed ? 'ØªØ§ÛŒÛŒØ¯' : 'Ø±Ø¯'} Ø´Ø¯.`, 'success');
        await renderTherapistDashboard();
    };


    // --- THERAPIST: CLIENTS ---
    const renderTherapistClients = async () => {
        const page = document.getElementById('therapist-clients-page');
        showLoading();
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ù„ÛŒØ³Øª Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</h1>
                <div id="client-list-container" class="space-y-3">
                    <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†...</p>
                </div>
            </div>`;

        try {
            const { data: clients, error: rpcError } = await db.rpc('get_unique_clients_for_therapist', { therapist_id_arg: currentUser.id });

            if (rpcError) throw rpcError;

            let clientsHTML = '';
            if (clients && clients.length > 0) {
                clientsHTML = clients.map(client => `
                    <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full overflow-hidden" id="client-list-avatar-${client.id}"></div>
                            <div>
                                <p class="font-bold">${client.full_name}</p>
                                <p class="text-sm text-gray-500">${client.email}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewClientDetails('${client.id}')" class="p-2 bg-gray-100 rounded-lg text-gray-600"><i data-lucide="eye"></i></button>
                            <button onclick="startChatWith('${client.id}')" class="p-2 bg-teal-100 rounded-lg text-teal-600"><i data-lucide="message-square"></i></button>
                        </div>
                    </div>
                `).join('');
                 document.getElementById('client-list-container').innerHTML = clientsHTML;
                 clients.forEach(client => {
                    const avatarEl = document.getElementById(`client-list-avatar-${client.id}`);
                    if (avatarEl) renderAvatar(avatarEl, client.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
                 });
            } else {
                document.getElementById('client-list-container').innerHTML = '<p class="text-center text-gray-500">Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù…Ø±Ø§Ø¬Ø¹Ù‡â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>';
            }
        } catch (error) {
            console.error("Error loading clients:", error);
            document.getElementById('client-list-container').innerHTML = `<p class="text-red-500 text-center">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†.</p>`;
        } finally {
            hideLoading();
            lucide.createIcons();
        }
    };


    const viewClientDetails = async (clientId) => {
        showLoading();
        try {
            const { data: profile, error: pError } = await db.from('profiles').select('full_name, bio').eq('id', clientId).single();
            if (pError) throw pError;

            const { data: moods, error: mError } = await db.from('mood_entries').select('mood_score, created_at').eq('user_id', clientId).order('created_at', {ascending: false}).limit(7);
            if (mError) throw mError;
            
            const { data: tests, error: tError } = await db.from('test_results').select('*').eq('user_id', clientId).order('created_at', {ascending: false}).limit(5);
            if (tError) throw tError;

            hideLoading();

            let content = `<div class="space-y-4">
                ${profile.bio ? `<div><h4 class="font-bold text-md mb-2">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ Ù…Ø±Ø§Ø¬Ø¹</h4><p class="text-sm bg-gray-100 p-2 rounded-lg">${profile.bio}</p></div>` : ''}
                <div>
                    <h4 class="font-bold text-md mb-2">Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ø§Ø®ÛŒØ±</h4>
                    ${moods.length > 0 ? `<div class="h-48"><canvas id="clientMoodChart"></canvas></div>` : '<p class="text-sm text-gray-500">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>'}
                </div>
                <div>
                    <h4 class="font-bold text-md mb-2">Ø¢Ø®Ø±ÛŒÙ† Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§</h4>
                    ${tests.length > 0 ? `
                        <ul class="list-disc pr-5 space-y-2 text-sm">
                            ${tests.map(t => `<li><strong>${t.test_name}:</strong> ${t.result_text} (Ø§Ù…ØªÛŒØ§Ø²: ${t.score})</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">Ù†ØªÛŒØ¬Ù‡ ØªØ³ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                </div>
            </div>`;

            showModal(`Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø±Ø§Ø¬Ø¹: ${profile?.full_name || ''}`, content);
            
            if(moods && moods.length > 0) {
                const labels = moods.map(d => new persianDate(new Date(d.created_at)).format('D MMM')).reverse();
                const scores = moods.map(d => d.mood_score).reverse();
                const canvasEl = document.getElementById('clientMoodChart');
                if (!canvasEl) return;
                const ctx = canvasEl.getContext('2d');
                
                if (clientMoodChartInstance) clientMoodChartInstance.destroy();

                clientMoodChartInstance = new Chart(ctx, { 
                    type: 'bar', 
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: 'Ù†Ù…Ø±Ù‡ Ø­Ø§Ù„', 
                            data: scores, 
                            backgroundColor: 'rgba(20, 184, 166, 0.5)',
                            borderColor: 'rgb(20, 184, 166)',
                            borderWidth: 1,
                            borderRadius: 8,
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 5 } },
                        plugins: { legend: { display: false } }
                    } 
                });
            }
        } catch (error) {
            hideLoading();
            console.error("Error in viewClientDetails:", error);
            showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª: ${error.message}`, 'error');
        }
    };

    // --- THERAPIST: SCHEDULE ---
    const renderTherapistSchedule = async () => {
        const page = document.getElementById('therapist-schedule-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ø±ÛŒ Ø´Ù…Ø§</h1>
                
                <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
                    <h2 class="text-lg font-bold mb-4">Ø§ÙØ²ÙˆØ¯Ù† Ø²Ù…Ø§Ù† Ø®Ø§Ù„ÛŒ Ø¬Ø¯ÛŒØ¯</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="slot-date" class="block text-sm font-medium text-gray-700">ØªØ§Ø±ÛŒØ®</label>
                            <input type="text" id="slot-date" readonly class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white cursor-pointer" placeholder="Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯">
                        </div>
                        <div>
                            <label for="slot-time" class="block text-sm font-medium text-gray-700">Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹</label>
                            <input type="time" id="slot-time" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="slot-type" class="block text-sm font-medium text-gray-700">Ù†ÙˆØ¹ Ø¬Ù„Ø³Ù‡</label>
                            <select id="slot-type" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm">
                                <option value="in_person">Ø­Ø¶ÙˆØ±ÛŒ</option>
                                <option value="chat">Ú†Øª</option>
                            </select>
                        </div>
                        <button onclick="addAvailableSlot()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Ø§ÙØ²ÙˆØ¯Ù† Ø²Ù…Ø§Ù†</button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-4">Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø´Ù…Ø§</h2>
                    <div id="available-slots-list" class="space-y-2">
                        <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
            </div>
        `;

        $('#slot-date').persianDatepicker({
            format: 'YYYY/MM/DD',
            minDate: new persianDate(),
            observer: true,
            autoClose: true,
        });

        await loadAvailableSlots();
        lucide.createIcons();
    };
    
    const addAvailableSlot = async () => {
        const dateStr = $('#slot-date').val();
        const timeStr = $('#slot-time').val();
        const type = $('#slot-type').val();

        if (!dateStr || !timeStr) {
            showToast('Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }

        const startTimeString = `${dateStr} - ${timeStr}`;

        showLoading();
        const { error } = await db.from('available_slots').insert({
            therapist_id: currentUser.id,
            start_time: startTimeString,
            type: type
        });
        hideLoading();

        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø²Ù…Ø§Ù†.', 'error');
            console.error(error);
        } else {
            showToast('Ø²Ù…Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯.', 'success');
            $('#slot-date').val('');
            $('#slot-time').val('');
            await loadAvailableSlots();
        }
    };
    
    const loadAvailableSlots = async () => {
        const listEl = document.getElementById('available-slots-list');
        if (!listEl) return;

        const { data, error } = await db
            .from('available_slots')
            .select('*')
            .eq('therapist_id', currentUser.id)
            .eq('is_booked', false)
            .order('start_time', { ascending: true });

        if (error) {
            listEl.innerHTML = '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ.</p>';
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = '<p class="text-center text-gray-500">Ø²Ù…Ø§Ù† Ø®Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
            return;
        }

        listEl.innerHTML = data.map(slot => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div>
                    <p class="font-semibold">${slot.start_time}</p>
                    <p class="text-sm text-gray-600">Ù†ÙˆØ¹: ${slot.type === 'in_person' ? 'Ø­Ø¶ÙˆØ±ÛŒ' : 'Ú†Øª'}</p>
                </div>
                <button onclick="deleteAvailableSlot(${slot.id})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>
        `).join('');
        lucide.createIcons();
    };

    const deleteAvailableSlot = async (slotId) => {
        showLoading();
        const { error } = await db.from('available_slots').delete().eq('id', slotId);
        hideLoading();
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø²Ù…Ø§Ù†.', 'error');
        } else {
            showToast('Ø²Ù…Ø§Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.', 'success');
            await loadAvailableSlots();
        }
    };

    // --- THERAPIST: PROFILE ---
    const renderTherapistProfile = async () => {
        const page = document.getElementById('therapist-profile-page');
        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col items-center space-y-4">
                    <div class="relative w-24 h-24">
                        <div id="therapist-profile-avatar" class="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-lg"></div>
                        <label for="therapist-avatar-upload" class="absolute bottom-0 right-0 bg-white p-1.5 rounded-full shadow-md cursor-pointer">
                            <i data-lucide="camera" class="w-5 h-5 text-gray-600"></i>
                            <input id="therapist-avatar-upload" type="file" class="hidden" accept="image/*" onchange="uploadProfilePicture(event)">
                        </label>
                    </div>
                    <div class="text-center">
                        <h1 class="text-2xl font-bold">${userProfile.full_name}</h1>
                        <p class="text-gray-500">${currentUser.email}</p>
                        <div class="mt-2">${renderStars(userProfile.average_rating || 0, userProfile.total_ratings || 0)}</div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                    <h2 class="text-lg font-bold">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ØªØ®ØµØµÛŒ</h2>
                    <div class="space-y-2">
                        <label for="therapist-fullname-input" class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                        <input id="therapist-fullname-input" type="text" class="w-full p-2 border rounded-lg" value="${userProfile.full_name || ''}">
                    </div>
                     <div class="space-y-2">
                        <label for="therapist-specialization-input" class="block text-sm font-medium text-gray-700">ØªØ®ØµØµâ€ŒÙ‡Ø§ (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯)</label>
                        <input id="therapist-specialization-input" type="text" class="w-full p-2 border rounded-lg" placeholder="Ù…Ø«Ø§Ù„: CBT, Ø±ÙˆØ§Ù†Ú©Ø§ÙˆÛŒ" value="${userProfile.specialization || ''}">
                    </div>
                    <div class="space-y-2">
                        <label for="therapist-bio-input" class="block text-sm font-medium text-gray-700">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ ØªØ®ØµØµÛŒ</label>
                        <textarea id="therapist-bio-input" class="w-full h-24 p-2 border rounded-lg" placeholder="Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø³ÙˆØ§Ø¨Ù‚ Ùˆ Ø±ÙˆÛŒÚ©Ø±Ø¯ Ø¯Ø±Ù…Ø§Ù†ÛŒ Ø®ÙˆØ¯ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">${userProfile.bio || ''}</textarea>
                    </div>
                    <button onclick="updateTherapistProfile()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="text-lg font-bold mb-3">Ù†Ø¸Ø±Ø§Øª Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</h2>
                    <div id="therapist-reviews-list" class="space-y-3"></div>
                </div>

                <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
            </div>
        `;
        renderAvatar(document.getElementById('therapist-profile-avatar'), userProfile.avatar_url, { bgColor: 'bg-blue-100', iconColor: 'text-blue-600'});
        await loadTherapistReviews();
        lucide.createIcons();
    };

    const updateTherapistProfile = async () => {
        const newName = document.getElementById('therapist-fullname-input').value;
        const newBio = document.getElementById('therapist-bio-input').value;
        const newSpec = document.getElementById('therapist-specialization-input').value;

        showLoading();
        const { data, error } = await db.from('profiles').update({ 
            full_name: newName,
            bio: newBio,
            specialization: newSpec,
        }).eq('id', currentUser.id).select().single();
        hideLoading();
        
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.', 'error');
            console.error(error);
        } else {
            userProfile = data;
            showToast('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
            await renderTherapistProfile();
        }
    };

    const loadTherapistReviews = async () => {
        const listEl = document.getElementById('therapist-reviews-list');
        if (!listEl) return;
        listEl.innerHTML = '<p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª...</p>';

        const { data, error } = await db
            .from('reviews')
            .select('*, client:client_id(full_name)')
            .eq('therapist_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            listEl.innerHTML = '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø¸Ø±Ø§Øª.</p>';
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = '<p class="text-center text-gray-500">Ù‡Ù†ÙˆØ² Ù†Ø¸Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
            return;
        }

        listEl.innerHTML = data.map(review => `
            <div class="bg-gray-50 p-3 rounded-lg border">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-sm">${review.client.full_name}</span>
                    <div class="flex items-center">
                        <span class="text-amber-500 font-bold ml-1">${review.rating}</span>
                        <i data-lucide="star" class="w-4 h-4 text-amber-400 fill-current"></i>
                    </div>
                </div>
                <p class="text-gray-700 text-sm">${review.comment || '<i>(Ø¨Ø¯ÙˆÙ† Ù†Ø¸Ø± Ù…ØªÙ†ÛŒ)</i>'}</p>
                <p class="text-xs text-gray-400 text-left mt-2">${new persianDate(new Date(review.created_at)).format('L')}</p>
            </div>
        `).join('');
        lucide.createIcons();
    };


    // =================================================================
    // SHARED: CHAT PAGE (UPGRADED)
    // =================================================================
    const startChatWith = async (otherUserId) => {
        const page = document.getElementById('chat-page');
        const { data: otherUser, error } = await db.from('profiles').select('id, full_name, avatar_url').eq('id', otherUserId).single();
        if (error) {
            showToast('Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
            return;
        }
        
        let therapistControls = '';
        if (userProfile.role === 'therapist') {
            therapistControls = `<button onclick="confirmEndChat('${otherUserId}')" class="ml-auto text-xs bg-red-500 text-white font-semibold py-1 px-3 rounded-full">Ù¾Ø§ÛŒØ§Ù† Ú¯ÙØªÚ¯Ùˆ</button>`;
        }

        page.innerHTML = `
            <header class="bg-white shadow-sm p-3 flex items-center gap-3 flex-shrink-0">
                <button onclick="goBackFromChat()" class="text-gray-600"><i data-lucide="arrow-right"></i></button>
                <div class="w-10 h-10 rounded-full overflow-hidden" id="chat-header-avatar"></div>
                <h1 class="font-bold text-lg">${otherUser.full_name}</h1>
                ${therapistControls}
            </header>
            <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
            </div>
            <footer class="bg-white p-2 flex items-center gap-2 border-t flex-shrink-0">
                <label for="chat-image-upload" class="cursor-pointer p-2 text-gray-500 hover:text-teal-600 transition-colors">
                    <i data-lucide="paperclip"></i>
                </label>
                <input id="chat-image-upload" type="file" class="hidden" accept="image/*">
                <input id="chat-input" type="text" class="flex-grow bg-gray-100 rounded-full py-2 px-4 focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                <button id="send-chat-btn" class="bg-teal-500 text-white w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">
                    <i data-lucide="send"></i>
                </button>
            </footer>
        `;
        renderAvatar(document.getElementById('chat-header-avatar'), otherUser.avatar_url, { bgColor: 'bg-gray-200', iconColor: 'text-gray-600'});
        lucide.createIcons();
        page.style.padding = '0'; 
        navigateTo('chat-page');

        const messageContainer = document.getElementById('chat-messages');
        const sendBtn = document.getElementById('send-chat-btn');
        const chatInput = document.getElementById('chat-input');
        const chatImageUpload = document.getElementById('chat-image-upload');

        const boundSendMessage = () => handleSendMessage(otherUserId, chatInput);
        const boundImageUpload = (event) => handleChatImageUpload(event, otherUserId);

        sendBtn.onclick = boundSendMessage;
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') boundSendMessage();
        });
        chatImageUpload.onchange = boundImageUpload;
        
        await loadMessages(otherUserId, messageContainer);

        if (chatSubscription) chatSubscription.unsubscribe();

        chatSubscription = db.channel('public:chat_messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, 
            (payload) => {
                const newMessage = payload.new;
                if ((newMessage.sender_id === otherUserId && newMessage.receiver_id === currentUser.id) || 
                    (newMessage.sender_id === currentUser.id && newMessage.receiver_id === otherUserId)) {
                    messageContainer.innerHTML += renderMessage(newMessage);
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                }
            })
            .subscribe();
    };

    const goBackFromChat = () => {
        if (chatSubscription) {
            chatSubscription.unsubscribe();
            chatSubscription = null;
        }
        document.getElementById('chat-page').style.padding = ''; 
        navigateTo(lastPageId);
    };

    const renderMessage = (msg) => {
        const isMe = msg.sender_id === currentUser.id;
        const time = new Date(msg.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
        let messageContentHTML = '';
        let bubbleClasses = 'px-4 py-2'; // Default padding for text

        if (msg.image_url) {
            bubbleClasses = 'p-1'; // Less padding for image bubbles
            messageContentHTML = `<img src="${msg.image_url}" class="rounded-lg max-w-full h-auto" style="max-height: 250px;" alt="ØªØµÙˆÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡" onload="this.closest('#chat-messages').scrollTop = this.closest('#chat-messages').scrollHeight">`;
        } else {
            messageContentHTML = `<p class="whitespace-pre-wrap">${msg.message_text}</p>`;
        }

        return `
            <div class="flex items-end gap-2 ${isMe ? 'justify-end' : 'justify-start'}">
                <div class="max-w-xs lg:max-w-md ${bubbleClasses} rounded-2xl ${isMe ? 'bg-teal-500 text-white rounded-br-lg' : 'bg-gray-200 text-gray-800 rounded-bl-lg'}">
                    ${messageContentHTML}
                    <p class="text-xs mt-1 ${isMe ? 'text-white/70' : 'text-gray-500'} text-left">${time}</p>
                </div>
            </div>
        `;
    };

    const loadMessages = async (otherUserId, messageContainer) => {
        const { data: messages, error } = await db.from('chat_messages')
            .select('*')
            .in('sender_id', [currentUser.id, otherUserId])
            .in('receiver_id', [currentUser.id, otherUserId])
            .order('created_at', { ascending: true });
        
        if(messages) {
            messageContainer.innerHTML = messages.map(renderMessage).join('');
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    };

    const handleSendMessage = async (otherUserId, chatInput) => {
        const messageText = chatInput.value.trim();
        if (!messageText) return;
        chatInput.value = '';

        const { error } = await db.from('chat_messages').insert({
            sender_id: currentUser.id,
            receiver_id: otherUserId,
            message_text: messageText
        });

        if (error) {
            console.error('Error sending message:', error);
            showToast('Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯.', 'error');
            chatInput.value = messageText; // Restore message on failure
        }
    };

    const handleChatImageUpload = async (event, otherUserId) => {
        const file = event.target.files[0];
        if (!file) return;
        
        event.target.value = '';

        const messageContainer = document.getElementById('chat-messages');
        const uploadPlaceholderId = `upload-${Date.now()}`;
        const placeholderHTML = `
            <div id="${uploadPlaceholderId}" class="flex items-end gap-2 justify-end">
                <div class="max-w-xs p-2 rounded-2xl bg-teal-200 text-teal-800 rounded-br-lg">
                    <p class="text-sm">...Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±</p>
                </div>
            </div>
        `;
        messageContainer.innerHTML += placeholderHTML;
        messageContainer.scrollTop = messageContainer.scrollHeight;

        // BUCKET NAME FIX: Changed 'chat_images' to 'chat-images'
        const bucketName = 'chat-images';
        const fileName = `public/${currentUser.id}_${otherUserId}/${Date.now()}-${file.name}`;

        const { error: uploadError } = await db.storage.from(bucketName).upload(fileName, file);

        if (uploadError) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±.', 'error');
            document.getElementById(uploadPlaceholderId)?.remove();
            console.error(uploadError);
            return;
        }

        const { data: urlData } = db.storage.from(bucketName).getPublicUrl(fileName);

        const { error: insertError } = await db.from('chat_messages').insert({
            sender_id: currentUser.id,
            receiver_id: otherUserId,
            image_url: urlData.publicUrl
        });

        document.getElementById(uploadPlaceholderId)?.remove();

        if (insertError) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ±.', 'error');
            console.error(insertError);
            await db.storage.from(bucketName).remove([fileName]);
        }
    };
    
    const confirmEndChat = (clientId) => {
        const content = 'Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø§ Ø§ÛŒÙ† Ú©Ø§Ø±ØŒ ÙˆØ¶Ø¹ÛŒØª Ù†ÙˆØ¨Øª Ø¨Ù‡ "Ù¾Ø§ÛŒØ§Ù†â€ŒÛŒØ§ÙØªÙ‡" ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ù†Ø¸Ø± Ø«Ø¨Øª Ú©Ù†Ø¯.';
        const actions = [{
            text: 'Ø¨Ù„Ù‡ØŒ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø¯Ù‡',
            className: 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700',
            handler: `endChat('${clientId}')`
        }];
        showModal('ØªØ§ÛŒÛŒØ¯ Ù¾Ø§ÛŒØ§Ù† Ú¯ÙØªÚ¯Ùˆ', content, actions);
    };

    const endChat = async (clientId) => {
        closeModal();
        showLoading();
        
        const { data: appointment, error: aptError } = await db
            .from('appointments')
            .select('id')
            .eq('therapist_id', currentUser.id)
            .eq('client_id', clientId)
            .eq('status', 'confirmed')
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        if (aptError || !appointment) {
            hideLoading();
            showToast('Ù†ÙˆØ¨Øª ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
            return;
        }

        const { error: updateError } = await db
            .from('appointments')
            .update({ status: 'completed' })
            .eq('id', appointment.id);

        hideLoading();
        if (updateError) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú¯ÙØªÚ¯Ùˆ.', 'error');
        } else {
            showToast('Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª.', 'success');
            goBackFromChat();
            renderTherapistDashboard(); // Refresh dashboard to update counts
        }
    };


    // =================================================================
    // ADMIN-SIDE RENDERING & LOGIC
    // =================================================================
    const renderAdminDashboard = async () => {
        const page = document.getElementById('admin-dashboard-page');
        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§ÛŒÙ†Ùˆ</h1>
                
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h2>
                    <div class="flex justify-between items-center">
                        <span>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Gemini)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="ai-toggle" class="sr-only peer" ${aiFeaturesEnabled ? 'checked' : ''}>
                          <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-teal-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
                    <div id="admin-user-list" class="space-y-2">
                        <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
                 <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬</button>
            </div>
        `;
        
        document.getElementById('ai-toggle').addEventListener('change', (e) => {
            aiFeaturesEnabled = e.target.checked;
            showToast(`ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ${aiFeaturesEnabled ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'} Ø´Ø¯.`, 'info');
        });

        await loadAllUsersForAdmin();
        lucide.createIcons();
    };
    
    const loadAllUsersForAdmin = async () => {
        const listEl = document.getElementById('admin-user-list');
        const { data, error } = await db.from('profiles').select('*');
        if(error) {
            listEl.innerHTML = '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.</p>';
            return;
        }
        listEl.innerHTML = data.map(user => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div>
                    <p class="font-semibold">${user.full_name}</p>
                    <p class="text-sm text-gray-500">${user.email}</p>
                </div>
                <span class="text-sm font-semibold px-3 py-1 rounded-full ${user.role === 'client' ? 'bg-green-100 text-green-800' : (user.role === 'therapist' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800')}">${user.role}</span>
            </div>
        `).join('');
    };

    // =================================================================
    // GLOBALLY ACCESSIBLE FUNCTIONS
    // =================================================================
    window.navigateTo = navigateTo;
    window.closeModal = closeModal;
    window.handleLogout = handleLogout;
    window.submitMood = submitMood;
    window.submitJournal = submitJournal;
    window.openAiChat = openAiChat;
    window.sendAiChatMessage = sendAiChatMessage;
    window.startTest = startTest;
    window.submitTest = submitTest;
    window.resetTestsPage = resetTestsPage;
    window.bookAppointment = bookAppointment;
    window.cancelAppointment = cancelAppointment;
    window.openProfileEditor = openProfileEditor;
    window.showSupportRequest = showSupportRequest;
    window.viewTestHistory = viewTestHistory;
    window.updateTherapistProfile = updateTherapistProfile;
    window.viewClientDetails = viewClientDetails;
    window.startChatWith = startChatWith;
    window.goBackFromChat = goBackFromChat;
    window.navigateToTraining = navigateToTraining;
    window.goBackFromTraining = goBackFromTraining;
    window.editJournalEntry = editJournalEntry;
    window.updateJournalEntry = updateJournalEntry;
    window.confirmDeleteJournalEntry = confirmDeleteJournalEntry;
    window.deleteJournalEntry = deleteJournalEntry;
    window.uploadProfilePicture = uploadProfilePicture;
    window.showAvailableSlots = showAvailableSlots;
    window.addAvailableSlot = addAvailableSlot;
    window.deleteAvailableSlot = deleteAvailableSlot;
    window.handleAppointmentConfirmation = handleAppointmentConfirmation;
    window.showRatingModal = showRatingModal;
    window.submitReview = submitReview;
    window.confirmEndChat = confirmEndChat;
    window.endChat = endChat;

</script>
</body>
</html>
