<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§ÛŒÙ†Ùˆ - Ø¯Ø³ØªÛŒØ§Ø± Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… ÙØ§Ø±Ø³ÛŒ -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        .page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f2f5;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: 6rem; /* 4rem for nav + 2rem space */
        }

        .page.active {
            display: block;
            animation: slideIn 0.3s ease-out forwards;
        }
        
        .page.active.flex-layout {
            display: flex;
            flex-direction: column;
            height: 100%; 
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 4rem; /* h-16 */
            transition: transform 0.3s ease-in-out;
        }
        
        .bottom-nav.hidden {
            transform: translateY(100%);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.visible {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .pdp-group {
            direction: ltr;
        }

        #loading-spinner .loader {
            width: 50px;
            height: 50px;
            display: grid;
            animation: s4 4s infinite;
        }
        #loading-spinner .loader::before,
        #loading-spinner .loader::after {
            content: "";
            grid-area: 1/1;
            border: 8px solid;
            border-radius: 50%;
            border-color: #14B8A6 #14B8A6 #0000 #0000;
            mix-blend-mode: darken;
            animation: s4 1s infinite linear;
        }
        #loading-spinner .loader::after {
            border-color: #0000 #0000 #3b82f6 #3b82f6;
            animation-direction: reverse;
        }
        @keyframes s4 {
            100% {
                transform: rotate(1turn);
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-spinner" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm hidden">
        <div class="loader"></div>
    </div>

    <div id="modal-container" class="modal-backdrop"></div>

    <div id="auth-page" class="page active bg-gradient-to-br from-teal-400 to-blue-500">
        <div class="w-full h-full flex items-center justify-center">
            <div class="w-full max-w-md m-auto p-8">
                <div class="text-center mb-10">
                    <h1 class="text-5xl font-bold text-white">Ø³Ø§ÛŒÙ†Ùˆ</h1>
                    <p class="text-white/80 mt-2">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§</p>
                </div>
                
                <div id="login-form-container">
                    <form id="login-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-6">
                        <h2 class="text-2xl font-bold text-white text-center">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-white">Ø§ÛŒÙ…ÛŒÙ„</label>
                            <input type="email" id="login-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-white">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">ÙˆØ±ÙˆØ¯</button>
                        <p class="text-center text-sm text-white">
                            Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="#" id="show-signup" class="font-bold hover:underline">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯</a>
                        </p>
                    </form>
                </div>

                <div id="signup-form-container" class="hidden">
                    <form id="signup-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-bold text-white text-center">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</h2>
                        <div>
                            <label for="signup-fullname" class="block text-sm font-medium text-white">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                            <input type="text" id="signup-fullname" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-email" class="block text-sm font-medium text-white">Ø§ÛŒÙ…ÛŒÙ„</label>
                            <input type="email" id="signup-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-password" class="block text-sm font-medium text-white">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                            <input type="password" id="signup-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                        </div>
                        <div>
                            <label for="signup-role" class="block text-sm font-medium text-white">Ù†Ù‚Ø´ Ø´Ù…Ø§</label>
                            <select id="signup-role" class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 focus:ring-2 focus:ring-white">
                                <option value="client">Ù…Ø±Ø§Ø¬Ø¹</option>
                                <option value="therapist">Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                        <p class="text-center text-sm text-white">
                            Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ <a href="#" id="show-login" class="font-bold hover:underline">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <!-- Client Pages -->
        <div id="client-dashboard-page" class="page"></div>
        <div id="client-tests-page" class="page"></div>
        <div id="client-appointments-page" class="page"></div>
        <div id="client-profile-page" class="page"></div>

        <!-- Therapist Pages -->
        <div id="therapist-dashboard-page" class="page"></div>
        <div id="therapist-clients-page" class="page"></div>
        <div id="therapist-schedule-page" class="page"></div>
        <div id="therapist-profile-page" class="page"></div>
        
        <!-- Shared Pages -->
        <div id="chat-page" class="page"></div>

        <!-- Admin Page -->
        <div id="admin-dashboard-page" class="page"></div>
        
        <div id="bottom-nav-bar" class="bottom-nav bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        </div>
    </div>

<script type="module">
    // =================================================================
    // CONFIGURATION
    // =================================================================
    const SUPABASE_URL = 'https://atrhsfozgnfhhbfxgsnu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cmhzZm96Z25maGhiZnhnc251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjQ3MTYsImV4cCI6MjA2NjQ0MDcxNn0.eGODASElOsWJZ_cXmumZZwdQlcBGahm89n2UCuUxWk8';
    const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; 
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
    
    // =================================================================
    // INITIALIZATION
    // =================================================================
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentUser = null;
    let userProfile = null;
    let aiFeaturesEnabled = true;
    let chatSubscription = null;
    let moodChartInstance = null;
    let clientMoodChartInstance = null;
    let selectedAppointmentTimestamp = null;
    let lastPageId = 'client-dashboard-page';

    // =================================================================
    // UTILITY & HELPER FUNCTIONS
    // =================================================================

    const showLoading = () => document.getElementById('loading-spinner').classList.remove('hidden');
    const hideLoading = () => document.getElementById('loading-spinner').classList.add('hidden');

    const showModal = (title, content, actions = []) => {
        const modalContainer = document.getElementById('modal-container');
        const modalHTML = `
            <div class="modal-content animate-fade-in-up">
                <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                <div class="text-gray-600">${content}</div>
                <div class="flex justify-end gap-2 mt-6">
                    ${actions.map(action => `<button class="${action.className}" onclick="${action.handler}">${action.text}</button>`).join('')}
                    <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" onclick="closeModal()">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = modalHTML;
        modalContainer.classList.add('visible');
    };

    const closeModal = () => {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.classList.remove('visible');
        modalContainer.innerHTML = '';
    };

    const showToast = (message, type = 'success') => {
        const toastColors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        const toast = document.createElement('div');
        toast.className = `fixed top-5 right-5 ${toastColors[type]} text-white py-2 px-4 rounded-lg shadow-lg z-[3000] animate-slide-in-right`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    const navigateTo = (pageId) => {
        const activePage = document.querySelector('.page.active');
        const navBar = document.getElementById('bottom-nav-bar');

        if (activePage && activePage.id !== 'chat-page' && pageId !== activePage.id) {
            lastPageId = activePage.id;
        }

        document.querySelectorAll('.page').forEach(page => page.classList.remove('active', 'flex-layout'));
        const targetPage = document.getElementById(pageId);

        if (targetPage) {
            targetPage.classList.add('active');
            if (pageId === 'chat-page') {
                targetPage.classList.add('flex-layout');
                navBar.classList.add('hidden');
            } else {
                navBar.classList.remove('hidden');
            }
            targetPage.scrollTop = 0;
        }
        
        const navId = `nav-${pageId.split('-')[1]}`;
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('text-teal-600');
            item.classList.add('text-gray-500');
        });
        const activeNavItem = document.getElementById(navId);
        if (activeNavItem) {
            activeNavItem.classList.remove('text-gray-500');
            activeNavItem.classList.add('text-teal-600');
        }
    };

    // =================================================================
    // AUTHENTICATION
    // =================================================================

    const authPage = document.getElementById('auth-page');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');

    document.getElementById('show-signup').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('signup-form-container').classList.remove('hidden');
    });

    document.getElementById('show-login').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('signup-form-container').classList.add('hidden');
        document.getElementById('login-form-container').classList.remove('hidden');
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await db.auth.signInWithPassword({ email, password });
        if (error) {
            showToast(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`, 'error');
            hideLoading();
        } else {
            showToast('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯!', 'success');
        }
    });

    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const fullName = document.getElementById('signup-fullname').value;
        const role = document.getElementById('signup-role').value;

        const { data, error } = await db.auth.signUp({
            email,
            password,
            options: {
                data: {
                    full_name: fullName,
                    role: role 
                }
            }
        });
        
        if (error) {
            showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ${error.message}`, 'error');
        } else {
            if (data.user && data.user.identities && data.user.identities.length === 0) {
                 showToast('Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
            } else {
                 showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'info');
            }
        }
        hideLoading();
    });

    const handleLogout = async () => {
        showLoading();
        await db.auth.signOut();
        currentUser = null;
        userProfile = null;
        if(chatSubscription) chatSubscription.unsubscribe();
        authPage.classList.add('active');
        appContainer.classList.add('hidden');
        appContainer.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        hideLoading();
    };

    // =================================================================
    // APP INITIALIZATION & ROUTING
    // =================================================================

    // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø¨Ø®Ø´ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÙØ±Ø´ Ø´Ø¯Ù† ØµÙØ­Ù‡
    db.auth.onAuthStateChange(async (event, session) => {
        try {
            if (event === 'TOKEN_REFRESHED') {
                return; 
            }

            if (event === 'SIGNED_IN' || (event === 'INITIAL_SESSION' && session)) {
                if (currentUser && currentUser.id === session.user.id) {
                    return; 
                }
                showLoading();
                currentUser = session.user;
                const { data, error } = await db.from('profiles').select('*').eq('id', currentUser.id).single();

                if (error && !data) {
                    throw new Error(`Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯: ${error.message}`);
                }

                if (data) {
                    userProfile = data;
                    authPage.classList.remove('active');
                    appContainer.classList.remove('hidden');
                    await setupUIForRole(userProfile.role);
                } else {
                     throw new Error('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.');
                }
                
            } else if (event === 'SIGNED_OUT') {
                await handleLogout();
            }
        } catch (err) {
            console.error("Ø®Ø·Ø§ÛŒ Ø§Ø³Ø§Ø³ÛŒ Ø¯Ø± Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:", err);
            showToast(`ÛŒÚ© Ø®Ø·Ø§ÛŒ Ø§Ø³Ø§Ø³ÛŒ Ø±Ø® Ø¯Ø§Ø¯: ${err.message}`, 'error');
            await handleLogout();
        } finally {
            hideLoading();
        }
    });

    const setupUIForRole = async (role) => {
        const navBar = document.getElementById('bottom-nav-bar');
        navBar.innerHTML = '';

        if (!['client', 'therapist', 'admin'].includes(role)) {
            showToast(`Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±ÛŒ "${role || 'Ù†Ø§Ù…Ø´Ø®Øµ'}" ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.`, 'error');
            console.error(`Invalid role detected: ${role}`);
            handleLogout();
            return;
        }

        if (role === 'client') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-dashboard-page')">
                        <i data-lucide="home"></i><span class="text-xs">Ø®Ø§Ù†Ù‡</span>
                    </a>
                    <a href="#" id="nav-tests" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-tests-page')">
                        <i data-lucide="file-text"></i><span class="text-xs">ØªØ³Øªâ€ŒÙ‡Ø§</span>
                    </a>
                    <a href="#" id="nav-appointments" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-appointments-page')">
                        <i data-lucide="calendar-days"></i><span class="text-xs">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-profile-page')">
                        <i data-lucide="user"></i><span class="text-xs">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
                    </a>
                </div>
            `;
            await renderClientDashboard();
            await renderClientTests();
            await renderClientAppointments();
            await renderClientProfile();
            navigateTo('client-dashboard-page');
        } else if (role === 'therapist') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-dashboard-page')">
                        <i data-lucide="layout-dashboard"></i><span class="text-xs">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                    </a>
                    <a href="#" id="nav-clients" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-clients-page')">
                        <i data-lucide="users"></i><span class="text-xs">Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</span>
                    </a>
                    <a href="#" id="nav-schedule" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-schedule-page')">
                        <i data-lucide="calendar-clock"></i><span class="text-xs">Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-profile-page')">
                        <i data-lucide="user-cog"></i><span class="text-xs">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
                    </a>
                </div>
            `;
            await renderTherapistDashboard();
            await renderTherapistClients();
            await renderTherapistSchedule();
            await renderTherapistProfile();
            navigateTo('therapist-dashboard-page');
        } else if (role === 'admin') {
            navBar.innerHTML = `<div class="text-center p-4 bg-gray-800 text-white">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</div>`;
            await renderAdminDashboard();
            navigateTo('admin-dashboard-page');
        }
        lucide.createIcons();
    };

    // =================================================================
    // AI HELPER
    // =================================================================
    const getAiSuggestion = async (prompt) => {
        if (!aiFeaturesEnabled) {
            return "Ù‚Ø§Ø¨Ù„ÛŒØª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.";
        }
        if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
            return "Ú©Ù„ÛŒØ¯ API Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ… ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.";
        }
        try {
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => null);
                const errorMessage = errorBody?.error?.message || `API request failed with status ${response.status}`;
                throw new Error(errorMessage);
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error("Gemini API Error:", error);
            if (error instanceof TypeError && error.message === 'Failed to fetch') {
                return "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
            }
            return `Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡: ${error.message}`;
        }
    };
    
    // =================================================================
    // CLIENT-SIDE RENDERING & LOGIC
    // =================================================================

    // --- CLIENT: DASHBOARD ---
    const renderClientDashboard = async () => {
        const page = document.getElementById('client-dashboard-page');
        
        const { data: lastAppointment, error: lastAptError } = await db
            .from('appointments')
            .select('therapist:therapist_id ( id, full_name )')
            .eq('client_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(1)
            .single();

        let therapistCardHTML = '';
        if (lastAppointment && lastAppointment.therapist) {
            therapistCardHTML = `
            <div class="bg-white p-4 rounded-2xl shadow-md flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ Ø´Ù…Ø§</p>
                    <p class="font-bold text-lg">Ø¯Ú©ØªØ± ${lastAppointment.therapist.full_name}</p>
                </div>
                <button onclick="startChatWith('${lastAppointment.therapist.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                    <i data-lucide="message-circle"></i>
                    <span>Ú†Øª</span>
                </button>
            </div>
            `;
        } else {
             therapistCardHTML = `
            <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                 <p class="font-semibold mb-2">Ù‡Ù†ÙˆØ² Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                 <p class="text-sm text-gray-600 mb-4">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯ÙˆØŒ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù†ÙˆØ¨Øª Ø±Ø²Ø±Ùˆ Ú©Ù†ÛŒØ¯.</p>
                 <button onclick="navigateTo('client-appointments-page')" class="bg-teal-500 text-white px-6 py-2 rounded-lg font-semibold">Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª</button>
            </div>
            `;
        }

        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Ø³Ù„Ø§Ù…ØŒ ${userProfile.full_name.split(' ')[0]}!</h1>
                        <p class="text-gray-500">Ø­Ø§Ù„Øª Ø§Ù…Ø±ÙˆØ² Ú†Ø·ÙˆØ±Ù‡ØŸ</p>
                    </div>
                    <button onclick="navigateTo('client-profile-page')" class="w-12 h-12 rounded-full bg-teal-500 text-white flex items-center justify-center text-xl font-bold">
                        ${userProfile.full_name.charAt(0)}
                    </button>
                </div>

                ${therapistCardHTML}

                <div id="health-score-card" class="bg-white p-4 rounded-2xl shadow-md text-center">
                    <p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§...</p>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ø«Ø¨Øª Ø­Ø§Ù„ Ø§Ù…Ø±ÙˆØ²</h2>
                    <div class="flex justify-around items-center">
                        ${[
                            { emoji: 'ğŸ˜”', score: 1, label: 'Ø®ÛŒÙ„ÛŒ Ø¨Ø¯' },
                            { emoji: 'ğŸ˜Ÿ', score: 2, label: 'Ø¨Ø¯' },
                            { emoji: 'ğŸ˜', score: 3, label: 'Ù…Ø¹Ù…ÙˆÙ„ÛŒ' },
                            { emoji: 'ğŸ™‚', score: 4, label: 'Ø®ÙˆØ¨' },
                            { emoji: 'ğŸ˜„', score: 5, label: 'Ø¹Ø§Ù„ÛŒ' }
                        ].map(mood => `
                            <button onclick="submitMood(${mood.score})" class="flex flex-col items-center space-y-1 text-gray-600 hover:text-teal-600 transition">
                                <span class="text-4xl">${mood.emoji}</span>
                                <span class="text-xs">${mood.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ù‡ÙØªÙ‡</h2>
                    <div class="relative h-64">
                        <canvas id="moodChart"></canvas>
                    </div>
                </div>
                
                <div id="ai-helper-card" class="bg-gradient-to-r from-blue-500 to-cyan-400 p-4 rounded-2xl shadow-lg text-white">
                    <h2 class="font-bold text-lg mb-2">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§ÛŒÙ†Ùˆ</h2>
                    <p class="text-sm mb-4">Ù†ÛŒØ§Ø² Ø¨Ù‡ ØµØ­Ø¨Øª Ø¯Ø§Ø±ÛŒØŸ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø§ Ù‡Ù…ÛŒØ´Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù…Ú© Ø¨Ù‡ ØªÙˆØ³Øª.</p>
                    <button onclick="openAiChat()" class="bg-white/30 w-full py-2 rounded-lg font-semibold hover:bg-white/50 transition">Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ</button>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-2">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
                    <p class="text-sm text-gray-500 mb-3">Ø§ÙÚ©Ø§Ø±Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³. Ø§ÛŒÙ† ÛŒÚ© ÙØ¶Ø§ÛŒ Ú©Ø§Ù…Ù„Ø§ Ø´Ø®ØµÛŒÙ‡.</p>
                    <textarea id="journal-input" class="w-full h-24 p-2 border rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="Ø§Ù…Ø±ÙˆØ² Ú†Ù‡ Ú¯Ø°Ø´Øª..."></textarea>
                    <button onclick="submitJournal()" class="mt-2 w-full bg-teal-500 text-white py-2 rounded-lg font-semibold hover:bg-teal-600 transition">Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</button>
                </div>
            </div>
        `;
        await calculateAndDisplayHealthScore();
        await loadMoodChart();
        lucide.createIcons();
    };
    
    const calculateAndDisplayHealthScore = async () => {
        const scoreCard = document.getElementById('health-score-card');
        if (!scoreCard) return;

        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', thirtyDaysAgo);

        if (error || !data || data.length === 0) {
            scoreCard.innerHTML = `
                <h2 class="font-bold text-lg mb-1">Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù†</h2>
                <p class="text-gray-500 text-sm">Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</p>
            `;
            return;
        }

        const totalScore = data.reduce((acc, entry) => acc + entry.mood_score, 0);
        const averageScore = totalScore / data.length;
        const healthScore = Math.round((averageScore / 5) * 100);

        let scoreDescription = '';
        let scoreColor = '';
        if (healthScore >= 80) {
            scoreDescription = 'Ø¹Ø§Ù„ÛŒ! Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒâ€ŒØ±Ø³Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®ÙˆØ¨ÛŒ Ø±Ø§ Ø³Ù¾Ø±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.';
            scoreColor = 'text-green-500';
        } else if (healthScore >= 60) {
            scoreDescription = 'Ø®ÙˆØ¨. ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯.';
            scoreColor = 'text-teal-500';
        } else if (healthScore >= 40) {
            scoreDescription = 'Ù…ØªÙˆØ³Ø·. Ù…Ø±Ø§Ù‚Ø¨ Ø®ÙˆØ¯ Ø¨Ø§Ø´ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø§Ø­Ø³Ø§Ø³ØªØ§Ù† ØªÙˆØ¬Ù‡ Ú©Ù†ÛŒØ¯.';
            scoreColor = 'text-yellow-500';
        } else {
            scoreDescription = 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡. ØµØ­Ø¨Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙÛŒØ¯ Ø¨Ø§Ø´Ø¯.';
            scoreColor = 'text-red-500';
        }

        scoreCard.innerHTML = `
            <h2 class="font-bold text-lg mb-2">Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† (Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±)</h2>
            <p class="text-5xl font-bold ${scoreColor}">${healthScore}<span class="text-2xl text-gray-400">/Û±Û°Û°</span></p>
            <p class="text-gray-600 mt-2 text-sm">${scoreDescription}</p>
        `;
    };

    const submitMood = async (score) => {
        showLoading();
        const { error } = await db.from('mood_entries').insert({ user_id: currentUser.id, mood_score: score });
        hideLoading();
        if (error) {
            showToast('Ø§Ù…Ø±ÙˆØ² Ù‚Ø¨Ù„Ø§ Ø­Ø§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.', 'error');
        } else {
            showToast('Ø­Ø§Ù„ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
            await loadMoodChart();
            await calculateAndDisplayHealthScore();
        }
    };

    const loadMoodChart = async () => {
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('created_at, mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', sevenDaysAgo)
            .order('created_at', { ascending: true });

        if (error) {
            console.error("Error loading mood data:", error);
            return;
        }

        const labels = data.map(d => new persianDate(new Date(d.created_at)).format('dddd'));
        const scores = data.map(d => d.mood_score);

        const canvasEl = document.getElementById('moodChart');
        if (!canvasEl) return;
        const ctx = canvasEl.getContext('2d');
        
        if (moodChartInstance) {
            moodChartInstance.destroy();
        }

        moodChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ',
                    data: scores,
                    fill: true,
                    backgroundColor: 'rgba(20, 184, 166, 0.2)',
                    borderColor: 'rgb(20, 184, 166)',
                    pointBackgroundColor: 'rgb(20, 184, 166)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(20, 184, 166)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: { line: { borderWidth: 3 } },
                scales: {
                    r: {
                        angleLines: { display: false },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        pointLabels: { font: { family: "'Vazirmatn', sans-serif", size: 12 } },
                        ticks: { stepSize: 1, display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    };

    const submitJournal = async () => {
        const content = document.getElementById('journal-input').value;
        if (!content.trim()) {
            showToast('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ†ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }
        showLoading();
        const { error } = await db.from('journal_entries').insert({ user_id: currentUser.id, content: content });
        hideLoading();
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª.', 'error');
        } else {
            showToast('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
            document.getElementById('journal-input').value = '';
        }
    };
    
    const openAiChat = () => {
        const content = `
            <div id="ai-chat-history" class="h-64 overflow-y-auto p-2 bg-gray-100 rounded-lg mb-3 border">
                <div class="text-gray-500 text-center p-4">Ø³Ù„Ø§Ù…! Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§ÛŒÙ†Ùˆ Ù‡Ø³ØªÙ…. Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ</div>
            </div>
            <div class="flex gap-2">
                <input id="ai-chat-input" type="text" class="flex-grow p-2 border rounded-lg" placeholder="Ù¾ÛŒØ§Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³...">
                <button onclick="sendAiChatMessage()" class="p-2 bg-teal-500 text-white rounded-lg"><i data-lucide="send"></i></button>
            </div>
        `;
        showModal('Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯', content);
        lucide.createIcons();
    };

    const sendAiChatMessage = async () => {
        const input = document.getElementById('ai-chat-input');
        const history = document.getElementById('ai-chat-history');
        const userMessage = input.value.trim();
        if (!userMessage) return;

        history.innerHTML += `<div class="text-left my-1"><span class="bg-blue-500 text-white p-2 rounded-lg inline-block">${userMessage}</span></div>`;
        input.value = '';
        history.scrollTop = history.scrollHeight;
        
        const thinking = document.createElement('div');
        thinking.className = "text-right my-1";
        thinking.innerHTML = `<span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">...Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†</span>`;
        history.appendChild(thinking);
        history.scrollTop = history.scrollHeight;

        const aiResponse = await getAiSuggestion(userMessage);
        
        thinking.remove();
        history.innerHTML += `<div class="text-right my-1"><span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">${aiResponse}</span></div>`;
        history.scrollTop = history.scrollHeight;
    };

    // --- CLIENT: TESTS ---
    const psychologicalTests = [
        { id: 'phq9', name: 'ØªØ³Øª Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ (PHQ-9)', questions: [
            "Ø¹Ø¯Ù… Ø¹Ù„Ø§Ù‚Ù‡ ÛŒØ§ Ù„Ø°Øª Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø±Ù‡Ø§", "Ø§Ø­Ø³Ø§Ø³ Ù†Ø§Ø±Ø§Ø­ØªÛŒØŒ Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ ÛŒØ§ Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ", "Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¨Ù‡ Ø®ÙˆØ§Ø¨ Ø±ÙØªÙ†ØŒ Ø¯Ø± Ø®ÙˆØ§Ø¨ Ù…Ø§Ù†Ø¯Ù† ÛŒØ§ Ø®ÙˆØ§Ø¨ Ø²ÛŒØ§Ø¯", "Ø§Ø­Ø³Ø§Ø³ Ø®Ø³ØªÚ¯ÛŒ ÛŒØ§ Ú©Ù…Ø¨ÙˆØ¯ Ø§Ù†Ø±Ú˜ÛŒ", "Ú©Ù… Ø§Ø´ØªÙ‡Ø§ÛŒÛŒ ÛŒØ§ Ù¾Ø±Ø®ÙˆØ±ÛŒ", "Ø§Ø­Ø³Ø§Ø³ Ø¨Ø¯ÛŒ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø®ÙˆØ¯ØŒ ÛŒØ§ Ø§ÛŒÙ†Ú©Ù‡ ÛŒÚ© Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯Ù‡ Ù‡Ø³ØªÛŒØ¯", "Ù…Ø´Ú©Ù„ Ø¯Ø± ØªÙ…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† Ø±ÙˆÛŒ Ú©Ø§Ø±Ù‡Ø§", "Ú©Ù†Ø¯ Ø´Ø¯Ù† Ø¯Ø± Ø­Ø±Ú©Øª ÛŒØ§ ØµØ­Ø¨Øª Ú©Ø±Ø¯Ù†ØŒ ÛŒØ§ Ø¨Ø±Ø¹Ú©Ø³ Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø±ÛŒ", "Ø§ÙÚ©Ø§Ø± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø¨Ù…ÛŒØ±ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ Ø®ÙˆØ¯ Ø¢Ø³ÛŒØ¨ Ø¨Ø²Ù†ÛŒØ¯"
        ], options: ["Ø§ØµÙ„Ø§", "Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ²", "Ø¨ÛŒØ´ Ø§Ø² Ù†ÛŒÙ…ÛŒ Ø§Ø² Ø±ÙˆØ²Ù‡Ø§", "ØªÙ‚Ø±ÛŒØ¨Ø§ Ù‡Ø± Ø±ÙˆØ²"], interpretation: (score) => {
            if (score <= 4) return "Ø¹Ù„Ø§Ø¦Ù… Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø­Ø¯Ø§Ù‚Ù„ÛŒ ÛŒØ§ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¢Ù†. ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§ Ø®ÙˆØ¨ Ø§Ø³Øª.";
            if (score <= 9) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø®ÙÛŒÙ. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.";
            if (score <= 14) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ù…ØªÙˆØ³Ø·. Ù…Ø´ÙˆØ±Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.";
            if (score <= 19) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ù†Ø³Ø¨ØªØ§ Ø´Ø¯ÛŒØ¯. Ø­ØªÙ…Ø§ Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯.";
            return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø´Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÙÙˆØ±Ø§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù…Ú© Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯.";
        }},
        { id: 'gad7', name: 'ØªØ³Øª Ø§Ø¶Ø·Ø±Ø§Ø¨ (GAD-7)', questions: [
            "Ø§Ø­Ø³Ø§Ø³ Ø¹ØµØ¨Ø§Ù†ÛŒØªØŒ Ø§Ø¶Ø·Ø±Ø§Ø¨ ÛŒØ§ Ø¯Ù„Ø´ÙˆØ±Ù‡", "Ø¹Ø¯Ù… ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø¯Ø± Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† ÛŒØ§ Ú©Ù†ØªØ±Ù„ Ù†Ú¯Ø±Ø§Ù†ÛŒ", "Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ú†ÛŒØ²Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù", "Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¢Ø±Ø§Ù… Ø´Ø¯Ù†", "Ø¢Ù†Ù‚Ø¯Ø± Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø± Ø¨ÙˆØ¯Ù† Ú©Ù‡ Ù†Ø´Ø³ØªÙ† Ø³Ø®Øª Ø§Ø³Øª", "Ø²ÙˆØ¯Ø±Ù†Ø¬ ÛŒØ§ ØªØ­Ø±ÛŒÚ©â€ŒÙ¾Ø°ÛŒØ± Ø´Ø¯Ù†", "Ø§Ø­Ø³Ø§Ø³ ØªØ±Ø³ØŒ Ø§Ù†Ú¯Ø§Ø± Ú©Ù‡ Ø§ØªÙØ§Ù‚ ÙˆØ­Ø´ØªÙ†Ø§Ú©ÛŒ Ù‚Ø±Ø§Ø± Ø§Ø³Øª Ø¨ÛŒÙØªØ¯"
        ], options: ["Ø§ØµÙ„Ø§", "Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ²", "Ø¨ÛŒØ´ Ø§Ø² Ù†ÛŒÙ…ÛŒ Ø§Ø² Ø±ÙˆØ²Ù‡Ø§", "ØªÙ‚Ø±ÛŒØ¨Ø§ Ù‡Ø± Ø±ÙˆØ²"], interpretation: (score) => {
            if (score <= 4) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø­Ø¯Ø§Ù‚Ù„ÛŒ. ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§ Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³Øª.";
            if (score <= 9) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø®ÙÛŒÙ. Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ø®ÙˆØ¯ Ø±Ø§ ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯.";
            if (score <= 14) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…ØªÙˆØ³Ø·. Ù…Ø´ÙˆØ±Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙÛŒØ¯ Ø¨Ø§Ø´Ø¯.";
            return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø´Ø¯ÛŒØ¯. ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¯Ø±Ù…Ø§Ù† Ø¨Ù‡ Ù…ØªØ®ØµØµ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.";
        }}
    ];

    const renderClientTests = async () => {
        const page = document.getElementById('client-tests-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ</h1>
                <div id="test-list" class="space-y-4">
                    ${psychologicalTests.map(test => `
                        <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-lg">${test.name}</h2>
                                <p class="text-sm text-gray-500">${test.questions.length} Ø³ÙˆØ§Ù„</p>
                            </div>
                            <button onclick="startTest('${test.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold">Ø´Ø±ÙˆØ¹</button>
                        </div>
                    `).join('')}
                </div>
                <div id="test-container" class="hidden mt-6 bg-white p-4 rounded-2xl shadow-md"></div>
            </div>
        `;
        lucide.createIcons();
    };

    const startTest = (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        const testContainer = document.getElementById('test-container');
        document.getElementById('test-list').classList.add('hidden');
        testContainer.classList.remove('hidden');
        
        let questionsHTML = `<h2 class="text-xl font-bold mb-4">${test.name}</h2>`;
        test.questions.forEach((q, index) => {
            questionsHTML += `
                <div class="mb-6">
                    <p class="font-semibold mb-2">${index + 1}. ${q}</p>
                    <div class="flex flex-wrap gap-2">
                        ${test.options.map((opt, optIndex) => `
                            <label class="flex items-center space-x-2 space-x-reverse border p-2 rounded-lg cursor-pointer">
                                <input type="radio" name="q${index}" value="${optIndex}" class="form-radio text-teal-500">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        questionsHTML += `<button onclick="submitTest('${testId}')" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ØªÛŒØ¬Ù‡</button>`;
        testContainer.innerHTML = questionsHTML;
    };

    const resetTestsPage = () => {
        document.getElementById('test-list').classList.remove('hidden');
        const testContainer = document.getElementById('test-container');
        testContainer.classList.add('hidden');
        testContainer.innerHTML = '';
    };

    const submitTest = async (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        let score = 0;
        let answeredAll = true;
        for (let i = 0; i < test.questions.length; i++) {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if (selected) {
                score += parseInt(selected.value);
            } else {
                answeredAll = false;
                break;
            }
        }

        if (!answeredAll) {
            showToast('Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø³ÙˆØ§Ù„Ø§Øª Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯.', 'error');
            return;
        }

        const resultText = test.interpretation(score);
        showLoading();
        const { error } = await db.from('test_results').insert({
            user_id: currentUser.id,
            test_name: test.name,
            score: score,
            result_text: resultText
        });
        hideLoading();
        if(error){
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª.', 'error');
        } else {
            showToast('Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
        }

        const testContainer = document.getElementById('test-container');
        testContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª ${test.name}</h2>
            <p class="text-gray-700 mb-2">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: <span class="font-bold">${score}</span></p>
            <p class="text-gray-800 bg-gray-100 p-3 rounded-lg">${resultText}</p>
            <button onclick="resetTestsPage()" class="mt-4 w-full bg-gray-500 text-white py-2 rounded-lg">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ØªØ³Øªâ€ŒÙ‡Ø§</button>
        `;
    };

    // --- CLIENT: APPOINTMENTS ---
    const renderClientAppointments = async () => {
        const page = document.getElementById('client-appointments-page');
        showLoading();
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù† Ùˆ Ø±Ø²Ø±Ùˆ Ø¬Ø¯ÛŒØ¯</h1>
                <div id="appointments-list" class="space-y-4">
                    <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§...</p>
                </div>
                <div class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯</h2>
                    <div id="therapist-booking-section" class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                        <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³Ø§Ù†...</p>
                    </div>
                </div>
            </div>
        `;
        await loadClientAppointments();
        await loadTherapistsForBooking();
        hideLoading();
        lucide.createIcons();
    };
    
    const loadClientAppointments = async () => {
        const listEl = document.getElementById('appointments-list');
        const { data, error } = await db
            .from('appointments')
            .select(`id, appointment_time, status, therapist:therapist_id ( id, full_name )`)
            .eq('client_id', currentUser.id)
            .order('appointment_time', { ascending: false });

        if (error) {
            console.error("Error loading appointments:", error);
            listEl.innerHTML = `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.</p>`;
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù†ÙˆØ¨Øª Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>`;
            return;
        }

        listEl.innerHTML = data.map(apt => {
            if (!apt.therapist) {
                return ''; 
            }
            return `
            <div class="bg-white p-4 rounded-2xl shadow-md">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">Ø¯Ú©ØªØ± ${apt.therapist.full_name}</p>
                        <p class="text-sm text-gray-600">${new persianDate(new Date(apt.appointment_time)).format('dddd D MMMM - Ø³Ø§Ø¹Øª HH:mm')}</p>
                        <p class="text-xs font-semibold text-teal-700 mt-1">Ø¬Ù„Ø³Ù‡ Ø­Ø¶ÙˆØ±ÛŒ</p>
                    </div>
                    <span class="text-sm font-semibold px-3 py-1 rounded-full ${apt.status === 'booked' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${apt.status === 'booked' ? 'Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡' : 'Ù„ØºÙˆ Ø´Ø¯Ù‡'}</span>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="startChatWith('${apt.therapist.id}')" class="flex-1 bg-teal-500 text-white py-2 rounded-lg text-sm">Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³</button>
                    ${apt.status === 'booked' ? `<button onclick="cancelAppointment(${apt.id})" class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm">Ù„ØºÙˆ Ù†ÙˆØ¨Øª</button>` : ''}
                </div>
            </div>
        `}).join('');
    };
    
    const loadTherapistsForBooking = async () => {
        const sectionEl = document.getElementById('therapist-booking-section');
        const { data, error } = await db.from('profiles').select('id, full_name').eq('role', 'therapist');

        if (error) {
            sectionEl.innerHTML = `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³Ø§Ù†.</p>`;
            return;
        }
        
        sectionEl.innerHTML = `
            <div>
                <label for="therapist-select" class="block text-sm font-medium text-gray-700">Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³</label>
                <select id="therapist-select" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                    ${data.map(t => `<option value="${t.id}">Ø¯Ú©ØªØ± ${t.full_name}</option>`).join('')}
                </select>
            </div>
            <div>
                <label for="appointment-date" class="block text-sm font-medium text-gray-700">Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</label>
                <input type="text" id="appointment-date" readonly class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white cursor-pointer" placeholder="Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯">
                <p class="text-xs text-gray-500 mt-1">ØªÙˆØ¬Ù‡: ØªÙ…Ø§Ù… Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ø­Ø¶ÙˆØ±ÛŒ Ù‡Ø³ØªÙ†Ø¯.</p>
            </div>
            <button onclick="bookAppointment()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Ø±Ø²Ø±Ùˆ Ù†Ù‡Ø§ÛŒÛŒ</button>
        `;
        
        $('#appointment-date').persianDatepicker({
            format: 'YYYY/MM/DD HH:mm',
            timePicker: { enabled: true },
            minDate: new persianDate(),
            observer: true,
            autoClose: true,
            onSelect: function(unix) {
                selectedAppointmentTimestamp = unix;
            }
        });
    };

    const bookAppointment = async () => {
        const therapistId = document.getElementById('therapist-select').value;
        
        if (!selectedAppointmentTimestamp) {
            showToast('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }
        
        const appointmentTime = new Date(selectedAppointmentTimestamp).toISOString();
        
        showLoading();
        const { error } = await db.from('appointments').insert({
            client_id: currentUser.id,
            therapist_id: therapistId,
            appointment_time: appointmentTime
        });
        hideLoading();

        if (error) {
            if (error.code === '23505') { 
                 showToast('Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ù‚Ø¨Ù„Ø§ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø²Ù…Ø§Ù† Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
            } else {
                 showToast('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
            }
            console.error("Booking Error:", error);
        } else {
            showToast('Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø²Ø±Ùˆ Ø´Ø¯.', 'success');
            selectedAppointmentTimestamp = null; 
            await renderClientAppointments();
            await renderClientDashboard(); 
        }
    };
    
    const cancelAppointment = async (id) => {
        showLoading();
        const { error } = await db.from('appointments').update({ status: 'cancelled' }).eq('id', id);
        hideLoading();
        if(error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª.', 'error');
        } else {
            showToast('Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯.', 'success');
            await loadClientAppointments();
        }
    };

    // --- CLIENT: PROFILE ---
    const renderClientProfile = async () => {
        const page = document.getElementById('client-profile-page');
        page.classList.add('bg-gradient-to-b', 'from-teal-400', 'to-blue-500');

        page.innerHTML = `
            <div class="p-4 space-y-6">
                <div onclick="openProfileEditor()" class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-lg flex items-center justify-between cursor-pointer active:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full bg-teal-100 flex items-center justify-center">
                            <i data-lucide="user" class="w-8 h-8 text-teal-600"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</p>
                            <p class="text-sm text-gray-500">${userProfile.full_name || 'Ú©Ø§Ø±Ø¨Ø± Ù…Ù‡Ù…Ø§Ù†'}</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-left" class="text-gray-400"></i>
                </div>

                <div class="bg-white p-2 rounded-2xl shadow-md">
                    <a href="#" onclick="showWallet()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="wallet" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ø§Ø¹ØªØ¨Ø§Ø± Ú©ÛŒÙ Ù¾ÙˆÙ„</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <a href="#" onclick="viewTestHistory()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="clipboard-list" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ø³ÙˆØ§Ø¨Ù‚ ØªØ³Øªâ€ŒÙ‡Ø§</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <a href="#" onclick="showSupportRequest()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="headphones" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <a href="#" onclick="showFaq()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="help-circle" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <a href="#" onclick="showAboutUs()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="info" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <a href="#" onclick="showTerms()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <i data-lucide="file-text" class="text-gray-600"></i>
                            <span class="font-semibold text-gray-700">Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                    <div class="border-t my-1 mx-2"></div>
                    <a href="#" onclick="handleLogout()" class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg text-red-500">
                        <div class="flex items-center gap-4">
                            <i data-lucide="log-out"></i>
                            <span class="font-semibold">Ø®Ø±ÙˆØ¬</span>
                        </div>
                        <i data-lucide="chevron-left" class="text-gray-400"></i>
                    </a>
                </div>

                <p class="text-center text-white/70 text-sm">Ù†Ø³Ø®Ù‡ Û±.Û°.Û´</p>
            </div>
        `;
        lucide.createIcons();
    };
    
    const openProfileEditor = () => {
        const content = `
            <div class="space-y-4">
                <div class="space-y-2">
                    <label for="modal-fullname-input" class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                    <input id="modal-fullname-input" type="text" class="w-full p-2 border rounded-lg" value="${userProfile.full_name || ''}">
                </div>
                <div class="space-y-2">
                    <label for="modal-bio-input" class="block text-sm font-medium text-gray-700">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="modal-bio-input" class="w-full h-24 p-2 border rounded-lg" placeholder="Ú©Ù…ÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø®ÙˆØ¯ØªØ§Ù† Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">${userProfile.bio || ''}</textarea>
                </div>
                <button id="save-profile-btn" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </div>
        `;
        showModal('ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ', content);
        
        document.getElementById('save-profile-btn').onclick = async () => {
            const newName = document.getElementById('modal-fullname-input').value;
            const newBio = document.getElementById('modal-bio-input').value;
            
            closeModal(); 
            showLoading();
            const { data, error } = await db.from('profiles').update({ 
                full_name: newName,
                bio: newBio
            }).eq('id', currentUser.id).select().single();
            hideLoading();
            
            if (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.', 'error');
            } else {
                userProfile = data;
                showToast('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
                await renderClientProfile();
            }
        };
    };

    const showWallet = () => {
        showModal('Ø§Ø¹ØªØ¨Ø§Ø± Ú©ÛŒÙ Ù¾ÙˆÙ„', '<p>Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. Ø§Ø¹ØªØ¨Ø§Ø± ÙØ¹Ù„ÛŒ Ø´Ù…Ø§: Û° ØªÙˆÙ…Ø§Ù†</p>');
    };

    const showSupportRequest = () => {
        const content = `
            <p class="mb-4">Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ support@saino.app Ø¯Ø± ØªÙ…Ø§Ø³ Ø¨Ø§Ø´ÛŒØ¯ ÛŒØ§ ÙØ±Ù… Ø²ÛŒØ± Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.</p>
            <form id="support-form">
                <textarea class="w-full h-32 p-2 border rounded-lg" placeholder="Ù…Ø´Ú©Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø´Ø±Ø­ Ø¯Ù‡ÛŒØ¯..."></textarea>
                <button type="submit" class="mt-2 w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
            </form>
        `;
        showModal('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', content);
        document.getElementById('support-form').addEventListener('submit', (e) => {
            e.preventDefault();
            closeModal();
            showToast('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯. Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ….', 'success');
        });
    };

    const showFaq = () => {
        const content = `
            <div class="space-y-4">
                <div>
                    <h4 class="font-bold">Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ù†ÙˆØ¨Øª Ø±Ø²Ø±Ùˆ Ú©Ù†Ù…ØŸ</h4>
                    <p class="text-sm text-gray-600">Ø§Ø² Ù…Ù†ÙˆÛŒ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ Ø¨Ù‡ Ø¨Ø®Ø´ Â«Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§Â» Ø¨Ø±ÙˆÛŒØ¯ Ùˆ Ù¾Ø³ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ØŒ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</p>
                </div>
                <div>
                    <h4 class="font-bold">Ø¢ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù† Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯ØŸ</h4>
                    <p class="text-sm text-gray-600">Ø¨Ù„Ù‡ØŒ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ØŒ Ø§Ø² Ø¬Ù…Ù„Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§ØŒ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ø¨ÙˆØ¯Ù‡ Ùˆ ÙÙ‚Ø· ØªÙˆØ³Ø· Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ Ù…Ø¹Ø§Ù„Ø¬ Ø´Ù…Ø§ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª.</p>
                </div>
            </div>
        `;
        showModal('Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„', content);
    };

    const showAboutUs = () => {
        const content = '<p>Ø³Ø§ÛŒÙ†Ùˆ ÛŒÚ© Ù¾Ù„ØªÙØ±Ù… Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ùˆ Ø¨Ù‡Ø¨ÙˆØ¯ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø§Ø³Øª Ú©Ù‡ Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¨Ø§ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³Ø§Ù† Ù…ØªØ®ØµØµ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ø´ÛŒØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ú©Ù†ÛŒØ¯.</p>';
        showModal('Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø³Ø§ÛŒÙ†Ùˆ', content);
    };

    const showTerms = () => {
        const content = '<p>Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø³Ø§ÛŒÙ†Ùˆ Ø¨Ù‡ Ù…Ù†Ø²Ù„Ù‡ Ù¾Ø°ÛŒØ±Ø´ ØªÙ…Ø§Ù… Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ø³Øª. Ø§ÛŒÙ† Ù¾Ù„ØªÙØ±Ù… Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¯Ø±Ù…Ø§Ù† Ø§ÙˆØ±Ú˜Ø§Ù†Ø³ÛŒ Ù†ÛŒØ³Øª. Ø¯Ø± Ù…ÙˆØ§Ø±Ø¯ Ø­Ø§Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø§ÙˆØ±Ú˜Ø§Ù†Ø³ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ (Û±Û²Û³) ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.</p>';
        showModal('Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª', content);
    };

    const viewTestHistory = async () => {
        showLoading();
        const { data, error } = await db.from('test_results')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        hideLoading();

        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§', 'error');
            return;
        }

        let content = '<p class="text-center text-gray-500">Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';

        if (data && data.length > 0) {
            content = `
                <div class="space-y-4">
                ${data.map(test => `
                    <div class="p-3 bg-gray-50 rounded-lg border">
                        <p class="font-bold">${test.test_name}</p>
                        <p class="text-sm text-gray-500 mb-2">${new persianDate(new Date(test.created_at)).format('L')}</p>
                        <p class="text-sm"><strong>Ø§Ù…ØªÛŒØ§Ø²: ${test.score}</strong> - ${test.result_text}</p>
                    </div>
                `).join('')}
                </div>
            `;
        }
        
        showModal('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§', content);
    };

    // =================================================================
    // THERAPIST-SIDE RENDERING & LOGIC
    // =================================================================

    // --- THERAPIST: DASHBOARD ---
    const renderTherapistDashboard = async () => {
        const page = document.getElementById('therapist-dashboard-page');
        showLoading();
        const { data: appointments, error: aptError } = await db
            .from('appointments')
            .select('id, appointment_time, client:client_id(id, full_name)')
            .eq('therapist_id', currentUser.id)
            .eq('status', 'booked')
            .gte('appointment_time', new Date().toISOString())
            .order('appointment_time', { ascending: true })
            .limit(5);

        const { count: clientCount, error: clientError } = await db
            .from('therapist_clients_view')
            .select('client_id', { count: 'exact', head: true })
            .eq('therapist_id', currentUser.id);
            
        hideLoading();

        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ú©ØªØ± ${userProfile.full_name.split(' ').slice(1).join(' ') || userProfile.full_name}</h1>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-teal-600">${appointments?.length || 0}</p>
                        <p class="text-gray-500">Ù†ÙˆØ¨Øª Ø¢ÛŒÙ†Ø¯Ù‡</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-blue-600">${clientCount || 0}</p>
                        <p class="text-gray-500">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´ Ø±Ùˆ</h2>
                    <div class="space-y-3">
                        ${aptError ? '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>' : ''}
                        ${appointments && appointments.length > 0 ? appointments.map(apt => `
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                                <div>
                                    <p class="font-semibold">${apt.client.full_name}</p>
                                    <p class="text-sm text-gray-500">${new persianDate(new Date(apt.appointment_time)).format('dddd D MMMM - HH:mm')}</p>
                                </div>
                                <button onclick="startChatWith('${apt.client.id}')" class="text-teal-600"><i data-lucide="message-square"></i></button>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500">Ù†ÙˆØ¨Øª Ù†Ø²Ø¯ÛŒÚ©ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>'}
                    </div>
                </div>
            </div>
        `;
        lucide.createIcons();
    };

    // --- THERAPIST: CLIENTS ---
    const renderTherapistClients = async () => {
        const page = document.getElementById('therapist-clients-page');
        showLoading();
        const { data: clients, error } = await db
            .from('therapist_clients_view')
            .select('client_id, client_full_name, client_email')
            .eq('therapist_id', currentUser.id);
        hideLoading();

        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ù„ÛŒØ³Øª Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</h1>
                <div id="client-list-container" class="space-y-3">
                    ${error ? '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>' : ''}
                    ${clients && clients.length > 0 ? clients.map(client => `
                        <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                            <div>
                                <p class="font-bold">${client.client_full_name}</p>
                                <p class="text-sm text-gray-500">${client.client_email}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="viewClientDetails('${client.client_id}')" class="p-2 bg-gray-100 rounded-lg text-gray-600"><i data-lucide="eye"></i></button>
                                <button onclick="startChatWith('${client.client_id}')" class="p-2 bg-teal-100 rounded-lg text-teal-600"><i data-lucide="message-square"></i></button>
                            </div>
                        </div>
                    `).join('') : '<p class="text-center text-gray-500">Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù…Ø±Ø§Ø¬Ø¹Ù‡â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>'}
                </div>
            </div>
        `;
        lucide.createIcons();
    };

    const viewClientDetails = async (clientId) => {
        showLoading();
        const { data: profile, error: pError } = await db.from('profiles').select('full_name, bio').eq('id', clientId).single();
        const { data: moods, error: mError } = await db.from('mood_entries').select('mood_score, created_at').eq('user_id', clientId).order('created_at', {ascending: false}).limit(7);
        const { data: tests, error: tError } = await db.from('test_results').select('*').eq('user_id', clientId).order('created_at', {ascending: false}).limit(5);
        hideLoading();

        let content = `<div class="space-y-4">`;
        
        if (pError) {
            content += `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø±Ø§Ø¬Ø¹.</p>`;
        } else {
            content += `
                ${profile.bio ? `<div><h4 class="font-bold text-md mb-2">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ Ù…Ø±Ø§Ø¬Ø¹</h4><p class="text-sm bg-gray-100 p-2 rounded-lg">${profile.bio}</p></div>` : ''}
                <div>
                    <h4 class="font-bold text-md mb-2">Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ø§Ø®ÛŒØ±</h4>
                    ${mError ? '<p class="text-red-500">Ø®Ø·Ø§</p>' : moods.length > 0 ? `<div class="h-48"><canvas id="clientMoodChart"></canvas></div>` : '<p class="text-sm text-gray-500">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>'}
                </div>
                <div>
                    <h4 class="font-bold text-md mb-2">Ø¢Ø®Ø±ÛŒÙ† Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§</h4>
                    ${tError ? '<p class="text-red-500">Ø®Ø·Ø§</p>' : tests.length > 0 ? `
                        <ul class="list-disc pr-5 space-y-2 text-sm">
                            ${tests.map(t => `<li><strong>${t.test_name}:</strong> ${t.result_text} (Ø§Ù…ØªÛŒØ§Ø²: ${t.score})</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">Ù†ØªÛŒØ¬Ù‡ ØªØ³ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                </div>
            `;
        }
        content += `</div>`;

        showModal(`Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø±Ø§Ø¬Ø¹: ${profile?.full_name || ''}`, content);
        
        if(moods && moods.length > 0) {
            const labels = moods.map(d => new persianDate(new Date(d.created_at)).format('D MMM')).reverse();
            const scores = moods.map(d => d.mood_score).reverse();
            const ctx = document.getElementById('clientMoodChart').getContext('2d');
            
            if (clientMoodChartInstance) clientMoodChartInstance.destroy();

            clientMoodChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Ù†Ù…Ø±Ù‡ Ø­Ø§Ù„', 
                        data: scores, 
                        backgroundColor: 'rgba(20, 184, 166, 0.5)',
                        borderColor: 'rgb(20, 184, 166)',
                        borderWidth: 1,
                        borderRadius: 8,
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 5 } },
                    plugins: { legend: { display: false } }
                } 
            });
        }
    };

    // --- THERAPIST: SCHEDULE ---
    const renderTherapistSchedule = async () => {
        const page = document.getElementById('therapist-schedule-page');
        showLoading();
        const { data, error } = await db
            .from('appointments')
            .select('id, appointment_time, status, client:client_id(full_name)')
            .eq('therapist_id', currentUser.id)
            .order('appointment_time', { ascending: true });
        hideLoading();

        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ø±ÛŒ Ø´Ù…Ø§</h1>
                <div class="space-y-4">
                    ${error ? '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>' : ''}
                    ${data && data.length > 0 ? data.map(apt => `
                        <div class="bg-white p-4 rounded-2xl shadow-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg">${apt.client ? apt.client.full_name : 'Ù…Ø±Ø§Ø¬Ø¹ Ø­Ø°Ù Ø´Ø¯Ù‡'}</p>
                                    <p class="text-sm text-gray-600">${new persianDate(new Date(apt.appointment_time)).format('dddd D MMMM - Ø³Ø§Ø¹Øª HH:mm')}</p>
                                    <p class="text-xs font-semibold text-teal-700 mt-1">Ø¬Ù„Ø³Ù‡ Ø­Ø¶ÙˆØ±ÛŒ</p>
                                </div>
                                <span class="text-sm font-semibold px-3 py-1 rounded-full ${apt.status === 'booked' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${apt.status === 'booked' ? 'Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡' : 'Ù„ØºÙˆ Ø´Ø¯Ù‡'}</span>
                            </div>
                        </div>
                    `).join('') : '<p class="text-center text-gray-500">Ù‡ÛŒÚ† Ù†ÙˆØ¨ØªÛŒ Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                </div>
            </div>
        `;
    };

    // --- THERAPIST: PROFILE ---
    const renderTherapistProfile = async () => {
        const page = document.getElementById('therapist-profile-page');
        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col items-center space-y-2">
                    <div class="w-24 h-24 rounded-full bg-blue-500 text-white flex items-center justify-center text-4xl font-bold">
                        ${userProfile.full_name.charAt(0)}
                    </div>
                    <h1 class="text-2xl font-bold">Ø¯Ú©ØªØ± ${userProfile.full_name}</h1>
                    <p class="text-gray-500">${currentUser.email}</p>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                    <h2 class="text-lg font-bold">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ØªØ®ØµØµÛŒ</h2>
                    <div class="space-y-2">
                        <label for="therapist-fullname-input" class="block text-sm font-medium text-gray-700">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                        <input id="therapist-fullname-input" type="text" class="w-full p-2 border rounded-lg" value="${userProfile.full_name || ''}">
                    </div>
                     <div class="space-y-2">
                        <label for="therapist-specialization-input" class="block text-sm font-medium text-gray-700">ØªØ®ØµØµâ€ŒÙ‡Ø§</label>
                        <input id="therapist-specialization-input" type="text" class="w-full p-2 border rounded-lg" placeholder="Ù…Ø«Ø§Ù„: CBT, Ø±ÙˆØ§Ù†Ú©Ø§ÙˆÛŒ" value="${userProfile.specialization || ''}">
                    </div>
                     <div class="space-y-2">
                        <label for="therapist-experience-input" class="block text-sm font-medium text-gray-700">Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡</label>
                        <input id="therapist-experience-input" type="number" class="w-full p-2 border rounded-lg" placeholder="Ù…Ø«Ø§Ù„: 5" value="${userProfile.experience_years || ''}">
                    </div>
                    <div class="space-y-2">
                        <label for="therapist-bio-input" class="block text-sm font-medium text-gray-700">Ø¨ÛŒÙˆÚ¯Ø±Ø§ÙÛŒ ØªØ®ØµØµÛŒ</label>
                        <textarea id="therapist-bio-input" class="w-full h-24 p-2 border rounded-lg" placeholder="Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø³ÙˆØ§Ø¨Ù‚ Ùˆ Ø±ÙˆÛŒÚ©Ø±Ø¯ Ø¯Ø±Ù…Ø§Ù†ÛŒ Ø®ÙˆØ¯ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">${userProfile.bio || ''}</textarea>
                    </div>
                    <button onclick="updateTherapistProfile()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                </div>

                <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
            </div>
        `;
        lucide.createIcons();
    };

    const updateTherapistProfile = async () => {
        const newName = document.getElementById('therapist-fullname-input').value;
        const newBio = document.getElementById('therapist-bio-input').value;
        const newSpec = document.getElementById('therapist-specialization-input').value;
        const newExp = document.getElementById('therapist-experience-input').value;

        showLoading();
        const { data, error } = await db.from('profiles').update({ 
            full_name: newName,
            bio: newBio,
            specialization: newSpec,
            experience_years: newExp ? parseInt(newExp) : null
        }).eq('id', currentUser.id).select().single();
        hideLoading();
        
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.', 'error');
            console.error(error);
        } else {
            userProfile = data;
            showToast('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
            await renderTherapistProfile();
        }
    };

    // =================================================================
    // SHARED: CHAT PAGE
    // =================================================================
    const startChatWith = async (otherUserId) => {
        const page = document.getElementById('chat-page');
        const { data: otherUser, error } = await db.from('profiles').select('id, full_name').eq('id', otherUserId).single();
        if (error) {
            showToast('Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
            return;
        }

        page.innerHTML = `
            <header class="bg-white shadow-sm p-4 flex items-center gap-4 flex-shrink-0">
                <button onclick="goBackFromChat()" class="text-gray-600"><i data-lucide="arrow-right"></i></button>
                <h1 class="font-bold text-lg">${otherUser.full_name}</h1>
            </header>
            <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto">
            </div>
            <footer class="bg-white p-2 flex items-center gap-2 border-t flex-shrink-0">
                <input id="chat-input" type="text" class="flex-grow bg-gray-100 rounded-full py-2 px-4 focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                <button id="send-chat-btn" class="bg-teal-500 text-white w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0">
                    <i data-lucide="send"></i>
                </button>
            </footer>
        `;
        lucide.createIcons();
        page.style.padding = '0'; 
        navigateTo('chat-page');

        const messageContainer = document.getElementById('chat-messages');
        const sendBtn = document.getElementById('send-chat-btn');
        const chatInput = document.getElementById('chat-input');
        
        const renderMessage = (msg) => {
            const isMe = msg.sender_id === currentUser.id;
            const time = new Date(msg.created_at).toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
            return `
                <div class="flex items-end gap-2 ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${isMe ? 'bg-teal-500 text-white rounded-br-lg' : 'bg-gray-200 text-gray-800 rounded-bl-lg'}">
                        <p>${msg.message_text}</p>
                        <p class="text-xs mt-1 ${isMe ? 'text-white/70' : 'text-gray-500'} text-left">${time}</p>
                    </div>
                </div>
            `;
        };

        const loadMessages = async () => {
            const { data: messages, error } = await db.from('chat_messages')
                .select('*')
                .in('sender_id', [currentUser.id, otherUserId])
                .in('receiver_id', [currentUser.id, otherUserId])
                .order('created_at', { ascending: true });
            
            if(messages) {
                messageContainer.innerHTML = messages.map(renderMessage).join('');
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }
        };

        await loadMessages();

        const handleSendMessage = async () => {
             const messageText = chatInput.value.trim();
            if (!messageText) return;
            
            chatInput.value = '';
            await db.from('chat_messages').insert({
                sender_id: currentUser.id,
                receiver_id: otherUserId,
                message_text: messageText
            });
        };

        sendBtn.onclick = handleSendMessage;
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSendMessage();
        });

        if (chatSubscription) chatSubscription.unsubscribe();

        chatSubscription = db.channel('public:chat_messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, 
            (payload) => {
                const newMessage = payload.new;
                if ((newMessage.sender_id === currentUser.id && newMessage.receiver_id === otherUserId) || 
                    (newMessage.sender_id === otherUserId && newMessage.receiver_id === currentUser.id)) {
                    messageContainer.innerHTML += renderMessage(newMessage);
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                }
            })
            .subscribe();
    };

    const goBackFromChat = () => {
        if (chatSubscription) {
            chatSubscription.unsubscribe();
            chatSubscription = null;
        }
        document.getElementById('chat-page').style.padding = ''; 
        navigateTo(lastPageId);
    };


    // =================================================================
    // ADMIN-SIDE RENDERING & LOGIC
    // =================================================================
    const renderAdminDashboard = async () => {
        const page = document.getElementById('admin-dashboard-page');
        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§ÛŒÙ†Ùˆ</h1>
                
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h2>
                    <div class="flex justify-between items-center">
                        <span>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Gemini)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="ai-toggle" class="sr-only peer" ${aiFeaturesEnabled ? 'checked' : ''}>
                          <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-teal-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
                    <div id="admin-user-list" class="space-y-2">
                        <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
                 <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬</button>
            </div>
        `;
        
        document.getElementById('ai-toggle').addEventListener('change', (e) => {
            aiFeaturesEnabled = e.target.checked;
            showToast(`ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ${aiFeaturesEnabled ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'} Ø´Ø¯.`, 'info');
        });

        await loadAllUsersForAdmin();
        lucide.createIcons();
    };
    
    const loadAllUsersForAdmin = async () => {
        const listEl = document.getElementById('admin-user-list');
        const { data, error } = await db.from('profiles').select('*');
        if(error) {
            listEl.innerHTML = '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.</p>';
            return;
        }
        listEl.innerHTML = data.map(user => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div>
                    <p class="font-semibold">${user.full_name}</p>
                    <p class="text-sm text-gray-500">${user.email}</p>
                </div>
                <span class="text-sm font-semibold px-3 py-1 rounded-full ${user.role === 'client' ? 'bg-green-100 text-green-800' : (user.role === 'therapist' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800')}">${user.role}</span>
            </div>
        `).join('');
    };

    // =================================================================
    // GLOBALLY ACCESSIBLE FUNCTIONS
    // =================================================================
    window.navigateTo = navigateTo;
    window.closeModal = closeModal;
    window.handleLogout = handleLogout;
    window.submitMood = submitMood;
    window.submitJournal = submitJournal;
    window.openAiChat = openAiChat;
    window.sendAiChatMessage = sendAiChatMessage;
    window.startTest = startTest;
    window.submitTest = submitTest;
    window.resetTestsPage = resetTestsPage;
    window.bookAppointment = bookAppointment;
    window.cancelAppointment = cancelAppointment;
    window.openProfileEditor = openProfileEditor;
    window.showWallet = showWallet;
    window.showSupportRequest = showSupportRequest;
    window.showFaq = showFaq;
    window.showAboutUs = showAboutUs;
    window.showTerms = showTerms;
    window.viewTestHistory = viewTestHistory;
    window.updateTherapistProfile = updateTherapistProfile;
    window.viewClientDetails = viewClientDetails;
    window.startChatWith = startChatWith;
    window.goBackFromChat = goBackFromChat;

</script>
</body>
</html>
