<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§ÛŒÙ†Ùˆ - Ø¯Ø³ØªÛŒØ§Ø± Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Persian Date Picker -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
    <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ø¨Ø±Ø§ÛŒ Ø­Ø³ Ø¨Ù‡ØªØ± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        html, body {
            height: 100%;
            overflow: hidden;
        }

        /* [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] ØªØºÛŒÛŒØ± Ø¯Ø± Ø³Ø§Ø®ØªØ§Ø± ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ Ù‡Ù…Ù¾ÙˆØ´Ø§Ù†ÛŒ */
        .page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f2f5;
            /* Ø®ÙˆØ¯ ØµÙØ­Ù‡ Ø§Ø³Ú©Ø±ÙˆÙ„ Ù…ÛŒâ€ŒØ®ÙˆØ±Ø¯ */
            overflow-y: auto;
            /* Ù¾Ø¯ÛŒÙ†Ú¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù‡Ù…Ù¾ÙˆØ´Ø§Ù†ÛŒ Ø¨Ø§ Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ Ùˆ Ù¾Ø§ÛŒÛŒÙ† */
            padding: 1rem;
            padding-bottom: 6rem; /* 4rem Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø± + 2rem ÙØ§ØµÙ„Ù‡ */
        }

        .page.active {
            display: block; /* ØªØºÛŒÛŒØ± Ø§Ø² flex Ø¨Ù‡ block */
            animation: slideIn 0.3s ease-out forwards;
        }
        
        /* Ø§ÛŒÙ† Ú©Ù„Ø§Ø³ Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
        .main-content { }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 4rem; /* h-16 */
        }

        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ ØµÙØ­Ø§Øª */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.visible {
            display: flex;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ DatePicker */
        .pdp-group {
            direction: ltr;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="fixed inset-0 bg-white/80 z-50 flex items-center justify-center backdrop-blur-sm hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-teal-500"></div>
    </div>

    <!-- =================================================================
         MODAL CONTAINER
    ================================================================== -->
    <div id="modal-container" class="modal-backdrop"></div>

    <!-- =================================================================
         AUTH PAGES (Login / Signup)
    ================================================================== -->
    <div id="auth-page" class="page active bg-gradient-to-br from-teal-400 to-blue-500">
        <div class="w-full max-w-md m-auto p-8">
            <div class="text-center mb-10">
                <h1 class="text-5xl font-bold text-white">Ø³Ø§ÛŒÙ†Ùˆ</h1>
                <p class="text-white/80 mt-2">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§</p>
            </div>
            
            <!-- Login Form -->
            <div id="login-form-container">
                <form id="login-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-6">
                    <h2 class="text-2xl font-bold text-white text-center">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-white">Ø§ÛŒÙ…ÛŒÙ„</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-white">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                    </div>
                    <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">ÙˆØ±ÙˆØ¯</button>
                    <p class="text-center text-sm text-white">
                        Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯ØŸ <a href="#" id="show-signup" class="font-bold hover:underline">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯</a>
                    </p>
                </form>
            </div>

            <!-- Signup Form -->
            <div id="signup-form-container" class="hidden">
                <form id="signup-form" class="bg-white/20 backdrop-blur-lg p-8 rounded-2xl shadow-lg space-y-4">
                    <h2 class="text-2xl font-bold text-white text-center">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</h2>
                    <div>
                        <label for="signup-fullname" class="block text-sm font-medium text-white">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                        <input type="text" id="signup-fullname" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-white">Ø§ÛŒÙ…ÛŒÙ„</label>
                        <input type="email" id="signup-email" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-white">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                        <input type="password" id="signup-password" required class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 placeholder-gray-600 focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="signup-role" class="block text-sm font-medium text-white">Ù†Ù‚Ø´ Ø´Ù…Ø§</label>
                        <select id="signup-role" class="mt-1 block w-full bg-white/50 border-0 rounded-lg py-2 px-3 text-gray-800 focus:ring-2 focus:ring-white">
                            <option value="client">Ù…Ø±Ø§Ø¬Ø¹</option>
                            <option value="therapist">Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-white text-teal-600 font-bold py-3 rounded-lg hover:bg-gray-100 transition duration-300 shadow-md">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
                    <p class="text-center text-sm text-white">
                        Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ <a href="#" id="show-login" class="font-bold hover:underline">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- =================================================================
         MAIN APP CONTAINER (Client, Therapist, Admin)
    ================================================================== -->
    <div id="app-container" class="hidden">
        <!-- Client Pages -->
        <div id="client-dashboard-page" class="page"></div>
        <div id="client-tests-page" class="page"></div>
        <div id="client-appointments-page" class="page"></div>
        <div id="client-profile-page" class="page"></div>

        <!-- Therapist Pages -->
        <div id="therapist-dashboard-page" class="page"></div>
        <div id="therapist-clients-page" class="page"></div>
        <div id="therapist-schedule-page" class="page"></div>
        <div id="therapist-profile-page" class="page"></div>
        
        <!-- Shared Pages -->
        <div id="chat-page" class="page"></div>

        <!-- Admin Page -->
        <div id="admin-dashboard-page" class="page"></div>
        
        <!-- Bottom Navigation Bar -->
        <div id="bottom-nav-bar" class="bottom-nav bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
            <!-- Navigation will be injected here by JS -->
        </div>
    </div>

<script type="module">
    // =================================================================
    // CONFIGURATION
    // =================================================================
    const SUPABASE_URL = 'https://atrhsfozgnfhhbfxgsnu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0cmhzZm96Z25maGhiZnhnc251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NjQ3MTYsImV4cCI6MjA2NjQ0MDcxNn0.eGODASElOsWJZ_cXmumZZwdQlcBGahm89n2UCuUxWk8';
    const GEMINI_API_KEY = 'AIzaSyA1NgJyXJUK85SaZm8ZR4qp9EE64vWmoxE'; // Updated API Key
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`;
    
    // =================================================================
    // INITIALIZATION
    // =================================================================
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Global state
    let currentUser = null;
    let userProfile = null;
    let aiFeaturesEnabled = true; // Default state for AI features
    let chatSubscription = null;
    let moodChartInstance = null; // To hold the chart instance
    let clientMoodChartInstance = null;

    // =================================================================
    // UTILITY & HELPER FUNCTIONS
    // =================================================================

    const showLoading = () => document.getElementById('loading-spinner').classList.remove('hidden');
    const hideLoading = () => document.getElementById('loading-spinner').classList.add('hidden');

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„
    const showModal = (title, content, actions = []) => {
        const modalContainer = document.getElementById('modal-container');
        const modalHTML = `
            <div class="modal-content animate-fade-in-up">
                <h3 class="text-lg font-bold text-gray-800 mb-4">${title}</h3>
                <div class="text-gray-600">${content}</div>
                <div class="flex justify-end gap-2 mt-6">
                    ${actions.map(action => `<button class="${action.className}" onclick="${action.handler}">${action.text}</button>`).join('')}
                    <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" onclick="closeModal()">Ø¨Ø³ØªÙ†</button>
                </div>
            </div>
        `;
        modalContainer.innerHTML = modalHTML;
        modalContainer.classList.add('visible');
    };

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
    const closeModal = () => {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.classList.remove('visible');
        modalContainer.innerHTML = '';
    };
    window.closeModal = closeModal;

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… (Toast)
    const showToast = (message, type = 'success') => {
        const toastColors = {
            success: 'bg-green-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        const toast = document.createElement('div');
        toast.className = `fixed top-5 right-5 ${toastColors[type]} text-white py-2 px-4 rounded-lg shadow-lg z-[3000] animate-slide-in-right`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    };

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¨ÛŒÙ† ØµÙØ­Ø§Øª
    const navigateTo = (pageId) => {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
            targetPage.scrollTop = 0; // Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù†
        }
        
        // Ø¢Ù¾Ø¯ÛŒØª Ø­Ø§Ù„Øª ÙØ¹Ø§Ù„ Ø¯Ø± Ù†ÙˆÛŒÚ¯ÛŒØ´Ù†
        const navId = `nav-${pageId.split('-')[1]}`;
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('text-teal-600');
            item.classList.add('text-gray-500');
        });
        const activeNavItem = document.getElementById(navId);
        if (activeNavItem) {
            activeNavItem.classList.remove('text-gray-500');
            activeNavItem.classList.add('text-teal-600');
        }
    };
    window.navigateTo = navigateTo;

    // =================================================================
    // AUTHENTICATION
    // =================================================================

    const authPage = document.getElementById('auth-page');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');

    document.getElementById('show-signup').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('login-form-container').classList.add('hidden');
        document.getElementById('signup-form-container').classList.remove('hidden');
    });

    document.getElementById('show-login').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('signup-form-container').classList.add('hidden');
        document.getElementById('login-form-container').classList.remove('hidden');
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const { error } = await db.auth.signInWithPassword({ email, password });

        if (error) {
            showToast(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}`, 'error');
        } else {
            showToast('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯!', 'success');
            // onAuthStateChange will handle the rest
        }
        hideLoading();
    });

    // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ù…Ù†Ø·Ù‚ Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ Ùˆ Ø«Ø¨Øª ØµØ­ÛŒØ­ Ù†Ù‚Ø´
    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoading();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const fullName = document.getElementById('signup-fullname').value;
        const role = document.getElementById('signup-role').value;

        // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø³Ø±ÙˆÛŒØ³ Auth
        const { data, error } = await db.auth.signUp({
            email,
            password,
            options: {
                data: {
                    // Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙˆØ³Ø· ØªØ±ÛŒÚ¯Ø± Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    full_name: fullName,
                }
            }
        });
        
        if (error) {
            showToast(`Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ${error.message}`, 'error');
            hideLoading();
            return;
        }

        // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯ØŒ Ù†Ù‚Ø´ Ø§Ùˆ Ø±Ø§ Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø«Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        // Ø§ÛŒÙ† Ú©Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø«Ø¨Øª ØµØ­ÛŒØ­ Ù†Ù‚Ø´ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø­ØªÛŒ Ø§Ú¯Ø± ØªØ±ÛŒÚ¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¢Ù† Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ù‡Ø¯
        if (data.user) {
            const { error: profileError } = await db
                .from('profiles')
                .update({ role: role })
                .eq('id', data.user.id);

            if (profileError) {
                console.error("Error updating role after signup:", profileError);
                // Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù„Ø§Ø¹ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ú©Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù†Ù‚Ø´ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡
                showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ØŒ Ø§Ù…Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù†Ù‚Ø´ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯.', 'error');
            } else {
                showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'info');
            }
        } else {
             // Ø­Ø§Ù„ØªÛŒ Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ ÙˆÙ„ÛŒ ØªØ§ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡
             showToast('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯.', 'info');
        }

        hideLoading();
    });

    const handleLogout = async () => {
        showLoading();
        await db.auth.signOut();
        currentUser = null;
        userProfile = null;
        if(chatSubscription) chatSubscription.unsubscribe();
        authPage.classList.add('active');
        appContainer.classList.add('hidden');
        appContainer.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        hideLoading();
    };
    window.handleLogout = handleLogout;

    // =================================================================
    // APP INITIALIZATION & ROUTING
    // =================================================================

    db.auth.onAuthStateChange(async (event, session) => {
        showLoading();
        if (session && session.user) {
            currentUser = session.user;
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±
            const { data, error } = await db
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (data) {
                userProfile = data;
                // Ø§Ú¯Ø± Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†ÙˆØ² Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ (Ù…Ø«Ù„Ø§ Ø¨Ù‡ Ø®Ø§Ø·Ø± ØªØ§Ø®ÛŒØ± ØªØ±ÛŒÚ¯Ø±)ØŒ ÛŒÚ© Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ø± ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                if (!userProfile.role) {
                    console.warn("User role is null, attempting to re-fetch...");
                    // ÛŒÚ© ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ… ØªØ±ÛŒÚ¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ú©Ø§Ø±Ø´ Ø±Ø§ Ú©Ø±Ø¯Ù‡
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    const { data: refreshedProfile, error: refreshError } = await db
                         .from('profiles')
                         .select('*')
                         .eq('id', currentUser.id)
                         .single();
                    if(refreshedProfile) userProfile = refreshedProfile;
                }

                authPage.classList.remove('active');
                appContainer.classList.remove('hidden');
                await setupUIForRole(userProfile.role);
            } else {
                console.error("Profile not found for user.", error);
                showToast('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
                handleLogout();
            }
        } else {
            currentUser = null;
            userProfile = null;
            authPage.classList.add('active');
            appContainer.classList.add('hidden');
        }
        hideLoading();
    });

    const setupUIForRole = async (role) => {
        const navBar = document.getElementById('bottom-nav-bar');
        navBar.innerHTML = ''; // Clear previous navigation

        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ø´ÙˆØ¯ Ú©Ù‡ Ø±ÙˆÙ„ Ù…Ø¹ØªØ¨Ø± Ø§Ø³ØªØŒ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
        if (!['client', 'therapist', 'admin'].includes(role)) {
            showToast(`Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±ÛŒ "${role || 'Ù†Ø§Ù…Ø´Ø®Øµ'}" ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.`, 'error');
            console.error(`Invalid role detected: ${role}`);
            handleLogout();
            return;
        }

        if (role === 'client') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-dashboard-page')">
                        <i data-lucide="home"></i><span class="text-xs">Ø®Ø§Ù†Ù‡</span>
                    </a>
                    <a href="#" id="nav-tests" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-tests-page')">
                        <i data-lucide="file-text"></i><span class="text-xs">ØªØ³Øªâ€ŒÙ‡Ø§</span>
                    </a>
                    <a href="#" id="nav-appointments" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-appointments-page')">
                        <i data-lucide="calendar-days"></i><span class="text-xs">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('client-profile-page')">
                        <i data-lucide="user"></i><span class="text-xs">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
                    </a>
                </div>
            `;
            await renderClientDashboard();
            await renderClientTests();
            await renderClientAppointments();
            await renderClientProfile();
            navigateTo('client-dashboard-page');
        } else if (role === 'therapist') {
            navBar.innerHTML = `
                <div class="flex justify-around items-center h-16">
                    <a href="#" id="nav-dashboard" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-dashboard-page')">
                        <i data-lucide="layout-dashboard"></i><span class="text-xs">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                    </a>
                    <a href="#" id="nav-clients" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-clients-page')">
                        <i data-lucide="users"></i><span class="text-xs">Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</span>
                    </a>
                    <a href="#" id="nav-schedule" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-schedule-page')">
                        <i data-lucide="calendar-clock"></i><span class="text-xs">Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item flex flex-col items-center text-gray-500" onclick="navigateTo('therapist-profile-page')">
                        <i data-lucide="user-cog"></i><span class="text-xs">Ù¾Ø±ÙˆÙØ§ÛŒÙ„</span>
                    </a>
                </div>
            `;
            await renderTherapistDashboard();
            await renderTherapistClients();
            await renderTherapistSchedule();
            await renderTherapistProfile();
            navigateTo('therapist-dashboard-page');
        } else if (role === 'admin') {
            navBar.innerHTML = `<div class="text-center p-4 bg-gray-800 text-white">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</div>`;
            await renderAdminDashboard();
            navigateTo('admin-dashboard-page');
        }
        lucide.createIcons();
    };

    // =================================================================
    // AI HELPER
    // =================================================================
    const getAiSuggestion = async (prompt) => {
        if (!aiFeaturesEnabled) {
            return "Ù‚Ø§Ø¨Ù„ÛŒØª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª.";
        }
        try {
            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });
            if (!response.ok) {
                const errorBody = await response.json().catch(() => null);
                const errorMessage = errorBody?.error?.message || `API request failed with status ${response.status}`;
                throw new Error(errorMessage);
            }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (error) {
            console.error("Gemini API Error:", error);
            if (error instanceof TypeError && error.message === 'Failed to fetch') {
                return "Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ. Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
            }
            return `Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯Ù‡: ${error.message}`;
        }
    };
    
    // =================================================================
    // CLIENT-SIDE RENDERING & LOGIC
    // =================================================================

    // --- CLIENT: DASHBOARD ---
    const renderClientDashboard = async () => {
        const page = document.getElementById('client-dashboard-page');
        // [Ø§ØµÙ„Ø§Ø­ Ø´Ø¯] Ø­Ø°Ù Ú©Ù„Ø§Ø³ main-content
        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Ø³Ù„Ø§Ù…ØŒ ${userProfile.full_name.split(' ')[0]}!</h1>
                        <p class="text-gray-500">Ø­Ø§Ù„Øª Ø§Ù…Ø±ÙˆØ² Ú†Ø·ÙˆØ±Ù‡ØŸ</p>
                    </div>
                    <button onclick="navigateTo('client-profile-page')" class="w-12 h-12 rounded-full bg-teal-500 text-white flex items-center justify-center text-xl font-bold">
                        ${userProfile.full_name.charAt(0)}
                    </button>
                </div>

                <!-- Mental Health Score Card -->
                <div id="health-score-card" class="bg-white p-4 rounded-2xl shadow-md text-center">
                    <p class="text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† Ø´Ù…Ø§...</p>
                </div>

                <!-- Mood Tracker Card -->
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ø«Ø¨Øª Ø­Ø§Ù„ Ø§Ù…Ø±ÙˆØ²</h2>
                    <div class="flex justify-around items-center">
                        ${[
                            { emoji: 'ğŸ˜”', score: 1, label: 'Ø®ÛŒÙ„ÛŒ Ø¨Ø¯' },
                            { emoji: 'ğŸ˜Ÿ', score: 2, label: 'Ø¨Ø¯' },
                            { emoji: 'ğŸ˜', score: 3, label: 'Ù…Ø¹Ù…ÙˆÙ„ÛŒ' },
                            { emoji: 'ğŸ™‚', score: 4, label: 'Ø®ÙˆØ¨' },
                            { emoji: 'ğŸ˜„', score: 5, label: 'Ø¹Ø§Ù„ÛŒ' }
                        ].map(mood => `
                            <button onclick="submitMood(${mood.score})" class="flex flex-col items-center space-y-1 text-gray-600 hover:text-teal-600 transition">
                                <span class="text-4xl">${mood.emoji}</span>
                                <span class="text-xs">${mood.label}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>

                <!-- Mood Chart -->
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ù‡ÙØªÙ‡</h2>
                    <div class="relative h-64">
                        <canvas id="moodChart"></canvas>
                    </div>
                </div>
                
                <!-- AI Helper Card -->
                <div id="ai-helper-card" class="bg-gradient-to-r from-blue-500 to-cyan-400 p-4 rounded-2xl shadow-lg text-white">
                    <h2 class="font-bold text-lg mb-2">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§ÛŒÙ†Ùˆ</h2>
                    <p class="text-sm mb-4">Ù†ÛŒØ§Ø² Ø¨Ù‡ ØµØ­Ø¨Øª Ø¯Ø§Ø±ÛŒØŸ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø§ Ù‡Ù…ÛŒØ´Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù…Ú© Ø¨Ù‡ ØªÙˆØ³Øª.</p>
                    <button onclick="openAiChat()" class="bg-white/30 w-full py-2 rounded-lg font-semibold hover:bg-white/50 transition">Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ</button>
                </div>

                <!-- Journaling Card -->
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-2">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
                    <p class="text-sm text-gray-500 mb-3">Ø§ÙÚ©Ø§Ø±Øª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³. Ø§ÛŒÙ† ÛŒÚ© ÙØ¶Ø§ÛŒ Ú©Ø§Ù…Ù„Ø§ Ø´Ø®ØµÛŒÙ‡.</p>
                    <textarea id="journal-input" class="w-full h-24 p-2 border rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="Ø§Ù…Ø±ÙˆØ² Ú†Ù‡ Ú¯Ø°Ø´Øª..."></textarea>
                    <button onclick="submitJournal()" class="mt-2 w-full bg-teal-500 text-white py-2 rounded-lg font-semibold hover:bg-teal-600 transition">Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</button>
                </div>
            </div>
        `;
        await calculateAndDisplayHealthScore();
        await loadMoodChart();
        lucide.createIcons();
    };
    
    const calculateAndDisplayHealthScore = async () => {
        const scoreCard = document.getElementById('health-score-card');
        if (!scoreCard) return;

        const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', thirtyDaysAgo);

        if (error || !data || data.length === 0) {
            scoreCard.innerHTML = `
                <h2 class="font-bold text-lg mb-1">Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù†</h2>
                <p class="text-gray-500 text-sm">Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯.</p>
            `;
            return;
        }

        const totalScore = data.reduce((acc, entry) => acc + entry.mood_score, 0);
        const averageScore = totalScore / data.length;
        const healthScore = Math.round((averageScore / 5) * 100);

        let scoreDescription = '';
        let scoreColor = '';
        if (healthScore >= 80) {
            scoreDescription = 'Ø¹Ø§Ù„ÛŒ! Ø¨Ù‡ Ù†Ø¸Ø± Ù…ÛŒâ€ŒØ±Ø³Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø®ÙˆØ¨ÛŒ Ø±Ø§ Ø³Ù¾Ø±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.';
            scoreColor = 'text-green-500';
        } else if (healthScore >= 60) {
            scoreDescription = 'Ø®ÙˆØ¨. ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯.';
            scoreColor = 'text-teal-500';
        } else if (healthScore >= 40) {
            scoreDescription = 'Ù…ØªÙˆØ³Ø·. Ù…Ø±Ø§Ù‚Ø¨ Ø®ÙˆØ¯ Ø¨Ø§Ø´ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø§Ø­Ø³Ø§Ø³ØªØ§Ù† ØªÙˆØ¬Ù‡ Ú©Ù†ÛŒØ¯.';
            scoreColor = 'text-yellow-500';
        } else {
            scoreDescription = 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡. ØµØ­Ø¨Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙÛŒØ¯ Ø¨Ø§Ø´Ø¯.';
            scoreColor = 'text-red-500';
        }

        scoreCard.innerHTML = `
            <h2 class="font-bold text-lg mb-2">Ù†Ù…Ø±Ù‡ Ø³Ù„Ø§Ù…Øª Ø±ÙˆØ§Ù† (Û³Û° Ø±ÙˆØ² Ø§Ø®ÛŒØ±)</h2>
            <p class="text-5xl font-bold ${scoreColor}">${healthScore}<span class="text-2xl text-gray-400">/Û±Û°Û°</span></p>
            <p class="text-gray-600 mt-2 text-sm">${scoreDescription}</p>
        `;
    };

    const submitMood = async (score) => {
        showLoading();
        const { error } = await db.from('mood_entries').insert({ user_id: currentUser.id, mood_score: score });
        hideLoading();
        if (error) {
            showToast('Ø§Ù…Ø±ÙˆØ² Ù‚Ø¨Ù„Ø§ Ø­Ø§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.', 'error');
        } else {
            showToast('Ø­Ø§Ù„ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
            await loadMoodChart();
            await calculateAndDisplayHealthScore(); // Recalculate score after new entry
        }
    };
    window.submitMood = submitMood;

    const loadMoodChart = async () => {
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        const { data, error } = await db
            .from('mood_entries')
            .select('created_at, mood_score')
            .eq('user_id', currentUser.id)
            .gte('created_at', sevenDaysAgo)
            .order('created_at', { ascending: true });

        if (error) {
            console.error("Error loading mood data:", error);
            return;
        }

        const labels = data.map(d => new persianDate(new Date(d.created_at)).format('dddd'));
        const scores = data.map(d => d.mood_score);

        const canvasEl = document.getElementById('moodChart');
        if (!canvasEl) return;
        const ctx = canvasEl.getContext('2d');
        
        // Destroy the old chart instance if it exists
        if (moodChartInstance) {
            moodChartInstance.destroy();
        }

        moodChartInstance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ',
                    data: scores,
                    fill: true,
                    backgroundColor: 'rgba(20, 184, 166, 0.2)',
                    borderColor: 'rgb(20, 184, 166)',
                    pointBackgroundColor: 'rgb(20, 184, 166)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(20, 184, 166)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                elements: {
                    line: {
                        borderWidth: 3
                    }
                },
                scales: {
                    r: {
                        angleLines: {
                            display: false
                        },
                        suggestedMin: 0,
                        suggestedMax: 5,
                        pointLabels: {
                            font: {
                                family: "'Vazirmatn', sans-serif",
                                size: 12
                            }
                        },
                        ticks: {
                           stepSize: 1,
                           display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    };

    const submitJournal = async () => {
        const content = document.getElementById('journal-input').value;
        if (!content.trim()) {
            showToast('Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ†ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }
        showLoading();
        const { error } = await db.from('journal_entries').insert({ user_id: currentUser.id, content: content });
        hideLoading();
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª.', 'error');
        } else {
            showToast('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
            document.getElementById('journal-input').value = '';
        }
    };
    window.submitJournal = submitJournal;
    
    const openAiChat = () => {
        const content = `
            <div id="ai-chat-history" class="h-64 overflow-y-auto p-2 bg-gray-100 rounded-lg mb-3 border">
                <div class="text-gray-500 text-center p-4">Ø³Ù„Ø§Ù…! Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³Ø§ÛŒÙ†Ùˆ Ù‡Ø³ØªÙ…. Ú†Ø·ÙˆØ± Ù…ÛŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ</div>
            </div>
            <div class="flex gap-2">
                <input id="ai-chat-input" type="text" class="flex-grow p-2 border rounded-lg" placeholder="Ù¾ÛŒØ§Ù…Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³...">
                <button onclick="sendAiChatMessage()" class="p-2 bg-teal-500 text-white rounded-lg"><i data-lucide="send"></i></button>
            </div>
        `;
        showModal('Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯', content);
        lucide.createIcons();
    };
    window.openAiChat = openAiChat;

    const sendAiChatMessage = async () => {
        const input = document.getElementById('ai-chat-input');
        const history = document.getElementById('ai-chat-history');
        const userMessage = input.value.trim();
        if (!userMessage) return;

        history.innerHTML += `<div class="text-left my-1"><span class="bg-blue-500 text-white p-2 rounded-lg inline-block">${userMessage}</span></div>`;
        input.value = '';
        history.scrollTop = history.scrollHeight;
        
        const thinking = document.createElement('div');
        thinking.className = "text-right my-1";
        thinking.innerHTML = `<span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">...Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†</span>`;
        history.appendChild(thinking);
        history.scrollTop = history.scrollHeight;

        const aiResponse = await getAiSuggestion(userMessage);
        
        thinking.remove();
        history.innerHTML += `<div class="text-right my-1"><span class="bg-gray-200 text-gray-700 p-2 rounded-lg inline-block">${aiResponse}</span></div>`;
        history.scrollTop = history.scrollHeight;
    };
    window.sendAiChatMessage = sendAiChatMessage;

    // --- CLIENT: TESTS ---
    const psychologicalTests = [
        { id: 'phq9', name: 'ØªØ³Øª Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ (PHQ-9)', questions: [
            "Ø¹Ø¯Ù… Ø¹Ù„Ø§Ù‚Ù‡ ÛŒØ§ Ù„Ø°Øª Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ú©Ø§Ø±Ù‡Ø§", "Ø§Ø­Ø³Ø§Ø³ Ù†Ø§Ø±Ø§Ø­ØªÛŒØŒ Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ ÛŒØ§ Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ", "Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¨Ù‡ Ø®ÙˆØ§Ø¨ Ø±ÙØªÙ†ØŒ Ø¯Ø± Ø®ÙˆØ§Ø¨ Ù…Ø§Ù†Ø¯Ù† ÛŒØ§ Ø®ÙˆØ§Ø¨ Ø²ÛŒØ§Ø¯", "Ø§Ø­Ø³Ø§Ø³ Ø®Ø³ØªÚ¯ÛŒ ÛŒØ§ Ú©Ù…Ø¨ÙˆØ¯ Ø§Ù†Ø±Ú˜ÛŒ", "Ú©Ù… Ø§Ø´ØªÙ‡Ø§ÛŒÛŒ ÛŒØ§ Ù¾Ø±Ø®ÙˆØ±ÛŒ", "Ø§Ø­Ø³Ø§Ø³ Ø¨Ø¯ÛŒ Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø®ÙˆØ¯ØŒ ÛŒØ§ Ø§ÛŒÙ†Ú©Ù‡ ÛŒÚ© Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯Ù‡ Ù‡Ø³ØªÛŒØ¯", "Ù…Ø´Ú©Ù„ Ø¯Ø± ØªÙ…Ø±Ú©Ø² Ú©Ø±Ø¯Ù† Ø±ÙˆÛŒ Ú©Ø§Ø±Ù‡Ø§", "Ú©Ù†Ø¯ Ø´Ø¯Ù† Ø¯Ø± Ø­Ø±Ú©Øª ÛŒØ§ ØµØ­Ø¨Øª Ú©Ø±Ø¯Ù†ØŒ ÛŒØ§ Ø¨Ø±Ø¹Ú©Ø³ Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø±ÛŒ", "Ø§ÙÚ©Ø§Ø± Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ù‡ØªØ± Ø§Ø³Øª Ø¨Ù…ÛŒØ±ÛŒØ¯ ÛŒØ§ Ø¨Ù‡ Ø®ÙˆØ¯ Ø¢Ø³ÛŒØ¨ Ø¨Ø²Ù†ÛŒØ¯"
        ], options: ["Ø§ØµÙ„Ø§", "Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ²", "Ø¨ÛŒØ´ Ø§Ø² Ù†ÛŒÙ…ÛŒ Ø§Ø² Ø±ÙˆØ²Ù‡Ø§", "ØªÙ‚Ø±ÛŒØ¨Ø§ Ù‡Ø± Ø±ÙˆØ²"], interpretation: (score) => {
            if (score <= 4) return "Ø¹Ù„Ø§Ø¦Ù… Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø­Ø¯Ø§Ù‚Ù„ÛŒ ÛŒØ§ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¢Ù†. ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§ Ø®ÙˆØ¨ Ø§Ø³Øª.";
            if (score <= 9) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø®ÙÛŒÙ. Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.";
            if (score <= 14) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ù…ØªÙˆØ³Ø·. Ù…Ø´ÙˆØ±Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.";
            if (score <= 19) return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ù†Ø³Ø¨ØªØ§ Ø´Ø¯ÛŒØ¯. Ø­ØªÙ…Ø§ Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ ØµØ­Ø¨Øª Ú©Ù†ÛŒØ¯.";
            return "Ø§ÙØ³Ø±Ø¯Ú¯ÛŒ Ø´Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÙÙˆØ±Ø§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù…Ú© Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†ÛŒØ¯.";
        }},
        { id: 'gad7', name: 'ØªØ³Øª Ø§Ø¶Ø·Ø±Ø§Ø¨ (GAD-7)', questions: [
            "Ø§Ø­Ø³Ø§Ø³ Ø¹ØµØ¨Ø§Ù†ÛŒØªØŒ Ø§Ø¶Ø·Ø±Ø§Ø¨ ÛŒØ§ Ø¯Ù„Ø´ÙˆØ±Ù‡", "Ø¹Ø¯Ù… ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø¯Ø± Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† ÛŒØ§ Ú©Ù†ØªØ±Ù„ Ù†Ú¯Ø±Ø§Ù†ÛŒ", "Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ú†ÛŒØ²Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù", "Ù…Ø´Ú©Ù„ Ø¯Ø± Ø¢Ø±Ø§Ù… Ø´Ø¯Ù†", "Ø¢Ù†Ù‚Ø¯Ø± Ø¨ÛŒâ€ŒÙ‚Ø±Ø§Ø± Ø¨ÙˆØ¯Ù† Ú©Ù‡ Ù†Ø´Ø³ØªÙ† Ø³Ø®Øª Ø§Ø³Øª", "Ø²ÙˆØ¯Ø±Ù†Ø¬ ÛŒØ§ ØªØ­Ø±ÛŒÚ©â€ŒÙ¾Ø°ÛŒØ± Ø´Ø¯Ù†", "Ø§Ø­Ø³Ø§Ø³ ØªØ±Ø³ØŒ Ø§Ù†Ú¯Ø§Ø± Ú©Ù‡ Ø§ØªÙØ§Ù‚ ÙˆØ­Ø´ØªÙ†Ø§Ú©ÛŒ Ù‚Ø±Ø§Ø± Ø§Ø³Øª Ø¨ÛŒÙØªØ¯"
        ], options: ["Ø§ØµÙ„Ø§", "Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ²", "Ø¨ÛŒØ´ Ø§Ø² Ù†ÛŒÙ…ÛŒ Ø§Ø² Ø±ÙˆØ²Ù‡Ø§", "ØªÙ‚Ø±ÛŒØ¨Ø§ Ù‡Ø± Ø±ÙˆØ²"], interpretation: (score) => {
            if (score <= 4) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø­Ø¯Ø§Ù‚Ù„ÛŒ. ÙˆØ¶Ø¹ÛŒØª Ø´Ù…Ø§ Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø³Øª.";
            if (score <= 9) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø®ÙÛŒÙ. Ù…Ø±Ø§Ù‚Ø¨Øª Ø§Ø² Ø®ÙˆØ¯ Ø±Ø§ ÙØ±Ø§Ù…ÙˆØ´ Ù†Ú©Ù†ÛŒØ¯.";
            if (score <= 14) return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…ØªÙˆØ³Ø·. Ù…Ø´ÙˆØ±Øª Ø¨Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…ÙÛŒØ¯ Ø¨Ø§Ø´Ø¯.";
            return "Ø§Ø¶Ø·Ø±Ø§Ø¨ Ø´Ø¯ÛŒØ¯. ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ùˆ Ø¯Ø±Ù…Ø§Ù† Ø¨Ù‡ Ù…ØªØ®ØµØµ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.";
        }}
    ];

    const renderClientTests = async () => {
        const page = document.getElementById('client-tests-page');
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ</h1>
                <div id="test-list" class="space-y-4">
                    ${psychologicalTests.map(test => `
                        <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-lg">${test.name}</h2>
                                <p class="text-sm text-gray-500">${test.questions.length} Ø³ÙˆØ§Ù„</p>
                            </div>
                            <button onclick="startTest('${test.id}')" class="bg-teal-500 text-white px-4 py-2 rounded-lg font-semibold">Ø´Ø±ÙˆØ¹</button>
                        </div>
                    `).join('')}
                </div>
                <div id="test-container" class="hidden mt-6 bg-white p-4 rounded-2xl shadow-md"></div>
            </div>
        `;
        lucide.createIcons();
    };

    const startTest = (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        const testContainer = document.getElementById('test-container');
        document.getElementById('test-list').classList.add('hidden');
        testContainer.classList.remove('hidden');
        
        let questionsHTML = `<h2 class="text-xl font-bold mb-4">${test.name}</h2>`;
        test.questions.forEach((q, index) => {
            questionsHTML += `
                <div class="mb-6">
                    <p class="font-semibold mb-2">${index + 1}. ${q}</p>
                    <div class="flex flex-wrap gap-2">
                        ${test.options.map((opt, optIndex) => `
                            <label class="flex items-center space-x-2 space-x-reverse border p-2 rounded-lg cursor-pointer">
                                <input type="radio" name="q${index}" value="${optIndex}" class="form-radio text-teal-500">
                                <span>${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        questionsHTML += `<button onclick="submitTest('${testId}')" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ØªÛŒØ¬Ù‡</button>`;
        testContainer.innerHTML = questionsHTML;
    };
    window.startTest = startTest;

    const submitTest = async (testId) => {
        const test = psychologicalTests.find(t => t.id === testId);
        let score = 0;
        let answeredAll = true;
        for (let i = 0; i < test.questions.length; i++) {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            if (selected) {
                score += parseInt(selected.value);
            } else {
                answeredAll = false;
                break;
            }
        }

        if (!answeredAll) {
            showToast('Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø³ÙˆØ§Ù„Ø§Øª Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯.', 'error');
            return;
        }

        const resultText = test.interpretation(score);
        showLoading();
        const { error } = await db.from('test_results').insert({
            user_id: currentUser.id,
            test_name: test.name,
            score: score,
            result_text: resultText
        });
        hideLoading();
        if(error){
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª.', 'error');
        } else {
            showToast('Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.', 'success');
        }

        const testContainer = document.getElementById('test-container');
        testContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Ù†ØªÛŒØ¬Ù‡ ØªØ³Øª ${test.name}</h2>
            <p class="text-gray-700 mb-2">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§: <span class="font-bold">${score}</span></p>
            <p class="text-gray-800 bg-gray-100 p-3 rounded-lg">${resultText}</p>
            <button onclick="renderClientTests(); navigateTo('client-tests-page')" class="mt-4 w-full bg-gray-500 text-white py-2 rounded-lg">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ØªØ³Øªâ€ŒÙ‡Ø§</button>
        `;
    };
    window.submitTest = submitTest;

    // --- CLIENT: APPOINTMENTS ---
    const renderClientAppointments = async () => {
        const page = document.getElementById('client-appointments-page');
        showLoading();
        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù† Ùˆ Ø±Ø²Ø±Ùˆ Ø¬Ø¯ÛŒØ¯</h1>
                <div id="appointments-list" class="space-y-4">
                    <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§...</p>
                </div>
                <div class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Ø±Ø²Ø±Ùˆ Ù†ÙˆØ¨Øª Ø¬Ø¯ÛŒØ¯</h2>
                    <div id="therapist-booking-section" class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                         <p class="text-center text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³Ø§Ù†...</p>
                    </div>
                </div>
            </div>
        `;
        await loadClientAppointments();
        await loadTherapistsForBooking();
        hideLoading();
        lucide.createIcons();
    };
    
    const loadClientAppointments = async () => {
        const listEl = document.getElementById('appointments-list');
        const { data, error } = await db
            .from('appointments')
            .select(`
                id,
                appointment_time,
                status,
                therapist:therapist_id ( id, full_name )
            `)
            .eq('client_id', currentUser.id)
            .order('appointment_time', { ascending: false });

        if (error) {
            listEl.innerHTML = `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§.</p>`;
            return;
        }

        if (data.length === 0) {
            listEl.innerHTML = `<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù†ÙˆØ¨Øª Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>`;
            return;
        }

        listEl.innerHTML = data.map(apt => `
            <div class="bg-white p-4 rounded-2xl shadow-md">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-lg">Ø¯Ú©ØªØ± ${apt.therapist.full_name}</p>
                        <p class="text-sm text-gray-600">${new persianDate(new Date(apt.appointment_time)).format('dddd D MMMM YYYY - Ø³Ø§Ø¹Øª HH:mm')}</p>
                    </div>
                    <span class="text-sm font-semibold px-3 py-1 rounded-full ${apt.status === 'booked' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${apt.status === 'booked' ? 'Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡' : apt.status}</span>
                </div>
                <div class="mt-4 flex gap-2">
                    <button onclick="startChatWith('${apt.therapist.id}')" class="flex-1 bg-teal-500 text-white py-2 rounded-lg text-sm">Ø´Ø±ÙˆØ¹ Ú†Øª</button>
                    ${apt.status === 'booked' ? `<button onclick="cancelAppointment(${apt.id})" class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm">Ù„ØºÙˆ Ù†ÙˆØ¨Øª</button>` : ''}
                </div>
            </div>
        `).join('');
    };
    
    const loadTherapistsForBooking = async () => {
        const sectionEl = document.getElementById('therapist-booking-section');
        const { data, error } = await db.from('profiles').select('id, full_name').eq('role', 'therapist');

        if (error) {
            sectionEl.innerHTML = `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³Ø§Ù†.</p>`;
            return;
        }
        
        sectionEl.innerHTML = `
            <div>
                <label for="therapist-select" class="block text-sm font-medium text-gray-700">Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³</label>
                <select id="therapist-select" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                    ${data.map(t => `<option value="${t.id}">Ø¯Ú©ØªØ± ${t.full_name}</option>`).join('')}
                </select>
            </div>
            <div>
                <label for="appointment-date" class="block text-sm font-medium text-gray-700">Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª</label>
                <input type="text" id="appointment-date" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" placeholder="ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯">
            </div>
            <button onclick="bookAppointment()" class="w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Ø±Ø²Ø±Ùˆ Ù†Ù‡Ø§ÛŒÛŒ</button>
        `;
        
        $('#appointment-date').persianDatepicker({
            format: 'YYYY/MM/DD HH:mm',
            timePicker: {
                enabled: true
            },
            minDate: new persianDate()
        });
    };

    const bookAppointment = async () => {
        const therapistId = document.getElementById('therapist-select').value;
        const datePickerVal = $('#appointment-date').val();
        
        if (!datePickerVal) {
            showToast('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
            return;
        }
        
        const appointmentTime = new persianDate.parse(datePickerVal, 'YYYY/MM/DD HH:mm').toDate().toISOString();
        
        showLoading();
        const { error } = await db.from('appointments').insert({
            client_id: currentUser.id,
            therapist_id: therapistId,
            appointment_time: appointmentTime
        });
        hideLoading();

        if (error) {
            showToast('Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ù‚Ø¨Ù„Ø§ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø²Ù…Ø§Ù† Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 'error');
            console.error(error);
        } else {
            showToast('Ù†ÙˆØ¨Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø±Ø²Ø±Ùˆ Ø´Ø¯.', 'success');
            await renderClientAppointments();
        }
    };
    window.bookAppointment = bookAppointment;
    
    const cancelAppointment = async (id) => {
        showLoading();
        const { error } = await db.from('appointments').update({ status: 'cancelled' }).eq('id', id);
        hideLoading();
        if(error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù†ÙˆØ¨Øª.', 'error');
        } else {
            showToast('Ù†ÙˆØ¨Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯.', 'success');
            await loadClientAppointments();
        }
    };
    window.cancelAppointment = cancelAppointment;

    // --- CLIENT: PROFILE ---
    const renderClientProfile = async () => {
        const page = document.getElementById('client-profile-page');
        page.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col items-center space-y-2">
                    <div class="w-24 h-24 rounded-full bg-teal-500 text-white flex items-center justify-center text-4xl font-bold">
                        ${userProfile.full_name.charAt(0)}
                    </div>
                    <h1 class="text-2xl font-bold">${userProfile.full_name}</h1>
                    <p class="text-gray-500">${userProfile.email}</p>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                    <h2 class="text-lg font-bold">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø³Ø§Ø¨</h2>
                    <div class="flex justify-between items-center">
                        <label for="fullname-input">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</label>
                        <input id="fullname-input" type="text" class="border-b-2 text-left" value="${userProfile.full_name}">
                    </div>
                     <button onclick="updateProfile()" class="w-full bg-teal-500 text-white py-2 rounded-lg font-semibold">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                    <h2 class="text-lg font-bold">Ø³Ø§ÛŒØ± Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h2>
                    <button class="w-full text-left p-2 hover:bg-gray-100 rounded-lg">Ø³ÙˆØ§Ø¨Ù‚ ØªØ³Øªâ€ŒÙ‡Ø§</button>
                    <button class="w-full text-left p-2 hover:bg-gray-100 rounded-lg">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
                    <button class="w-full text-left p-2 hover:bg-gray-100 rounded-lg">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</button>
                </div>

                <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
            </div>
        `;
        lucide.createIcons();
    };
    
    const updateProfile = async () => {
        const newName = document.getElementById('fullname-input').value;
        if (newName === userProfile.full_name) return;
        
        showLoading();
        const { error } = await db.from('profiles').update({ full_name: newName }).eq('id', currentUser.id);
        hideLoading();
        
        if (error) {
            showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„.', 'error');
        } else {
            userProfile.full_name = newName;
            showToast('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯.', 'success');
            await renderClientProfile(); // Re-render to show changes
        }
    };
    window.updateProfile = updateProfile;

    // =================================================================
    // THERAPIST-SIDE RENDERING & LOGIC
    // =================================================================

    // --- THERAPIST: DASHBOARD ---
    const renderTherapistDashboard = async () => {
        const page = document.getElementById('therapist-dashboard-page');
        showLoading();
        const { data: appointments, error: aptError } = await db
            .from('appointments')
            .select('id, appointment_time, client:client_id(id, full_name)')
            .eq('therapist_id', currentUser.id)
            .eq('status', 'booked')
            .order('appointment_time', { ascending: true })
            .limit(5);

        const { count: clientCount, error: clientError } = await db
            .from('appointments')
            .select('client_id', { count: 'exact', head: true })
            .eq('therapist_id', currentUser.id);
            
        hideLoading();

        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ú©ØªØ± ${userProfile.full_name.split(' ')[1] || userProfile.full_name}</h1>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-teal-600">${appointments?.length || 0}</p>
                        <p class="text-gray-500">Ù†ÙˆØ¨Øª Ø¢ÛŒÙ†Ø¯Ù‡</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-md text-center">
                        <p class="text-3xl font-bold text-blue-600">${clientCount || 0}</p>
                        <p class="text-gray-500">ØªØ¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-3">Ù†ÙˆØ¨Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´ Ø±Ùˆ</h2>
                    <div class="space-y-3">
                        ${aptError ? '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>' : ''}
                        ${appointments && appointments.length > 0 ? appointments.map(apt => `
                            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                                <div>
                                    <p class="font-semibold">${apt.client.full_name}</p>
                                    <p class="text-sm text-gray-500">${new persianDate(new Date(apt.appointment_time)).format('dddd D MMMM - HH:mm')}</p>
                                </div>
                                <button onclick="startChatWith('${apt.client.id}')" class="text-teal-600"><i data-lucide="message-square"></i></button>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500">Ù†ÙˆØ¨Øª Ù†Ø²Ø¯ÛŒÚ©ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>'}
                    </div>
                </div>
            </div>
        `;
        lucide.createIcons();
    };

    // --- THERAPIST: CLIENTS ---
    const renderTherapistClients = async () => {
        const page = document.getElementById('therapist-clients-page');
        showLoading();
        // This query should find all unique clients who have booked an appointment with this therapist
        const { data: clientAppointments, error } = await db
            .from('appointments')
            .select('client:client_id (id, full_name, email)')
            .eq('therapist_id', currentUser.id);
        
        hideLoading();

        let clients = [];
        if (clientAppointments) {
            const clientMap = new Map();
            clientAppointments.forEach(apt => {
                if (apt.client) {
                    clientMap.set(apt.client.id, apt.client);
                }
            });
            clients = Array.from(clientMap.values());
        }

        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ù„ÛŒØ³Øª Ù…Ø±Ø§Ø¬Ø¹ÛŒÙ†</h1>
                <div id="client-list-container" class="space-y-3">
                    ${error ? '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>' : ''}
                    ${clients && clients.length > 0 ? clients.map(client => `
                        <div class="bg-white p-4 rounded-2xl shadow-md flex justify-between items-center">
                            <div>
                                <p class="font-bold">${client.full_name}</p>
                                <p class="text-sm text-gray-500">${client.email}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="viewClientDetails('${client.id}')" class="p-2 bg-gray-100 rounded-lg text-gray-600"><i data-lucide="eye"></i></button>
                                <button onclick="startChatWith('${client.id}')" class="p-2 bg-teal-100 rounded-lg text-teal-600"><i data-lucide="message-square"></i></button>
                            </div>
                        </div>
                    `).join('') : '<p class="text-center text-gray-500">Ø´Ù…Ø§ Ù‡ÛŒÚ† Ù…Ø±Ø§Ø¬Ø¹Ù‡â€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯.</p>'}
                </div>
            </div>
        `;
        lucide.createIcons();
    };

    const viewClientDetails = async (clientId) => {
        showLoading();
        const { data: profile, error: pError } = await db.from('profiles').select('full_name').eq('id', clientId).single();
        const { data: moods, error: mError } = await db.from('mood_entries').select('mood_score, created_at').eq('user_id', clientId).order('created_at', {ascending: false}).limit(7);
        const { data: tests, error: tError } = await db.from('test_results').select('*').eq('user_id', clientId).order('created_at', {ascending: false}).limit(5);
        hideLoading();

        let content = `<div class="space-y-4">`;
        
        if (pError) {
            content += `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø±Ø§Ø¬Ø¹.</p>`;
        } else {
            content += `
                <div>
                    <h4 class="font-bold text-md mb-2">Ù†Ù…ÙˆØ¯Ø§Ø± ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ø§Ø®ÛŒØ±</h4>
                    ${mError ? '<p class="text-red-500">Ø®Ø·Ø§</p>' : moods.length > 0 ? `<canvas id="clientMoodChart"></canvas>` : '<p>Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>'}
                </div>
                <div>
                    <h4 class="font-bold text-md mb-2">Ø¢Ø®Ø±ÛŒÙ† Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§</h4>
                    ${tError ? '<p class="text-red-500">Ø®Ø·Ø§</p>' : tests.length > 0 ? `
                        <ul class="list-disc pr-5 space-y-2 text-sm">
                            ${tests.map(t => `<li><strong>${t.test_name}:</strong> ${t.result_text} (Ø§Ù…ØªÛŒØ§Ø²: ${t.score})</li>`).join('')}
                        </ul>
                    ` : '<p>Ù†ØªÛŒØ¬Ù‡ ØªØ³ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                </div>
            `;
        }
        content += `</div>`;

        showModal(`Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø±Ø§Ø¬Ø¹: ${profile?.full_name || ''}`, content);
        
        if(moods && moods.length > 0) {
            const labels = moods.map(d => new persianDate(new Date(d.created_at)).format('D MMM')).reverse();
            const scores = moods.map(d => d.mood_score).reverse();
            const ctx = document.getElementById('clientMoodChart').getContext('2d');
            
            if (clientMoodChartInstance) {
                clientMoodChartInstance.destroy();
            }

            clientMoodChartInstance = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Ù†Ù…Ø±Ù‡ Ø­Ø§Ù„', 
                        data: scores, 
                        backgroundColor: 'rgba(20, 184, 166, 0.5)',
                        borderColor: 'rgb(20, 184, 166)',
                        borderWidth: 1,
                        borderRadius: 8,
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    scales: { y: { beginAtZero: true, max: 5 } },
                    plugins: { legend: { display: false } }
                } 
            });
        }
    };
    window.viewClientDetails = viewClientDetails;

    // --- THERAPIST: SCHEDULE ---
    const renderTherapistSchedule = async () => {
        const page = document.getElementById('therapist-schedule-page');
        showLoading();
        const { data, error } = await db
            .from('appointments')
            .select('id, appointment_time, status, client:client_id(full_name)')
            .eq('therapist_id', currentUser.id)
            .order('appointment_time', { ascending: true });
        hideLoading();

        page.innerHTML = `
            <div>
                <h1 class="text-2xl font-bold text-gray-800 mb-6">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ø§Ø±ÛŒ Ø´Ù…Ø§</h1>
                <div class="space-y-4">
                    ${error ? '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>' : ''}
                    ${data && data.length > 0 ? data.map(apt => `
                        <div class="bg-white p-4 rounded-2xl shadow-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg">${apt.client.full_name}</p>
                                    <p class="text-sm text-gray-600">${new persianDate(new Date(apt.appointment_time)).format('dddd D MMMM YYYY - Ø³Ø§Ø¹Øª HH:mm')}</p>
                                </div>
                                <span class="text-sm font-semibold px-3 py-1 rounded-full ${apt.status === 'booked' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${apt.status}</span>
                            </div>
                        </div>
                    `).join('') : '<p class="text-center text-gray-500">Ù‡ÛŒÚ† Ù†ÙˆØ¨ØªÛŒ Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>'}
                </div>
            </div>
        `;
    };

    // --- THERAPIST: PROFILE ---
    const renderTherapistProfile = async () => {
        const page = document.getElementById('therapist-profile-page');
         page.innerHTML = `
            <div class="space-y-6">
                <div class="flex flex-col items-center space-y-2">
                    <div class="w-24 h-24 rounded-full bg-blue-500 text-white flex items-center justify-center text-4xl font-bold">
                        ${userProfile.full_name.charAt(0)}
                    </div>
                    <h1 class="text-2xl font-bold">Ø¯Ú©ØªØ± ${userProfile.full_name}</h1>
                    <p class="text-gray-500">${userProfile.email}</p>
                </div>
                
                <div class="bg-white p-4 rounded-2xl shadow-md space-y-4">
                    <h2 class="text-lg font-bold">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
                    <p>Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ Ùˆ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯ (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯).</p>
                </div>

                <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
            </div>
        `;
        lucide.createIcons();
    };

    // =================================================================
    // SHARED: CHAT PAGE
    // =================================================================
    const startChatWith = async (otherUserId) => {
        const page = document.getElementById('chat-page');
        const { data: otherUser, error } = await db.from('profiles').select('id, full_name').eq('id', otherUserId).single();
        if (error) {
            showToast('Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error');
            return;
        }

        page.innerHTML = `
            <header class="bg-white shadow-sm p-4 flex items-center gap-4 fixed top-0 right-0 left-0 z-10">
                <button onclick="goBackFromChat()" class="text-gray-600"><i data-lucide="arrow-right"></i></button>
                <h1 class="font-bold text-lg">${otherUser.full_name}</h1>
            </header>
            <div id="chat-messages" class="flex-grow pt-20 pb-20 space-y-4">
                <!-- Messages will be loaded here -->
            </div>
            <footer class="bg-white p-2 flex items-center gap-2 fixed bottom-0 right-0 left-0 border-t">
                <input id="chat-input" type="text" class="flex-grow bg-gray-100 rounded-full py-2 px-4 focus:outline-none" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
                <button id="send-chat-btn" class="bg-teal-500 text-white w-10 h-10 rounded-full flex items-center justify-center">
                    <i data-lucide="send"></i>
                </button>
            </footer>
        `;
        lucide.createIcons();
        // Ø¨Ø±Ø§ÛŒ ØµÙØ­Ù‡ Ú†ØªØŒ Ù¾Ø¯ÛŒÙ†Ú¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø¨ØªÙˆØ§Ù†ÛŒÙ… Ù‡Ø¯Ø± Ùˆ ÙÙˆØªØ± Ø«Ø§Ø¨Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…
        page.style.padding = '0';
        navigateTo('chat-page');

        const messageContainer = document.getElementById('chat-messages');
        const sendBtn = document.getElementById('send-chat-btn');
        const chatInput = document.getElementById('chat-input');
        
        const loadMessages = async () => {
            const { data: messages, error } = await db.from('chat_messages')
                .select('*')
                .in('sender_id', [currentUser.id, otherUserId])
                .in('receiver_id', [currentUser.id, otherUserId])
                .order('created_at', { ascending: true });
            
            if(messages) {
                messageContainer.innerHTML = messages.map(msg => `
                    <div class="flex px-4 ${msg.sender_id === currentUser.id ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${msg.sender_id === currentUser.id ? 'bg-teal-500 text-white' : 'bg-gray-200 text-gray-800'}">
                            ${msg.message_text}
                        </div>
                    </div>
                `).join('');
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }
        };

        await loadMessages();

        const handleSendMessage = async () => {
             const messageText = chatInput.value.trim();
            if (!messageText) return;
            
            chatInput.value = '';
            await db.from('chat_messages').insert({
                sender_id: currentUser.id,
                receiver_id: otherUserId,
                message_text: messageText
            });
        };

        sendBtn.onclick = handleSendMessage;
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        if (chatSubscription) {
            chatSubscription.unsubscribe();
        }

        chatSubscription = db.channel('public:chat_messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_messages' }, 
            (payload) => {
                const newMessage = payload.new;
                if ((newMessage.sender_id === currentUser.id && newMessage.receiver_id === otherUserId) || 
                    (newMessage.sender_id === otherUserId && newMessage.receiver_id === currentUser.id)) {
                    messageContainer.innerHTML += `
                        <div class="flex px-4 ${newMessage.sender_id === currentUser.id ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${newMessage.sender_id === currentUser.id ? 'bg-teal-500 text-white' : 'bg-gray-200 text-gray-800'}">
                                ${newMessage.message_text}
                            </div>
                        </div>
                    `;
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                }
            })
            .subscribe();
    };
    window.startChatWith = startChatWith;

    const goBackFromChat = () => {
        if (chatSubscription) {
            chatSubscription.unsubscribe();
            chatSubscription = null;
        }
        // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù¾Ø¯ÛŒÙ†Ú¯ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ØµÙØ­Ø§Øª Ø¯ÛŒÚ¯Ø±
        document.querySelectorAll('.page').forEach(p => p.style.padding = '');

        // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø±
        if (userProfile.role === 'client') {
            navigateTo('client-appointments-page');
        } else {
            navigateTo('therapist-clients-page');
        }
    };
    window.goBackFromChat = goBackFromChat;


    // =================================================================
    // ADMIN-SIDE RENDERING & LOGIC
    // =================================================================
    const renderAdminDashboard = async () => {
        const page = document.getElementById('admin-dashboard-page');
        page.innerHTML = `
            <div class="space-y-6">
                <h1 class="text-2xl font-bold text-gray-800">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§ÛŒÙ†Ùˆ</h1>
                
                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h2>
                    <div class="flex justify-between items-center">
                        <span>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Gemini)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <input type="checkbox" id="ai-toggle" class="sr-only peer" ${aiFeaturesEnabled ? 'checked' : ''}>
                          <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-teal-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                        </label>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-md">
                    <h2 class="font-bold text-lg mb-4">Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>
                    <div id="admin-user-list" class="space-y-2">
                        <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
                    </div>
                </div>
                 <button onclick="handleLogout()" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition">Ø®Ø±ÙˆØ¬</button>
            </div>
        `;
        
        document.getElementById('ai-toggle').addEventListener('change', (e) => {
            aiFeaturesEnabled = e.target.checked;
            showToast(`ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ${aiFeaturesEnabled ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'} Ø´Ø¯.`, 'info');
            // In a real app, this value should be persisted in the database.
        });

        await loadAllUsersForAdmin();
        lucide.createIcons();
    };
    
    const loadAllUsersForAdmin = async () => {
        const listEl = document.getElementById('admin-user-list');
        const { data, error } = await db.from('profiles').select('*');
        if(error) {
            listEl.innerHTML = '<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.</p>';
            return;
        }
        listEl.innerHTML = data.map(user => `
            <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                <div>
                    <p class="font-semibold">${user.full_name}</p>
                    <p class="text-sm text-gray-500">${user.email}</p>
                </div>
                <span class="text-sm font-semibold px-3 py-1 rounded-full ${user.role === 'client' ? 'bg-green-100 text-green-800' : (user.role === 'therapist' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800')}">${user.role}</span>
            </div>
        `).join('');
    };


    // Initial Load
    // showLoading(); // onAuthStateChange will handle loading
</script>
</body>
</html>
